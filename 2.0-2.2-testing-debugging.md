

# TESTING GUIDE

## **Testing Strategy**

### **Phase 1: Backend API Testing**

Test 1: Database Schema

* Connect to Supabase dashboard  
* Verify new tables exist: style\_capsule\_libraries, style\_capsules, style\_capsule\_applications  
* Check that projects table has new columns: writing\_style\_capsule\_id, visual\_style\_capsule\_id  
* Verify preset capsules were seeded

Test 2: API EndpointsUse tools like Postman, Insomnia, or browser dev tools:

*\# Test capsule listing*

GET /api/style-capsules

*\# Test capsule creation*

POST /api/style-capsules

{

  "name": "Test Writing Style",

  "type": "writing", 

  "libraryId": "user-library-id",

  "exampleTextExcerpts": \["Sample text..."\],

  "styleLabels": \["concise", "direct"\]

}

*\# Test library operations*

GET /api/style-capsules/libraries/all

POST /api/style-capsules/libraries

### **Phase 2: Frontend Component Testing**

Test 3: Navigation

* Open app and verify "Style Capsule Library" appears in sidebar  
* Click it \- should navigate to /style-capsules route  
* Check that old RAG routes are gone

Test 4: Library Page

* Should show tabs for "Writing Styles" and "Visual Styles"  
* Should display preset capsules (4 writing \+ 4 visual)  
* Test search/filter functionality  
* Test "Create Capsule" dropdown

Test 5: Capsule Creation

* Click "Create Writing Style" → should open modal editor  
* Fill out form with minimal data  
* Test "Show Preview" button  
* Save → should appear in library

Test 6: Visual Style Creation

* Create visual style capsule  
* Test design pillar dropdowns  
* Test image upload (may fail without real Nano Banana API)  
* Save → should appear in library

### **Phase 3: Integration Testing**

Test 7: Stage 1 Integration

* Create new project  
* In Stage 1, verify "Writing Style (Optional)" section appears  
* Select a writing style capsule  
* Complete Stage 1

Test 8: Prompt Injection Testing

* Check browser network tab during Stage 2-4 generation  
* Verify that requests include writing style context  
* Check console logs for style injection

Test 9: Stage 5 Integration

* Complete Stages 1-4 to reach Stage 5  
* Verify "Visual Style Capsule" selector replaces old style buttons  
* Select a visual style capsule  
* Test "Generate Image Key" buttons (will use mock for now)

### **Phase 4: End-to-End Flow**

Test 10: Complete Project Creation

1. Create project with writing style selected  
1. Generate treatment, beat sheet, script (should use writing style)  
1. In Stage 5, select visual style and generate asset images  
1. Verify all stages complete successfully

## **Expected Behaviors**

### **Success Indicators:**

* ✅ Preset capsules appear immediately after seeding  
* ✅ Capsule creation works without errors  
* ✅ Style selectors show capsule options  
* ✅ Form validation prevents invalid submissions  
* ✅ Search/filter works across capsule types  
* ✅ Stage integration doesn't break existing flow

### **Known Limitations (For Now):**

* ⚠️ Image generation uses mock responses (no real Nano Banana API)  
* ⚠️ Storage bucket policies need manual SQL execution  
* ⚠️ No real video generation integration yet

## **Troubleshooting**

If presets don't appear:

* Check database seeding completed successfully  
* Verify RLS policies allow access to preset capsules

If API calls fail:

* Check backend logs for authentication errors  
* Verify Supabase connection and API keys

If UI components don't load:

* Check browser console for import errors  
* Verify TypeScript compilation succeeded

If Stage 1 breaks:

* Check that Stage1InputMode component imports are correct  
* Verify project types include new fields

## **Testing Priority Order**

1. High Priority: Database setup and basic API functionality  
1. High Priority: UI navigation and component rendering  
1. Medium Priority: Capsule creation and editing workflows  
1. Medium Priority: Stage integration (1 and 5\)  
1. Low Priority: End-to-end project creation (requires all stages working)

Start with database/API testing first \- if that fails, the UI won't work properly. The system is designed to be testable incrementally, so you can validate each layer before moving to the next.

----------------------------------------------------------------------------------------------------

# **Debug Session 1**:

## **Summary**

I've successfully fixed the bug that was preventing Stage 2 treatment generation. Here's what the issue was and how it was resolved:

### **Root Cause**

The backend prompt templates still referenced the old RAG system variable rag\_retrieved\_style\_examples, but the frontend was updated to send the new Style Capsule variable writing\_style\_context. This mismatch caused the LLM API to reject the requests.

### **Files Updated**

Backend Files:

1. backend/scripts/seed-templates.ts \- Updated all 3 template definitions  
1. backend/src/routes/seed.ts \- Updated all 3 template definitions  
1. backend/scripts/update-templates-style-capsule.ts \- New script created to update existing DB templates

Frontend Files:

1. src/lib/services/treatmentService.ts \- Added style capsule injection in regenerateTreatments()  
1. src/lib/services/beatService.ts \- Added style capsule injection in regenerateBeats() \+ updated interface  
1. src/lib/services/scriptService.ts \- Added style capsule injection in regenerateScript() \+ updated interface  
1. src/lib/services/inputProcessingService.ts \- Added writingStyleCapsuleId to ProcessedInput interface

### **Changes Made**

Variable Name Migration:

* Changed {rag\_retrieved\_style\_examples} → {writing\_style\_context} in all prompt templates

TypeScript Interfaces Updated:

* ProcessedInput.projectParams now includes writingStyleCapsuleId?: string  
* GenerateBeatsRequest.projectParams now includes writingStyleCapsuleId?: string  
* GenerateScriptRequest.projectParams now includes writingStyleCapsuleId?: string

Style Capsule Injection Added:All regeneration methods now fetch and inject the writing style capsule context:

let writingStyleContext \= '';

if (request.projectParams.writingStyleCapsuleId) {

  const capsule \= await styleCapsuleService.getCapsule(...);

  writingStyleContext \= styleCapsuleService.formatWritingStyleInjection(capsule);

}

### **Database Updates**

Executed the update script that successfully updated all 3 prompt templates in the database:

* ✅ treatment\_expansion  
* ✅ beat\_extraction  
* ✅ master\_script\_generation

### **Next Steps**

The fix is complete\! You should now be able to:

1. Restart your backend server (if it's running)  
1. Test Stage 2 treatment generation in the frontend  
1. The error should be resolved and treatments should generate successfully

The system is now fully aligned to use the Style Capsule system instead of the old RAG approach.

----------------------------------------------------------------------------------------------------