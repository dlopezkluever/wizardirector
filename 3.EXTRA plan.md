# Stage 5 Global Asset Enhancement Plan

## Overview

This plan enhances the global asset system to support image upload/generation and adds a matching workflow in Stage 5 that allows users to merge global assets with extracted project assets, with flexible description merging and optional image regeneration.

## Architecture Changes

### 1. Global Asset Image Support

**Backend:**

- Add image upload endpoint for global assets (`POST /api/assets/:id/upload-image`)
- Add image generation endpoint for global assets (`POST /api/assets/:id/generate-image`)
- Update global asset creation/update to validate: at least one of `image_key_url` OR `description` required
- Store global asset images in `asset-images/global/{userId}/{assetId}/` path

**Frontend:**

- Enhance `AssetDialog.tsx` to include:
  - Image upload component (drag-and-drop or file picker)
  - "Generate Image" button (uses Nano Banana API)
  - Image preview with ability to remove/replace
  - Validation: require image OR description (image recommended)

### 2. Asset Matching Modal

**New Component:** `src/components/pipeline/AssetMatchModal.tsx`

**Features:**

- Shows selected global asset details (name, image, description)
- Lists all extracted project assets (grouped by type)
- Drag-and-drop interface: drag global asset onto extracted asset to match
- "Clone Without Matching" option (existing behavior)
- Description merge options:
  - "Use Global Asset" (completely replace extracted)
  - "Use Project Asset" (keep extracted, ignore global)
  - "Merge Descriptions" (global as base + project additions)
- Image regeneration toggle:
  - "Keep Global Image" (use as-is)
  - "Regenerate with Merged Description" (use global image as seed/reference)

**Props:**

```typescript
interface AssetMatchModalProps {
  globalAsset: GlobalAsset;
  projectAssets: ProjectAsset[];
  projectId: string;
  isOpen: boolean;
  onClose: () => void;
  onMatched: (matchResult: AssetMatchResult) => void;
  onClonedWithoutMatch: (asset: ProjectAsset) => void;
}
```

### 3. Enhanced Clone Endpoint

**Backend:** `POST /api/projects/:projectId/assets/clone-from-global`

**New Request Body Options:**

```typescript
{
  globalAssetId: string;
  matchWithAssetId?: string; // Optional: ID of extracted asset to match/replace
  descriptionStrategy?: 'global' | 'project' | 'merge';
  regenerateImage?: boolean; // If true, regenerate using merged description
  overrideDescription?: string; // Manual override (existing)
}
```

**Logic:**

- If `matchWithAssetId` provided:
  - Replace/update the extracted asset instead of creating new one
  - Merge descriptions based on `descriptionStrategy`
  - If `regenerateImage` is true: use global image as reference, generate new image with merged description
  - If `regenerateImage` is false: use global image as-is (localized)
- If `matchWithAssetId` not provided:
  - Clone as new asset (existing behavior)

### 4. Description Merging Service

**New Service:** `backend/src/services/assetDescriptionMerger.ts`

**Function:**

```typescript
mergeDescriptions(
  globalDescription: string,
  projectDescription: string,
  strategy: 'global' | 'project' | 'merge'
): string
```

**Strategies:**

- `'global'`: Return global description as-is
- `'project'`: Return project description as-is
- `'merge'`: Use LLM to intelligently combine: "Global description as base, project description as additions/modifications"

To be clear the ideal strategy for Description merging is the following scenario:
   - Global description as base, project description as additions/modifications (e.g., "Bob the builder" + "in space" → "Bob the builder, now in space")
   
NOT just a LLM-merged synthesis of both descriptions and ESPECIALLY NOT: {{{ Project description as base, global description as context (e.g., "Bob in space" + "builder" → "Bob in space, a builder")}}}


### 5. Image Regeneration with Reference

**Backend:** Update `ImageGenerationService` to support reference images

**Enhancement:**

- Add `referenceImageUrl` parameter to image generation requests
- Pass reference image to Nano Banana API (if supported) or use in prompt
- For merged assets: use global asset's image as reference, merged description as prompt

### 6. Asset Drawer Enhancement

**File:** `src/components/pipeline/AssetDrawer.tsx`

**Changes:**

- Update `handleCloneAsset` to:

  1. Check if there are extracted assets in the project
  2. If yes: open `AssetMatchModal` instead of directly cloning
  3. If no: clone directly (existing behavior)

- Pass extracted assets list to modal

## Implementation Tasks

### Task 1: Global Asset Image Upload

- [ ] Add `POST /api/assets/:id/upload-image` endpoint
- [ ] Add image upload UI to `AssetDialog.tsx`
- [ ] Add validation: require image OR description
- [ ] Update global asset creation/update validation

### Task 2: Global Asset Image Generation

- [ ] Add `POST /api/assets/:id/generate-image` endpoint
- [ ] Add "Generate Image" button to `AssetDialog.tsx`
- [ ] Integrate with Nano Banana API for global assets
- [ ] Store generated images in global asset storage path

### Task 3: Asset Match Modal Component

- [ ] Create `AssetMatchModal.tsx` component
- [ ] Implement drag-and-drop OR dropdown matching interface
- [ ] Add description strategy selection (global/project/merge)
- [ ] Add image regeneration toggle
- [ ] Style with shadcn/ui components

### Task 4: Description Merging Service

- [ ] Create `assetDescriptionMerger.ts` service
- [ ] Implement LLM-based merging for 'merge' strategy
- [ ] Add fallback for simple concatenation if LLM fails

### Task 5: Enhanced Clone Endpoint

- [ ] Update `clone-from-global` endpoint to support matching
- [ ] Implement asset replacement logic (update extracted asset instead of creating new)
- [ ] Add description merging based on strategy
- [ ] Add conditional image regeneration

### Task 6: Image Regeneration with Reference

- [ ] Update `ImageGenerationService` to accept reference images
- [ ] Pass reference image to Nano Banana API
- [ ] Update image generation calls for merged assets

### Task 7: Asset Drawer Integration

- [ ] Update `AssetDrawer` to open match modal when cloning
- [ ] Fetch extracted assets for current project
- [ ] Handle both matched and unmatched clone flows

### Task 8: Stage 5 Integration

- [ ] Ensure extracted assets are available for matching
- [ ] Update asset list refresh after matching
- [ ] Add visual indicators for matched assets

## Database Changes

No schema changes required. Existing fields support this workflow:

- `project_assets.global_asset_id` - tracks source
- `project_assets.description` - can be merged/overridden
- `project_assets.image_key_url` - can be regenerated
- `project_assets.overridden_fields` - tracks manual edits

## User Flow

1. **Global Asset Creation:**

   - User creates global asset with description
   - User uploads image OR generates image
   - Asset saved (image OR description required)

2. **Stage 5 Asset Matching:**

   - User extracts assets from script (existing)
   - User opens Asset Drawer, selects global asset
   - Modal opens showing:
     - Global asset details
     - List of extracted assets
   - User drags global asset onto extracted asset to match
   - User selects:
     - Description strategy (global/project/merge)
     - Image regeneration (keep/regenerate)
   - System:
     - Replaces extracted asset with global asset data
     - Merges descriptions based on strategy
     - Regenerates image if requested (using global image as reference)
   - Asset appears in Stage 5 list with merged data

3. **Clone Without Matching:**

   - User can choose "Clone Without Matching" in modal
   - Asset clones as new asset (existing behavior)

## Files to Modify

**Backend:**

- `backend/src/routes/assets.ts` - Add image upload/generation endpoints
- `backend/src/routes/projectAssets.ts` - Enhance clone endpoint
- `backend/src/services/assetDescriptionMerger.ts` - New service
- `backend/src/services/image-generation/ImageGenerationService.ts` - Add reference image support

**Frontend:**

- `src/components/assets/AssetDialog.tsx` - Add image upload/generation
- `src/components/pipeline/AssetDrawer.tsx` - Add match modal integration
- `src/components/pipeline/AssetMatchModal.tsx` - New component
- `src/lib/services/assetService.ts` - Add image upload/generation methods
- `src/lib/services/projectAssetService.ts` - Update clone method

## Testing Considerations

- Test global asset creation with image upload
- Test global asset creation with image generation
- Test global asset creation with description only (no image)
- Test asset matching workflow (drag-and-drop)
- Test description merging strategies
- Test image regeneration with reference
- Test clone without matching (existing behavior)
- Test validation: image OR description required