Style Capsule System Implementation
Architecture Overview
flowchart TB
    User[User]
    GlobalSidebar[Global Sidebar]
    StyleLibrary[Style Capsule Library Page]
    WritingTab[Writing Styles Tab]
    VisualTab[Visual Styles Tab]
    
    DB[(Database)]
    Storage[Supabase Storage]
    
    Stage1[Stage 1: Project Setup]
    Stage2_4[Stages 2-4: Text Generation]
    Stage5[Stage 5: Asset Definition]
    
    User --> GlobalSidebar
    GlobalSidebar --> StyleLibrary
    StyleLibrary --> WritingTab
    StyleLibrary --> VisualTab
    
    WritingTab --> DB
    VisualTab --> DB
    VisualTab --> Storage
    
    Stage1 --> WritingTab
    Stage2_4 --> DB
    Stage5 --> VisualTab
    
    DB -->|Inject Style| Stage2_4
    DB -->|Inject Style| Stage5
Feature 2.0: Database Migration
Migration File: backend/migrations/004_style_capsule_system.sql
Create comprehensive migration that:

Drop RAG references from projects table:
Remove written_style_rag_id column
Remove visual_style_rag_id column
Create style_capsule_libraries table:
CREATE TABLE style_capsule_libraries (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
    name TEXT NOT NULL,
    description TEXT,
    is_preset BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
Create style_capsules table:
CREATE TABLE style_capsules (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    library_id UUID REFERENCES style_capsule_libraries(id) ON DELETE CASCADE,
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
    
    name TEXT NOT NULL,
    type TEXT NOT NULL CHECK (type IN ('writing', 'visual')),
    
    -- Writing Style Fields
    example_text_excerpts TEXT[],
    style_labels TEXT[],
    negative_constraints TEXT[],
    freeform_notes TEXT,
    
    -- Visual Style Fields
    design_pillars JSONB,
    reference_image_urls TEXT[],
    descriptor_strings TEXT,
    
    -- Metadata
    is_preset BOOLEAN DEFAULT FALSE,
    is_favorite BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    
    UNIQUE(library_id, name)
);
Create style_capsule_applications table (audit logging):
CREATE TABLE style_capsule_applications (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    stage_state_id UUID REFERENCES stage_states(id) ON DELETE CASCADE,
    style_capsule_id UUID REFERENCES style_capsules(id),
    
    applied_at TIMESTAMPTZ DEFAULT NOW(),
    injection_context JSONB
);
Update projects table:
ALTER TABLE projects
ADD COLUMN writing_style_capsule_id UUID REFERENCES style_capsules(id),
ADD COLUMN visual_style_capsule_id UUID REFERENCES style_capsules(id);
Create indexes for performance
Setup RLS policies for user-scoped access and preset capsules
Supabase Storage Setup: backend/scripts/setup-storage-buckets.ts
Create script to initialize Supabase storage buckets:

style-capsule-images bucket for visual reference images
Public read access, authenticated write
File size limits and type validation (PNG, JPG, WEBP)
Seed Script: backend/scripts/seed-style-capsules.ts
Create preset style capsules:

Writing Presets:

"Hemingway Minimalist" - short sentences, simple vocabulary
"Victorian Ornate" - elaborate descriptions, complex syntax
"Hard-Boiled Noir" - terse dialogue, cynical tone
"Whimsical Fantasy" - playful language, inventive descriptions
Visual Presets:

"Neo-Noir" - high contrast, moody lighting, desaturated colors
"Pixar Animation" - bright colors, exaggerated expressions, soft lighting
"Cinéma Vérité" - handheld camera, natural lighting, documentary feel
"Cyberpunk Neon" - neon colors, high-tech aesthetic, night scenes
Feature 2.1: Writing Style Capsule Library
Backend API Routes: backend/src/routes/styleCapsules.ts
Create RESTful endpoints:

GET /api/style-capsules - List all accessible capsules (user + presets)
GET /api/style-capsules/:id - Get single capsule details
POST /api/style-capsules - Create new capsule
PUT /api/style-capsules/:id - Update capsule
DELETE /api/style-capsules/:id - Delete capsule
POST /api/style-capsules/:id/favorite - Toggle favorite status
POST /api/style-capsules/:id/duplicate - Duplicate preset to user's library
Backend Service: backend/src/services/styleCapsuleService.ts
Create service layer handling:

CRUD operations with validation
Preset capsule filtering (read-only enforcement)
Prompt injection formatting for writing styles
Audit logging to style_capsule_applications table
Frontend Types: src/types/styleCapsule.ts
Define TypeScript interfaces:

export interface WritingStyleCapsule {
  id: string;
  name: string;
  type: 'writing';
  exampleTextExcerpts: string[];
  styleLabels: string[];
  negativeConstraints: string[];
  freeformNotes?: string;
  isPreset: boolean;
  isFavorite: boolean;
}

export interface VisualStyleCapsule {
  id: string;
  name: string;
  type: 'visual';
  designPillars: DesignPillars;
  referenceImageUrls: string[];
  descriptorStrings?: string;
  isPreset: boolean;
  isFavorite: boolean;
}

export interface DesignPillars {
  colorPalette?: string;
  mood?: string;
  medium?: string;
  lighting?: string;
  cameraLanguage?: string;
}
Frontend Service: src/lib/services/styleCapsuleService.ts
Client-side service for API communication with proper error handling and auth token management.

Frontend Page: src/pages/StyleCapsuleLibrary.tsx
Main library page with:

Tabs for "Writing Styles" and "Visual Styles"
Filter controls (Presets, Favorites, My Capsules)
Grid/list view of capsules
Create new capsule button
Search/filter functionality
Frontend Component: src/components/styleCapsules/WritingStyleCapsuleEditor.tsx
Modal/drawer editor with fields:

Capsule name input
Example text excerpts (multi-line text areas, can add/remove)
Style labels (tag input)
Negative constraints (tag input)
Freeform notes (optional text area)
Save/Cancel buttons
"Advanced Mode" toggle for power users
Frontend Component: src/components/styleCapsules/StyleCapsuleSelector.tsx
Reusable selector component:

Dropdown with search
Shows preset vs. user capsules
Preview on hover
Used in Stage 1 and Stage 5
Update GlobalSidebar: src/components/layout/GlobalSidebar.tsx
Replace RAG entries:

const sidebarItems: SidebarItem[] = [
  { id: 'home', label: 'Projects', icon: Home, href: '/' },
  { id: 'style-capsules', label: 'Style Capsule Library', icon: Palette, href: '/style-capsules' },
  { id: 'assets', label: 'Asset Library', icon: Box, href: '/assets' },
];
Update Stage 1: src/components/pipeline/Stage1Input.tsx
Add WritingStyleCapsule selector:

Optional field (can be skipped)
Shows preset + user capsules
Stores selection in project settings
Update Prompt Injection: Stages 2-4 Services
Modify treatmentService.ts, beatService.ts, scriptService.ts:

// Replace rag_retrieved_style_examples with capsule injection
const styleInjection = await styleCapsuleService.formatWritingStyleInjection(
  projectSettings.writingStyleCapsuleId
);

const variables = {
  // ... other variables
  writing_style_context: styleInjection,
};
Backend prompt templates should include style injection section:

{if writing_style_context}
Imitate the following prose style. Maintain the sentence length, vocabulary level, 
pacing, and emotional distance demonstrated below. Do not copy content, plot, or 
characters—only stylistic characteristics.

{writing_style_context}
{endif}
Feature 2.2: Visual Style Capsule Library
Backend Image Upload: backend/src/routes/styleCapsules.ts
Add endpoints:

POST /api/style-capsules/:id/upload-image - Upload reference image to Supabase Storage
DELETE /api/style-capsules/:id/images/:imageId - Remove image reference
Handle multipart/form-data uploads
Return public URL after upload
Frontend Component: src/components/styleCapsules/VisualStyleCapsuleEditor.tsx
Editor with:

Capsule name input
Design Pillars form:
Color Palette dropdown
Mood dropdown
Medium dropdown
Lighting dropdown
Camera Language dropdown
Reference Images section:
Upload button (drag-and-drop support)
Image preview grid
Delete image button per image
Descriptor Strings (freeform text area)
Save/Cancel buttons
Frontend Component: src/components/styleCapsules/ImageUploader.tsx
Reusable image upload component:

Drag-and-drop zone
File type validation (PNG, JPG, WEBP)
Size limit enforcement (5MB)
Preview before upload
Progress indicator
Error handling
Update Stage 5: src/components/pipeline/Stage5Assets.tsx
Add Visual Style Capsule selector at top:

Required field (cannot proceed without selection)
Shows preset + user capsules
Preview design pillars and reference images
Lock button to finalize selection
Locked style is stored in stage_state and applied to all asset generation
Visual Prompt Injection: Stage 5, 8, 10
Update image generation calls to inject visual style:

const visualStyleContext = await styleCapsuleService.formatVisualStyleInjection(
  project.visualStyleCapsuleId
);

const imagePrompt = `
${assetDescription}

Style: ${visualStyleContext.designPillars}
Reference adherence: Maintain consistency with provided visual anchor.
`;
Implementation Notes
Service Layer Pattern
All services should follow existing patterns in projectService.ts:

Async/await with proper error handling
Auth token validation
Supabase client usage
Detailed console logging for debugging
UI Component Patterns
Follow existing UI patterns from Stage components:

Use shadcn/ui components (Button, Input, Textarea, Tabs, Dialog)
Consistent styling with Tailwind classes
Motion animations for transitions
Proper loading states and error messages
Type Safety
Maintain strict TypeScript throughout:

Define interfaces in src/types/
Use Zod schemas for validation in backend
Proper null checks and optional chaining
Testing Considerations
After implementation:

Test preset capsule loading
Test user capsule CRUD operations
Test image upload to Supabase Storage
Test style injection in prompt generation
Test RLS policies for security
Migration Execution Order
Run migration 004
Setup Supabase storage buckets
Run seed script for presets
Deploy backend routes and services
Deploy frontend components
Update existing stages to use new system
Remove old RAG references from Index.tsx routing