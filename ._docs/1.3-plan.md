I've written the implementation plan. Here's a summary of what Stage 11 will include:

  Key Features:
  - Real cost breakdown with per-shot image + video costs
  - Model variant selector (Veo 3.1 Fast @ $0.15/sec vs Standard @ $0.40/sec)
  - User credit balance tracking with low-credit warnings
  - Non-blocking dependency warnings (unapproved frames, prior scene continuity)
  - Shot cards with frame previews and both frame/video prompts
  - "Confirm & Render" that creates video generation jobs in the database

  Database Additions:
  - user_credits table for balance tracking
  - video_generation_jobs table for the render queue

  Backend Work:
  - 3 new API endpoints for cost breakdown, credit balance, and confirm/render
  - New services for video generation and user credits

  Frontend Work:
  - New checkoutService following existing patterns
  - Stage 11 rewrite with React Query for real data
  - Stage 12 minimal view showing job queue status

────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Ready to code?

 Here is Claude's plan:
╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌ Stage 11: Confirmation & Gatekeeping - Implementation Plan

 Overview

 Stage 11 is the "checkout" review screen before video generation. It displays shot summaries, frame previews, prompts, cost breakdown, and dependency warnings. After confirmation, video generation jobs are queued 
  and the user advances to Stage 12.

 ---
 Part 1: Database Migrations

 Migration 020: user_credits table

 File: backend/migrations/020_user_credits.sql

 CREATE TABLE user_credits (
     id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
     user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
     balance NUMERIC(12,4) NOT NULL DEFAULT 100.00,  -- Starting balance
     low_credit_threshold NUMERIC(12,4) DEFAULT 10.00,
     last_topup_at TIMESTAMPTZ,
     last_deduction_at TIMESTAMPTZ,
     created_at TIMESTAMPTZ DEFAULT NOW(),
     updated_at TIMESTAMPTZ DEFAULT NOW(),
     UNIQUE(user_id)
 );
 -- RLS policies for user access only

 Migration 021: video_generation_jobs table

 File: backend/migrations/021_video_generation_jobs.sql

 CREATE TABLE video_generation_jobs (
     id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
     project_id UUID NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
     branch_id UUID NOT NULL REFERENCES branches(id) ON DELETE CASCADE,
     scene_id UUID NOT NULL REFERENCES scenes(id) ON DELETE CASCADE,
     shot_id UUID NOT NULL REFERENCES shots(id) ON DELETE CASCADE,
     model_variant TEXT NOT NULL DEFAULT 'veo_3_1_fast',  -- 'veo_3_1_fast' | 'veo_3_1_standard'
     status TEXT NOT NULL DEFAULT 'queued',  -- queued | processing | generating | uploading | completed | failed
     start_frame_id UUID NOT NULL REFERENCES frames(id),
     end_frame_id UUID REFERENCES frames(id),
     start_frame_url TEXT NOT NULL,
     end_frame_url TEXT,
     video_prompt_snapshot TEXT NOT NULL,
     frame_prompt_snapshot TEXT,
     duration_seconds INTEGER NOT NULL,
     estimated_cost NUMERIC(10,4) NOT NULL,
     actual_cost NUMERIC(10,4),
     video_url TEXT,
     storage_path TEXT,
     error_code TEXT,
     error_message TEXT,
     attempt_count INTEGER DEFAULT 0,
     max_retries INTEGER DEFAULT 3,
     provider_job_id TEXT,
     provider_metadata JSONB,
     created_at TIMESTAMPTZ DEFAULT NOW(),
     queued_at TIMESTAMPTZ DEFAULT NOW(),
     processing_started_at TIMESTAMPTZ,
     completed_at TIMESTAMPTZ,
     updated_at TIMESTAMPTZ DEFAULT NOW()
 );
 -- Indexes on project_id, scene_id, shot_id, status
 -- RLS policies for user project access

 ---
 Part 2: Backend Services

 New Service: backend/src/services/videoGenerationService.ts

 Pricing constants:
 - VEO_31_FAST_RATE = 0.15 ($/second)
 - VEO_31_STANDARD_RATE = 0.40 ($/second)

 Key methods:
 - getSceneCostBreakdown(sceneId) - Returns per-shot costs (image + video), scene total
 - getProjectRunningTotal(projectId) - Sum of all previous generation costs
 - getDependencyWarnings(sceneId, branchId) - Check unapproved frames, prior scene continuity
 - confirmAndQueueRender(projectId, branchId, sceneId, modelVariant) - Create video_generation_jobs
 - getVideoJobs(sceneId) - Fetch all jobs for Stage 12 display

 New Service: backend/src/services/userCreditsService.ts

 Key methods:
 - getBalance(userId) - Returns balance, threshold, isLowCredit flag
 - ensureUserCredits(userId) - Create record if missing (100 credits default)
 - deductCredits(userId, amount) - For future use when videos complete

 ---
 Part 3: Backend API Routes

 New Route File: backend/src/routes/checkout.ts
 ┌────────┬─────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────┐
 │ Method │                        Endpoint                         │                       Purpose                       │
 ├────────┼─────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤
 │ GET    │ /api/projects/:projectId/scenes/:sceneId/cost-breakdown │ Full checkout data: shots, costs, credits, warnings │
 ├────────┼─────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤
 │ GET    │ /api/projects/:projectId/credit-balance                 │ User's credit balance                               │
 ├────────┼─────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤
 │ POST   │ /api/projects/:projectId/scenes/:sceneId/confirm-render │ Queue video jobs, body: { modelVariant }            │
 ├────────┼─────────────────────────────────────────────────────────┼─────────────────────────────────────────────────────┤
 │ GET    │ /api/projects/:projectId/scenes/:sceneId/video-jobs     │ List video jobs for Stage 12                        │
 └────────┴─────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────┘
 Register in server.ts:
 import { checkoutRouter } from './routes/checkout.js';
 app.use('/api/projects', authenticateUser, checkoutRouter);

 ---
 Part 4: Frontend Service

 New Service: src/lib/services/checkoutService.ts

 Follow frameService.ts pattern:

 class CheckoutService {
   async getCostBreakdown(projectId: string, sceneId: string): Promise<CheckoutData>;
   async getCreditBalance(projectId: string): Promise<UserCreditBalance>;
   async confirmRender(projectId: string, sceneId: string, modelVariant: string): Promise<ConfirmResult>;
   async getVideoJobs(projectId: string, sceneId: string): Promise<VideoJob[]>;
 }
 export const checkoutService = new CheckoutService();

 ---
 Part 5: Frontend Types

 Update src/types/scene.ts

 export interface ShotCheckoutDetail {
   shotId: string;
   shotUuid: string;
   duration: number;
   startFrameUrl: string | null;
   endFrameUrl: string | null;
   startFrameStatus: FrameStatus;
   endFrameStatus: FrameStatus | null;
   requiresEndFrame: boolean;
   framePrompt: string | null;
   videoPrompt: string | null;
   imageCost: number;
   videoCostFast: number;
   videoCostStandard: number;
 }

 export interface CheckoutData {
   sceneId: string;
   sceneName: string;
   shots: ShotCheckoutDetail[];
   sceneTotalCostFast: number;
   sceneTotalCostStandard: number;
   projectRunningTotal: number;
   userBalance: number;
   lowCreditThreshold: number;
   isLowCredit: boolean;
   warnings: DependencyWarnings;
 }

 export interface DependencyWarnings {
   unapprovedFrames: { shotId: string; frameType: 'start' | 'end' }[];
   priorSceneMismatch: boolean;
   priorSceneEndFrameUrl: string | null;
 }

 export interface VideoGenerationJob {
   id: string;
   shotId: string;
   status: 'queued' | 'processing' | 'generating' | 'uploading' | 'completed' | 'failed';
   modelVariant: 'veo_3_1_fast' | 'veo_3_1_standard';
   duration: number;
   estimatedCost: number;
   videoUrl?: string;
   error?: { code: string; message: string };
   createdAt: string;
   completedAt?: string;
 }

 ---
 Part 6: Stage 11 Component Update

 File: src/components/pipeline/Stage11Confirmation.tsx

 Props update (add projectId):
 interface Stage11ConfirmationProps {
   projectId: string;  // ADD THIS
   sceneId: string;
   onComplete: () => void;
   onBack: () => void;
 }

 Replace mock data with React Query:
 const { data: checkoutData, isLoading, error, refetch } = useQuery({
   queryKey: ['checkout', projectId, sceneId],
   queryFn: () => checkoutService.getCostBreakdown(projectId, sceneId),
 });

 const confirmMutation = useMutation({
   mutationFn: () => checkoutService.confirmRender(projectId, sceneId, modelVariant),
   onSuccess: () => onComplete(),
   onError: (err) => toast.error(err.message),
 });

 UI Enhancements:
 1. Model variant selector - Toggle between Fast ($0.15/s) and Standard ($0.40/s)
 2. Per-shot cost breakdown - Show image cost + video cost separately
 3. Credit balance display - Current balance with low-credit warning
 4. Dependency warnings - Non-blocking amber warnings for unapproved frames or prior scene issues
 5. Expanded shot details - Show both frame prompt AND video prompt
 6. Frame status badges - Show approval status on thumbnails
 7. Loading/error states - Spinner while fetching, error boundary with retry

 Layout:
 +---------------------------------------------------------------+
 | Stage 11: Confirm & Render                                     |
 +---------------------------------------------------------------+
 |                                           |                    |
 |  [Shot Cards with expandable details]     |  Cost Summary      |
 |                                           |  - Shots: N        |
 |  ⚠️ Dependency Warnings (non-blocking)    |  - Duration: Xs    |
 |                                           |  - Image Cost: $X  |
 |                                           |  - Video Cost: $X  |
 |                                           |  - Total: $X       |
 |                                           |                    |
 |                                           |  Credit Balance    |
 |                                           |  $XX.XX            |
 |                                           |                    |
 |                                           |  [Model: Fast ▼]   |
 |                                           |                    |
 |                                           |  [Confirm & Render]|
 +---------------------------------------------------------------+

 ---
 Part 7: Stage 12 Minimal View

 File: src/components/pipeline/Stage12VideoGeneration.tsx

 Transform to queue status view:

 interface Stage12Props {
   projectId: string;  // ADD THIS
   sceneId: string;
   onComplete: () => void;
   onBack: () => void;
   onReturnToStage: (stage: number) => void;
 }

 React Query with polling:
 const { data: jobs } = useQuery({
   queryKey: ['video-jobs', projectId, sceneId],
   queryFn: () => checkoutService.getVideoJobs(projectId, sceneId),
   refetchInterval: (query) => {
     const hasActive = query.state.data?.some(j =>
       ['queued', 'processing', 'generating'].includes(j.status)
     );
     return hasActive ? 3000 : false;
   },
 });

 UI:
 - Job list with status indicators (queued ⏳, processing ⟳, completed ✓, failed ✗)
 - Progress bar showing completion percentage
 - "Complete Scene" button enabled when all jobs complete

 ---
 Part 8: ProjectView Update

 File: src/pages/ProjectView.tsx

 Pass projectId to Stage 11 and Stage 12:

 {sceneStage === 11 && projectId && (
   <Stage11Confirmation
     projectId={projectId}  // ADD THIS
     sceneId={activeSceneId}
     onComplete={handleSceneStageComplete}
     onBack={handleSceneStageBack}
   />
 )}
 {sceneStage === 12 && projectId && (
   <Stage12VideoGeneration
     projectId={projectId}  // ADD THIS
     sceneId={activeSceneId}
     onComplete={handleSceneStageComplete}
     onBack={handleSceneStageBack}
     onReturnToStage={handleReturnToStage}
   />
 )}

 ---
 Implementation Order

 1. Database migrations (020, 021)
 2. Backend services (userCreditsService, videoGenerationService)
 3. Backend routes (checkout.ts, update server.ts)
 4. Frontend types (scene.ts updates)
 5. Frontend service (checkoutService.ts)
 6. Stage 11 component (full rewrite with real data)
 7. Stage 12 component (transform to queue view)
 8. ProjectView (pass projectId to stages)
 9. Testing and verification

 ---
 Verification Steps

 1. Run migrations, verify tables exist with \d user_credits and \d video_generation_jobs
 2. Test API endpoints with curl/Postman:
   - GET /api/projects/:id/scenes/:id/cost-breakdown returns shot details and costs
   - GET /api/projects/:id/credit-balance returns user balance
   - POST /api/projects/:id/scenes/:id/confirm-render creates jobs
   - GET /api/projects/:id/scenes/:id/video-jobs returns job list
 3. Verify Stage 11 UI:
   - Loading state while fetching
   - Shot cards display frame previews and prompts
   - Cost calculations match (duration × rate)
   - Model selector updates total cost
   - Dependency warnings appear when applicable
   - Confirm button creates jobs and advances
 4. Verify Stage 12 UI:
   - Job list displays with correct statuses
   - Polling updates status automatically
   - Progress bar reflects completion

 ---
 Critical Files Summary
 ┌────────────────────────────────────────────────────┬─────────────────────────────────┐
 │                        File                        │             Action              │
 ├────────────────────────────────────────────────────┼─────────────────────────────────┤
 │ backend/migrations/020_user_credits.sql            │ CREATE                          │
 ├────────────────────────────────────────────────────┼─────────────────────────────────┤
 │ backend/migrations/021_video_generation_jobs.sql   │ CREATE                          │
 ├────────────────────────────────────────────────────┼─────────────────────────────────┤
 │ backend/src/services/userCreditsService.ts         │ CREATE                          │
 ├────────────────────────────────────────────────────┼─────────────────────────────────┤
 │ backend/src/services/videoGenerationService.ts     │ CREATE                          │
 ├────────────────────────────────────────────────────┼─────────────────────────────────┤
 │ backend/src/routes/checkout.ts                     │ CREATE                          │
 ├────────────────────────────────────────────────────┼─────────────────────────────────┤
 │ backend/src/server.ts                              │ EDIT - register checkout router │
 ├────────────────────────────────────────────────────┼─────────────────────────────────┤
 │ src/types/scene.ts                                 │ EDIT - add checkout types       │
 ├────────────────────────────────────────────────────┼─────────────────────────────────┤
 │ src/lib/services/checkoutService.ts                │ CREATE                          │
 ├────────────────────────────────────────────────────┼─────────────────────────────────┤
 │ src/components/pipeline/Stage11Confirmation.tsx    │ REWRITE                         │
 ├────────────────────────────────────────────────────┼─────────────────────────────────┤
 │ src/components/pipeline/Stage12VideoGeneration.tsx │ REWRITE                         │
 ├────────────────────────────────────────────────────┼─────────────────────────────────┤
 │ src/pages/ProjectView.tsx                          │ EDIT - pass projectId to stages │
 └────────────────────────────────────────────────────┴─────────────────────────────────┘
╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌