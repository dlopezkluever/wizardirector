This guide provides direct instructions to revise **5.2-dev-plan.md** to align with the PRD's "Deterministic Inversion" philosophy and address the technical risks identified.

The revisions are ordered by **Severity/Urgency**, starting with core architectural logic.

---

### **Priority 1: Architectural Fix – Non-Linear Inheritance**

**Location:** Section "Task 1: Backend - AI Relevance Agent" and "Task 1.2: Relevance Endpoint"
**The Issue:** The plan currently only looks at `scene_number - 1`. If an asset skips a scene, continuity is lost.

* **Revision Instruction:** * Update **Task 1.1 (Relevance Agent Prompt)**: Change the instruction from *"Review the previous scene's end state"* to *"Review the most recent instance of each detected asset within the current branch's history."*
* Update **Task 1.2 (Endpoint Logic)**: Change the SQL/Prisma logic. Instead of querying `where: { scene_id: current_scene - 1 }`, implement a "Search Backwards" function that finds the `last_modified_scene_id` for each asset in that specific branch.



---

### **Priority 2: Data Integrity – Preventing AI "Asset Hallucination"**

**Location:** Section "Task 1.1: Build Relevance Prompt"
**The Issue:** Allowing the AI to "suggest new assets" risks cluttering the database with assets that aren't anchored to the "Global Narrative Truth" (Stage 5).

* **Revision Instruction:**
* Modify the **Prompt Architecture**: Explicitly divide detected assets into two categories: **"Known Project Assets"** (Found in Project Library) and **"Unidentified Props"** (Detected in script but not in library).
* Add a **Business Rule**: The AI *cannot* create a `MasterAsset`. It can only create a `SceneAssetInstance` flagged as `provisional: true`.
* Add a UI requirement to **Task 4 (SceneAssetListPanel)**: "Provisional" assets must be visually distinct (e.g., yellow border) and require the user to either 'Link to Master' or 'Dismiss'.



---

### **Priority 3: Financial Safety – Cost Discipline**

**Location:** Section "Task 7: Bulk Image Generation Workflow"
**The Issue:** No confirmation or cost estimate before triggering expensive Nano Banana calls.

* **Revision Instruction:**
* **Insert Task 7.0 (Cost Preview):** Before the "Generate All" action, the system must calculate `count(selected_assets) * cost_per_image`.
* **UI Update:** Add a "Confirm Generation" modal that displays: *"This action will use [X] credits and generate [Y] images. Continue?"* as per the PRD's Cost Discipline requirement.



---

### **Priority 4: UI/UX Structural Re-haul (Visual-First)**

**Location:** Section "Task 3: UI - Rebuild Stage8VisualDefinition"
**The Issue:** The current skeleton is too simple and lacks the "Rearview Mirror" context for continuity.

* **Revision Instruction:** * Replace the "Three-Panel Layout" description with a **"Split-View Narrative Layout"**:
* **Left (Library):** The "Asset Drawer" is no longer a modal; it is a persistent, searchable side-bar.
* **Center (Current Stage):** Visual Editor for the active asset.
* **Right (Continuity Panel):** This new panel must show the "Inheritance Path" (e.g., "Inheriting description from Scene 4") and the "Previous Scene End-State Summary."

---

### **Priority 5: Feature Completion – Continuity Locks**

**Location:** Section "Task 9: Status Tags Editor"
**The Issue:** Status tags (like "Muddy") need to be explicitly told to "Carry Forward" to the next scene.

* **Revision Instruction:**
* Add a sub-task: **"Implement Persistence Toggles."**
* In the UI, each tag must have a `carry_forward` boolean toggle (represented by a "Lock" or "Chain" icon).
* **Database Sync:** Ensure that when a user toggles this, the `SceneAssetInstance` record updates its `metadata` field to include `sticky_tags: [...]`.



---

### **Priority 6: The "Starting State" Logic Gap**

**Location:** Section "Executive Summary" and "Task 5"
**The Issue:** The plan focuses on "Starting State" but doesn't define how it reconciles with the "End State" of the previous scene.

* **Revision Instruction:**
* Update **Task 5 (Visual State Editor)**: Add a "Reconcile" button.
* **Logic Requirement:** If the AI detects a conflict (e.g., Scene 4 ended with the car "Exploded," but Scene 5 script says the car "Drives away"), the UI must flag a **"Continuity Conflict"** in the Visual State Editor, forcing the user to choose which "Truth" to follow.



---

### **Updated Implementation Order (Revised)**

1. **Backend:** Non-Linear Inheritance Logic & Provisional Asset Flagging.
2. **Prompt Engineering:** Relevance Agent Prompt (Project-First filtering).
3. **UI Core:** Split-View Layout with Continuity Panel.
4. **Feature:** Continuity Lock Toggles on Status Tags.
5. **Safety:** Cost Preview Modal for Bulk Generation.
6. **Integration:** Asset Drawer Persistence.

---

---

---

More Context:

The development plan for **Feature 5.2 (Stage 8 - Visual Definition UI)** is a robust technical foundation that correctly identifies the core data flow requirements. It successfully bridges the gap between the existing Phase A (Global Assets) and the specific needs of Phase B (Scene-specific instances).

However, there are critical architectural and UI/UX risks that need addressing to align with the "Deterministic Inversion" philosophy and the inheritance logic specified in your **project-overview.md**.

### **1. Key Flaws and Risks (Important)**

* **Linear vs. Skip-Scene Inheritance:**
* **The Flaw:** The proposed `detectRelevantAssets` backend logic only looks at `scene_number - 1` for inheritance.
* **The Risk:** If an asset appears in Scene 1, is absent in Scene 2, and reappears in Scene 3, this logic will treat it as a "New Asset" or revert to the Master Asset definition, losing any state changes from Scene 1.
* **Correction:** The inheritance service should query for the *most recent* instance of that asset across all prior scenes in the active branch to maintain continuity.


* **AI Agent "Hallucination" of New Assets:**
* **The Flaw:** The plan allows the AI agent to suggest `new_assets_required` based on the shot list.
* **The Risk:** Stage 5 (Global Asset Definition) is meant to be the "Global Narrative Truth". Allowing the Stage 8 agent to create assets on the fly can lead to "asset bloat" where minor props become tracked entities without a Master Asset anchor.
* **Correction:** New assets detected in Stage 8 should be flagged as "Temporary/Scene-Only" or require an "Escalate to Master" workflow to ensure the Global Context remains the source of truth.


* **Cost Discipline & Confirmation:**
* **The Flaw:** The plan proposes a "Bulk Image Generation" workflow but does not include a cost estimation or confirmation step.
* **The Risk:** Users could accidentally trigger dozens of Nano Banana calls simultaneously.
* **Correction:** The UI must display a "Cost Preview" (e.g., "This will use 15 Credits") before the bulk generation starts, as mandated by the PRD's cost discipline section.



---

### **2. What Is Solid and Well-Designed?**

* **Audit Trail Implementation:** The inclusion of `modification_count`, `last_modified_field`, and `modification_reason` in the state editor is excellent. It ensures that if a character's look drifts, the user can trace it back to a specific scene's "Starting State" edit.
* **Prompt Architecture:** The `buildRelevancePrompt` is highly sophisticated. It correctly provides the AI with:
1. The **Global Context** (Available Project Assets).
2. The **Local Context** (Current Shot List).
3. The **Historical Context** (Previous Scene End-States).


* **Frontend Service Decoupling:** The `SceneAssetService` is clean and correctly uses React Query for server-state management, which is consistent with the existing tech stack.

---

### **3. Medium / Low-Level Design Gaps**

* **Status Tag Persistence UI:** The PRD mentions that tags like "Muddy" or "Torn" can be toggled to `carry_forward: true`. The plan mentions a "Status Tags Editor" but doesn't define the UI for this toggle. Users need a clear "Continuity Lock" icon next to these tags.
* **The "End-State" Conflict:** The plan defines Stage 8 as "Starting Visual State". However, if an asset is "Bloody" at the *end* of Scene 4, Stage 8 of Scene 5 must show it as "Bloody" at the *start*. The plan needs to clarify how it handles the "Summary of End State" from the `scenes` table.
* **Asset Drawer Feedback:** When dragging an asset from the "Global Library" into the scene, the UI should immediately show the "Inheritance Source" (e.g., "Inherited from Master") so the user knows they are starting from a clean slate.

---

### **4. Recommended UI/UX Restructuring**

Since you've authorized a complete overhaul of the basic skeleton, here is a recommended **"Visual-First" Layout** for Stage 8:

1. **The "Continuity Header":**
* A persistent top bar showing the "Previous Scene End-State Summary". This provides the "Rearview Mirror" context required by the PRD.


2. **The "Relevance Detection" Stage:**
* Instead of jumping straight to the editor, use an **"Interceptive Modal"** or **"Overlay"** when first entering a scene.
* AI displays: "I detected these 4 assets in the shot list. Should I add them?"
* User approves/rejects before they even see the main editor.


3. **The "Split-View" Editor:**
* **Left Panel (Inventory):** Grouped by type (Characters, Props, Environments). Use thumbnails of the **Master Asset** vs. the **Current Scene Instance**.
* **Center Panel (Visual Definition):** A large "Current Visual State" image (Nano Banana output) with a side-by-side text editor for the `effective_description`.
* **Right Panel (Inheritance & Tags):** A specialized "Continuity Panel" showing the history of that asset (e.g., "Changed in Scene 2: Added Scar").


4. **The "Bulk Generation" Queue:**
* A bottom-docked status bar that shows the progress of all current image generation jobs with "Retry" buttons for failures.



### **Summary Table: Plan vs. PRD Alignment**

| Feature | Plan Status | PRD Requirement | Recommendation |
| --- | --- | --- | --- |
| **Inheritance** | Linear (N-1) | Deep (Last Seen) | **Update query logic** |
| **Asset Source** | AI Suggested | Global First | **Prioritize Master Assets** |
| **Cost Control** | Missing | Explicit Confirmation | **Add Cost Preview** |
| **Audit Trail** | Strong | Mandatory | **Keep as is** |
| **Status Tags** | Mentioned | Persistence Toggle | **Add "Continuity Lock" UI** |