Revision Guide: Phase 5 Feature 5.1 Implementation Plan

Follow these instructions to update Phase-5-Feature-5.1-Implementation-Plan.md. Revisions are ordered by severity.

1. Fix the Inheritance Chain (Urgent / High Severity)

Location: Architecture Summary and Task 1: Database Schema
Problem: The plan currently references the Scene ID for inheritance, which loses specific instance state (overrides/tags) if a scene has multiple versions or complex branching.

Action:

In the Architecture Summary diagram, change:
inherited_from_scene_id (self-referential)
to
inherited_from_instance_id (self-referential to scene_asset_instances.id)

In Task 1: Schema Definition, change the column definition:

-- Replace:
inherited_from_scene_id UUID REFERENCES scenes(id),
-- With:
inherited_from_instance_id UUID REFERENCES scene_asset_instances(id),


2. Implement "Effective Description" Sync (High Severity)

Location: Task 4: State Propagation Logic
Problem: If the Master Asset (Stage 5) description changes, the effective_description in existing Scene Instances will become stale.

Action: Add a new sub-task for a Database Trigger to ensure data integrity.
Insert Text:

Task 1.2: Integrity Triggers
Create a Postgres trigger on project_assets that updates scene_asset_instances.effective_description whenever project_assets.description changes, provided the instance does not have a description_override.

CREATE OR REPLACE FUNCTION sync_effective_description() RETURNS TRIGGER AS $$
BEGIN
  UPDATE scene_asset_instances 
  SET effective_description = NEW.description
  WHERE project_asset_id = NEW.id AND description_override IS NULL;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;


3. Define the "Carry Forward" Logic (Medium Severity)

Location: Task 2: Asset Inheritance Logic
Problem: The plan doesn't specify what happens to an asset's appearance when carry_forward is toggled off.

Action: Add a "Business Logic Rule" section.
Insert Text:

Inheritance Rule Set:

If carry_forward is TRUE: Instance inherits status_tags and description_override from the inherited_from_instance_id.

If carry_forward is FALSE: Instance resets to the Master Asset description and empty tags, but maintains the link for history tracking.

4. Close the Nano Banana Loop (Medium Severity)

Location: Task 3: API Implementation
Problem: The API defines imageKeyUrl as a static field, but the PRD requires "scene-specific image key generation."

Action: Update the PUT /api/scenes/:sceneId/assets/:assetId description.
Insert Text:

Logic Update:
When the API receives a description_override, it must:

Update the scene_asset_instances record.

Check if a new reference image is required.

Trigger a background job to the Nano Banana Service (Image Generator) using the new effective_description and the Scene's Style Capsule.

Return the jobId so the frontend can show a loading state on the asset card.

5. Prevent Timeline Paradoxes (Low Severity)

Location: Task 4: State Propagation Logic
Problem: Users might try to link a scene to one that occurs later in the script.

Action: Add a validation step in the service layer.
Insert Text:

Validation Hook:
Before creating an inheritance link, the SceneAssetService must verify that target_scene.index > source_scene.index. Throw a 400 Bad Request if an attempt is made to inherit from a "future" scene.

Final Review Checklist for Revise Doc

[ ] Schema uses inherited_from_instance_id.

[ ] Trigger added for Master -> Instance description sync.

[ ] API triggers Image Generation job on override.

[ ] Sequential scene validation logic included.