Here is Claude's plan:
╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌ Stage 12: Video Generation, Review & Iteration Loop - Implementation Plan

 Overview

 Build the complete Stage 12 pipeline: Veo3 video generation backend (with mock fallback), enhanced scene review player with sequential playback,    
 issue resolution routing, and render-complete notifications with Script Hub re-entry.

 ---
 Part 1: Backend - Video Generation Executor

 1A. Veo3 Provider Interface & Mock Implementation

 New file: backend/src/services/video-generation/VideoProviderInterface.ts
 - Define VideoProvider interface: generateVideo(params) => Promise<VideoResult>
 - Params: startFrameUrl, endFrameUrl?, prompt, durationSeconds, modelVariant
 - Result: videoUrl, storagePath, actualCost, providerJobId, providerMetadata

 New file: backend/src/services/video-generation/MockVideoProvider.ts
 - Implements VideoProvider
 - Simulates generation delay (5-10 seconds via setTimeout)
 - Returns a placeholder/sample video URL (static MP4 from Supabase storage or a public sample)
 - Generates realistic cost based on duration and model variant

 New file: backend/src/services/video-generation/Veo3Provider.ts
 - Implements VideoProvider using Google Vertex AI / Veo3 API
 - Uses @google-cloud/aiplatform or REST API for Veo3 video generation
 - Handles: submit generation request → poll for completion → download/upload result to Supabase storage
 - Maps Veo3 response to VideoResult interface

 Feature flag: Environment variable VIDEO_PROVIDER=mock|veo3 (default: mock)

 New file: backend/src/services/video-generation/createVideoProvider.ts
 - Factory function that reads VIDEO_PROVIDER env var and returns the appropriate provider instance

 1B. Video Job Executor (Database Polling Pattern)

 New file: backend/src/services/video-generation/VideoJobExecutor.ts
 - Follows the same pattern as ImageGenerationService.executeJobInBackground()
 - Core loop: poll video_generation_jobs table for status = 'queued' jobs
 - For each job:
   a. Update status → processing (set processing_started_at, increment attempt_count)
   b. Update status → generating
   c. Call VideoProvider.generateVideo() with job data
   d. Upload result video to Supabase Storage (bucket: videos)
   e. Update status → uploading during upload
   f. Update status → completed with video_url, storage_path, actual_cost
   g. On error: Update status → failed with error_code, error_message
   h. Retry logic: if attempt_count < max_retries, reset to queued
 - Concurrency: process one job at a time (sequential) to avoid overloading
 - Poll interval: 5 seconds

 Modified file: backend/src/services/videoGenerationService.ts
 - After confirmAndQueueRender() inserts jobs, trigger the executor:
   - Call videoJobExecutor.processQueuedJobs() (fire-and-forget, don't await)
   - This kicks off background processing for the newly queued jobs
 - Add deductCredits call during job confirmation (currently missing - credits aren't being deducted)

 1C. Video Storage

 - Supabase Storage bucket: videos (create if not exists)
 - Path pattern: {projectId}/{sceneId}/{jobId}.mp4
 - Generate signed URLs for frontend playback (or public URLs if bucket is public)

 1D. Scene Completion Tracking

 Modified file: backend/src/services/videoGenerationService.ts
 - Add method: checkAndUpdateSceneStatus(sceneId)
   - When all jobs for a scene are completed, update scene status to video_complete
   - Called after each job completes in the executor
 - Add method: getSceneRenderStatus(sceneId) → returns 'pending' | 'rendering' | 'complete' | 'failed'
   - Used by Script Hub to show badges

 1E. New API Endpoints

 Modified file: backend/src/routes/checkout.ts
 - GET /api/projects/:projectId/scenes/:sceneId/render-status - Returns scene-level render status for Script Hub badge
 - POST /api/projects/:projectId/scenes/:sceneId/video/:jobId/retry - Retry a failed job (reset to queued)

 ---
 Part 2: Frontend - Enhanced Video Player

 2A. Scene Video Player Component

 Modified file: src/components/pipeline/Stage12VideoGeneration.tsx (major rewrite)

 Sequential Scene Playback System:
 - Maintain a playlist of completed job video URLs in shot order
 - Use a single <video> element with an onEnded event handler
 - When current video ends, auto-advance src to next shot's video
 - Track: currentShotIndex, isPlaying, globalProgress (across all shots)

 Enhanced Timeline:
 - Segmented timeline bar showing all shots as proportional segments (based on duration)
 - Each segment colored by status: green (completed), yellow (generating), red (failed), gray (queued)
 - Active shot highlighted with border/glow
 - Click on any segment to jump to that shot
 - Current playback position indicator within active segment

 Player Controls:
 - Play/Pause toggle for full scene playback
 - Skip forward/back between shots
 - Scrub within current shot (native video scrubbing)
 - Volume control
 - Fullscreen toggle
 - Current time / total duration display

 Shot Info Overlay:
 - Small label showing current shot number and name during playback
 - Fades in/out on shot transitions

 2B. Side Panel Improvements

 Job Cards (keep existing pattern, enhance):
 - Add shot number/label (e.g., "Shot 1A", "Shot 2B")
 - Show generation time (from processingStartedAt to completedAt)
 - Add "Retry" button on failed jobs (calls retry endpoint)
 - Clicking a job card jumps player to that shot

 Issue Resolution Panel (fix routing):
 - Update issue type mappings:
   - Visual Continuity → Stage 8 (was 10)
   - Timing Issue → Stage 7 (correct)
   - Dialogue/Audio → Stage 9 (correct)
   - Narrative Structure → Stage 7 (correct)
 - Add free-text field for issue description before routing
 - Add confirmation dialog before routing back ("This will return you to Stage X. Continue?")

 2C. Rendering Progress States

 While rendering:
 - Show start frame as preview for in-progress shots
 - Animated progress indicators per shot
 - ETA display based on average generation time of completed shots
 - "All videos rendering..." overlay with progress percentage

 When complete:
 - Auto-show first shot video in player
 - Toast notification: "All videos for Scene X are ready for review!"
 - Enable "Play Scene" button and issue resolution panel

 ---
 Part 3: Notifications & Script Hub Re-Entry

 3A. Script Hub Badge

 Modified file: src/components/pipeline/Stage6ScriptHub.tsx
 - Add new scene status: check if scene has completed renders via API
 - New badge type: "Review Ready" (distinct green/blue badge) for scenes where all video jobs are complete but user hasn't reviewed yet
 - Add a pulsing/animated indicator to draw attention to scenes awaiting review

 Modified file: src/lib/services/checkoutService.ts
 - Add method: getSceneRenderStatus(projectId, sceneId) → calls new render-status endpoint
 - Add method: getBatchRenderStatus(projectId) → fetch render status for all scenes (for Script Hub overview)

 3B. Render Re-Entry Navigation

 Modified file: src/components/pipeline/Stage6ScriptHub.tsx
 - When a scene has "Review Ready" status, clicking it shows a "Review Video" action button
 - Clicking "Review Video" calls onEnterScene(sceneId) but with a flag to jump directly to Stage 12

 Modified file: src/pages/ProjectView.tsx
 - Add handleEnterSceneAtStage(sceneId, stage) function
 - Sets activeSceneId, sceneStage to the target stage (12) directly
 - Called from Script Hub's "Review Video" button

 3C. Toast Notifications

 Modified file: src/components/pipeline/Stage12VideoGeneration.tsx
 - Watch for transition from active→complete in polling data
 - When allComplete becomes true and wasn't before, show toast: "All videos rendered! Ready for review."
 - If any jobs failed, show warning toast with count

 ---
 Part 4: Issue Resolution Workflow

 4A. Issue Description Capture
                                                  ates
 Modified file: src/components/pipeline/Stage12VideoGeneration.tsx
 ---hen user selects an issue type, show a text area for describing the specific issue
 Files Modified (Summary)age X" button
 - Store the issue description (optional: save to a stage_issues or metadata field)
 Backend (new)
 4B. Return-to-Stage Flow
 - backend/src/services/video-generation/VideoProviderInterface.ts
 - backend/src/services/video-generation/MockVideoProvider.ts
 - backend/src/services/video-generation/Veo3Provider.ts

 ---
 Implementation Order

 1. Backend provider interface + mock (Parts 1A) - foundation
 2. Backend job executor (Part 1B) - enables end-to-end testing with mock
 3. Backend new endpoints + scene status (Parts 1C, 1D, 1E)
 4. Frontend player rewrite (Part 2A) - core UX improvement
 5. Frontend side panel + issue resolution (Parts 2B, 4A, 4B)
 6. Frontend notifications + Script Hub (Parts 3A, 3B, 3C)
 7. Veo3 real provider (Part 1A - Veo3Provider.ts) - behind feature flag
 8. Polish and test - end-to-end flow verification

 ---
 Verification / Testing

 1. Mock flow end-to-end: Stage 11 confirm → jobs created → executor picks up → mock generates → Stage 12 shows completed videos → play scene        
 2. Sequential playback: Verify shots play in order, auto-advance works, timeline segments are clickable
 3. Issue routing: Click each issue type → verify correct stage navigation with confirmation dialog
 4. Script Hub badges: Complete a render → return to Script Hub → verify "Review Ready" badge appears
 5. Re-entry: Click "Review Ready" scene → verify direct navigation to Stage 12
 6. Retry flow: Force a job failure → verify retry button resets job → executor picks it up again
 7. Feature flag: Toggle VIDEO_PROVIDER=veo3 → verify real provider is used (requires credentials)
 8. Run npm run lint from project root after all changes 
 
 
 
 
 
 
 
 
 
 
 
 
 
 The plan is written. Here's a quick summary of what it covers:

  Backend (5 new files, 2 modified):
  - Video provider interface with mock + real Veo3 behind VIDEO_PROVIDER env flag
  - Database-polling job executor (same pattern as image generation)
  - Scene completion tracking + new API endpoints (render-status, retry)
  - Credit deduction fix during job confirmation

  Frontend (4 modified files):
  - Major Stage 12 rewrite: sequential scene player with segmented timeline, auto-advance, shot markers, scrub controls
  - Issue resolution with corrected stage mappings (Visual→8, Timing→7, Audio→9, Narrative→7) + description text field
  - Script Hub "Review Ready" badges + direct re-entry to Stage 12
  - Toast notifications on render completion

  8-step implementation order progressing from backend foundation through to polish.

───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Ready to code?

 Here is Claude's plan:
╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌ Stage 12: Video Generation, Review & Iteration Loop - Implementation Plan

 Overview

 Build the complete Stage 12 pipeline: Veo3 video generation backend (with mock fallback), enhanced scene review player with sequential playback,    
 issue resolution routing, and render-complete notifications with Script Hub re-entry.

 ---
 Part 1: Backend - Video Generation Executor

 1A. Veo3 Provider Interface & Mock Implementation

 New file: backend/src/services/video-generation/VideoProviderInterface.ts
 - Define VideoProvider interface: generateVideo(params) => Promise<VideoResult>
 - Params: startFrameUrl, endFrameUrl?, prompt, durationSeconds, modelVariant
 - Result: videoUrl, storagePath, actualCost, providerJobId, providerMetadata

 New file: backend/src/services/video-generation/MockVideoProvider.ts
 - Implements VideoProvider
 - Simulates generation delay (5-10 seconds via setTimeout)
 - Returns a placeholder/sample video URL (static MP4 from Supabase storage or a public sample)
 - Generates realistic cost based on duration and model variant

 New file: backend/src/services/video-generation/Veo3Provider.ts
 - Implements VideoProvider using Google Vertex AI / Veo3 API
 - Uses @google-cloud/aiplatform or REST API for Veo3 video generation
 - Handles: submit generation request → poll for completion → download/upload result to Supabase storage
 - Maps Veo3 response to VideoResult interface

 Feature flag: Environment variable VIDEO_PROVIDER=mock|veo3 (default: mock)

 New file: backend/src/services/video-generation/createVideoProvider.ts
 - Factory function that reads VIDEO_PROVIDER env var and returns the appropriate provider instance

 1B. Video Job Executor (Database Polling Pattern)

 New file: backend/src/services/video-generation/VideoJobExecutor.ts
 - Follows the same pattern as ImageGenerationService.executeJobInBackground()
 - Core loop: poll video_generation_jobs table for status = 'queued' jobs
 - For each job:
   a. Update status → processing (set processing_started_at, increment attempt_count)
   b. Update status → generating
   c. Call VideoProvider.generateVideo() with job data
   d. Upload result video to Supabase Storage (bucket: videos)
   e. Update status → uploading during upload
   f. Update status → completed with video_url, storage_path, actual_cost
   g. On error: Update status → failed with error_code, error_message
   h. Retry logic: if attempt_count < max_retries, reset to queued
 - Concurrency: process one job at a time (sequential) to avoid overloading
 - Poll interval: 5 seconds

 Modified file: backend/src/services/videoGenerationService.ts
 - After confirmAndQueueRender() inserts jobs, trigger the executor:
   - Call videoJobExecutor.processQueuedJobs() (fire-and-forget, don't await)
   - This kicks off background processing for the newly queued jobs
 - Add deductCredits call during job confirmation (currently missing - credits aren't being deducted)

 1C. Video Storage

 - Supabase Storage bucket: videos (create if not exists)
 - Path pattern: {projectId}/{sceneId}/{jobId}.mp4
 - Generate signed URLs for frontend playback (or public URLs if bucket is public)

 1D. Scene Completion Tracking

 Modified file: backend/src/services/videoGenerationService.ts
 - Add method: checkAndUpdateSceneStatus(sceneId)
   - When all jobs for a scene are completed, update scene status to video_complete
   - Called after each job completes in the executor
 - Add method: getSceneRenderStatus(sceneId) → returns 'pending' | 'rendering' | 'complete' | 'failed'
   - Used by Script Hub to show badges

 1E. New API Endpoints

 Modified file: backend/src/routes/checkout.ts
 - GET /api/projects/:projectId/scenes/:sceneId/render-status - Returns scene-level render status for Script Hub badge
 - POST /api/projects/:projectId/scenes/:sceneId/video/:jobId/retry - Retry a failed job (reset to queued)

 ---
 Part 2: Frontend - Enhanced Video Player

 2A. Scene Video Player Component

 Modified file: src/components/pipeline/Stage12VideoGeneration.tsx (major rewrite)

 Sequential Scene Playback System:
 - Maintain a playlist of completed job video URLs in shot order
 - Use a single <video> element with an onEnded event handler
 - When current video ends, auto-advance src to next shot's video
 - Track: currentShotIndex, isPlaying, globalProgress (across all shots)

 Enhanced Timeline:
 - Segmented timeline bar showing all shots as proportional segments (based on duration)
 - Each segment colored by status: green (completed), yellow (generating), red (failed), gray (queued)
 - Active shot highlighted with border/glow
 - Click on any segment to jump to that shot
 - Current playback position indicator within active segment

 Player Controls:
 - Play/Pause toggle for full scene playback
 - Skip forward/back between shots
 - Scrub within current shot (native video scrubbing)
 - Volume control
 - Fullscreen toggle
 - Current time / total duration display

 Shot Info Overlay:
 - Small label showing current shot number and name during playback
 - Fades in/out on shot transitions

 2B. Side Panel Improvements

 Job Cards (keep existing pattern, enhance):
 - Add shot number/label (e.g., "Shot 1A", "Shot 2B")
 - Show generation time (from processingStartedAt to completedAt)
 - Add "Retry" button on failed jobs (calls retry endpoint)
 - Clicking a job card jumps player to that shot

 Issue Resolution Panel (fix routing):
 - Update issue type mappings:
   - Visual Continuity → Stage 8 (was 10)
   - Timing Issue → Stage 7 (correct)
   - Dialogue/Audio → Stage 9 (correct)
   - Narrative Structure → Stage 7 (correct)
 - Add free-text field for issue description before routing
 - Add confirmation dialog before routing back ("This will return you to Stage X. Continue?")

 2C. Rendering Progress States

 While rendering:
 - Show start frame as preview for in-progress shots
 - Animated progress indicators per shot
 - ETA display based on average generation time of completed shots
 - "All videos rendering..." overlay with progress percentage

 When complete:
 - Auto-show first shot video in player
 - Toast notification: "All videos for Scene X are ready for review!"
 - Enable "Play Scene" button and issue resolution panel

 ---
 Part 3: Notifications & Script Hub Re-Entry

 3A. Script Hub Badge

 Modified file: src/components/pipeline/Stage6ScriptHub.tsx
 - Add new scene status: check if scene has completed renders via API
 - New badge type: "Review Ready" (distinct green/blue badge) for scenes where all video jobs are complete but user hasn't reviewed yet
 - Add a pulsing/animated indicator to draw attention to scenes awaiting review

 Modified file: src/lib/services/checkoutService.ts
 - Add method: getSceneRenderStatus(projectId, sceneId) → calls new render-status endpoint
 - Add method: getBatchRenderStatus(projectId) → fetch render status for all scenes (for Script Hub overview)

 3B. Render Re-Entry Navigation

 Modified file: src/components/pipeline/Stage6ScriptHub.tsx
 - When a scene has "Review Ready" status, clicking it shows a "Review Video" action button
 - Clicking "Review Video" calls onEnterScene(sceneId) but with a flag to jump directly to Stage 12

 Modified file: src/pages/ProjectView.tsx
 - Add handleEnterSceneAtStage(sceneId, stage) function
 - Sets activeSceneId, sceneStage to the target stage (12) directly
 - Called from Script Hub's "Review Video" button

 3C. Toast Notifications

 Modified file: src/components/pipeline/Stage12VideoGeneration.tsx
 - Watch for transition from active→complete in polling data
 - When allComplete becomes true and wasn't before, show toast: "All videos rendered! Ready for review."
 - If any jobs failed, show warning toast with count

 ---
 Part 4: Issue Resolution Workflow

 4A. Issue Description Capture

 Modified file: src/components/pipeline/Stage12VideoGeneration.tsx
 - When user selects an issue type, show a text area for describing the specific issue
 - "Submit & Return to Stage X" button
 - Store the issue description (optional: save to a stage_issues or metadata field)

 4B. Return-to-Stage Flow

 Modified file: src/pages/ProjectView.tsx
 - handleReturnToStage already works for stage 7-12
 - Verify it properly resets scene stage and navigates

 ---
 Files Modified (Summary)

 Backend (new)

 - backend/src/services/video-generation/VideoProviderInterface.ts
 - backend/src/services/video-generation/MockVideoProvider.ts
 - backend/src/services/video-generation/Veo3Provider.ts
 - backend/src/services/video-generation/createVideoProvider.ts
 - backend/src/services/video-generation/VideoJobExecutor.ts

 Backend (modified)

 - backend/src/services/videoGenerationService.ts - scene completion tracking, credit deduction
 - backend/src/routes/checkout.ts - new endpoints (render-status, retry)

 Frontend (modified)

 - src/components/pipeline/Stage12VideoGeneration.tsx - major rewrite (player, timeline, controls)
 - src/components/pipeline/Stage6ScriptHub.tsx - render status badges, review re-entry
 - src/lib/services/checkoutService.ts - new service methods
 - src/pages/ProjectView.tsx - handleEnterSceneAtStage() for direct Stage 12 entry

