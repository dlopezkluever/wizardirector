# Stage 4 Style Capsule Logging Fix - Implementation Summary

**Date**: 2026-01-16  
**Issue**: Stage 4 (and initial generations for all stages) not logging to `style_capsule_applications` table

---

## Root Cause

The logging was trying to happen immediately after LLM generation, but **stage states don't exist yet** on first generation. The timeline was:

1. Frontend calls `/api/llm/generate-from-template` → fetches `stageStateId` (returns `null` for new stages)
2. LLM generates content  
3. ❌ **Logging attempted here but fails due to null stageStateId**
4. Frontend creates stage state via `/api/projects/:projectId/stages/:stageNumber`

**Solution**: Move logging to happen AFTER stage state creation, not during LLM generation.

---

## Implementation Strategy

### Pass Style Capsule Metadata Through the Save Flow

1. **Backend LLM route** → Returns `styleCapsuleMetadata` in response
2. **Frontend services** → Extract and pass it to components
3. **Frontend components** → Store temporarily in content as `_styleCapsuleMetadata`
4. **Stage state service** → Extract from content and pass to backend
5. **Backend stage state route** → Log to database after creating stage state

---

## ✅ Completed Changes

### 1. Backend LLM Route (`backend/src/routes/llm.ts`)
- Removed old logging logic (lines 290-316)
- Now prepares `styleCapsuleMetadata` and includes it in response
- Frontend receives it to pass when saving stage state

### 2. Backend Stage State Route (`backend/src/routes/stageStates.ts`)
- Accepts `styleCapsuleMetadata` in request body
- Logs to `style_capsule_applications` table AFTER stage state is created
- Logs success with stage state ID

### 3. Stage State Service (`src/lib/services/stageStateService.ts`)
- Added `styleCapsuleMetadata` to `SaveStageStateOptions` interface
- Extracts `_styleCapsuleMetadata` from content if present
- Removes it from content before saving (cleanup)
- Passes it separately in request body

### 4. Treatment Service (`src/lib/services/treatmentService.ts`)
- Updated `GenerateTreatmentResponse` interface to include `styleCapsuleMetadata`
- Extracts and returns it from backend response (2 methods: generate + regenerate)

### 5. Stage 2 Treatment Component (`src/components/pipeline/Stage2Treatment.tsx`)
- Stores `_styleCapsuleMetadata` in content when setting state (2 places: generate + regenerate)
- Auto-save mechanism extracts and passes it to backend

---

## ✅ ALL CHANGES COMPLETED

All files have been updated and linter errors resolved!

## ~~Remaining Changes~~ (COMPLETED)

### 6. Beat Service (`src/lib/services/beatService.ts`)

**Update interface**:
```typescript
export interface GenerateBeatsResponse {
  beats: Beat[];
  totalEstimatedRuntime: number;
  narrativeStructure: string;
  langsmithTraceId: string;
  promptTemplateVersion: string;
  styleCapsuleMetadata?: {  // ← ADD THIS
    styleCapsuleId: string;
    injectionContext: Record<string, any>;
  };
}
```

**Update return statements** (2 methods: `generateBeats` and `regenerateBeats`):
```typescript
return {
  beats: parsedBeats.beats,
  totalEstimatedRuntime: parsedBeats.totalEstimatedRuntime,
  narrativeStructure: parsedBeats.narrativeStructure,
  langsmithTraceId: result.data.traceId,
  promptTemplateVersion: result.data.promptTemplateVersion || '1.0.0',
  styleCapsuleMetadata: result.data.styleCapsuleMetadata  // ← ADD THIS
};
```

### 7. Stage 3 Beat Sheet Component (`src/components/pipeline/Stage3BeatSheet.tsx`)

**Find where beats are saved** (search for `setStageContent` or similar):
```typescript
setStageContent(prev => ({
  ...prev,
  beats: result.beats,
  // ... other fields ...
  langsmithTraceId: result.langsmithTraceId,
  promptTemplateVersion: result.promptTemplateVersion,
  _styleCapsuleMetadata: result.styleCapsuleMetadata  // ← ADD THIS
}));
```

### 8. Script Service (`src/lib/services/scriptService.ts`)

**Update interface**:
```typescript
export interface GenerateScriptResponse {
  formattedScript: string;
  scenes: Scene[];
  estimatedPageCount?: number;
  langsmithTraceId: string;
  promptTemplateVersion: string;
  styleCapsuleMetadata?: {  // ← ADD THIS
    styleCapsuleId: string;
    injectionContext: Record<string, any>;
  };
}
```

**Update return statements** (2 methods: `generateScript` and `regenerateScript`):
```typescript
return {
  formattedScript: parsed.formattedScript,
  scenes: parsed.scenes,
  estimatedPageCount: parsed.estimatedPageCount,
  langsmithTraceId: result.data.traceId,
  promptTemplateVersion: result.data.promptTemplateVersion || '1.0.0',
  styleCapsuleMetadata: result.data.styleCapsuleMetadata  // ← ADD THIS
};
```

### 9. Stage 4 Master Script Component (`src/components/pipeline/Stage4MasterScript.tsx`)

**Find where script is saved** (search for `setStageContent` after generation):
```typescript
setStageContent(prev => ({
  ...prev,
  formattedScript: result.formattedScript,
  scenes: result.scenes,
  // ... other fields ...
  langsmithTraceId: result.langsmithTraceId,
  promptTemplateVersion: result.promptTemplateVersion,
  _styleCapsuleMetadata: result.styleCapsuleMetadata  // ← ADD THIS
}));
```

---

## Expected Backend Logs After Fix

```bash
[API] LLM generation completed successfully!
[API] Prepared style capsule metadata for stage 4  ← New log

# Later, after stage state creation:
✅ Stage state inserted successfully: {stage_state_id}
✅ Logged style capsule application for stage 4: {application_id}  ← New log
```

---

## Testing Checklist

After completing remaining changes:

1. **Clear database** `style_capsule_applications` table (optional - for clean test)
2. **Create new project** with writing style capsule
3. **Generate Stage 2** (treatment)
   - Check backend logs for "Logged style capsule application for stage 2"
   - Check database for entry with correct `stage_state_id`
4. **Generate Stage 3** (beat sheet)
   - Check backend logs for "Logged style capsule application for stage 3"
   - Check database for entry
5. **Generate Stage 4** (master script)
   - Check backend logs for "Logged style capsule application for stage 4"
   - Check database for entry
6. **Verify database** has 3 entries (one per stage)

---

## Database Verification Query

```sql
SELECT 
  sca.id,
  ss.stage_number,
  ss.version,
  sc.name as capsule_name,
  sca.injection_context->>'stage' as logged_stage,
  sca.injection_context->>'traceId' as trace_id,
  sca.applied_at
FROM style_capsule_applications sca
JOIN stage_states ss ON ss.id = sca.stage_state_id
JOIN style_capsules sc ON sc.id = sca.style_capsule_id
WHERE ss.branch_id = '{your_branch_id}'
ORDER BY ss.stage_number, sca.applied_at;
```

---

## Summary

**Architecture Change**: Moved logging from LLM generation time → Stage state creation time

**Data Flow**: 
```
LLM Response (with metadata) 
  → Frontend Service (extracts) 
  → Component (stores temporarily) 
  → Stage State Service (passes to backend) 
  → Backend (logs to database)
```

**Files Modified**: 7 files  
**Files Remaining**: 3 files (beatService, scriptService, and their components)

