# Global Asset Image Upload & Generation - Testing Checklist

## Prerequisites

1. ✅ Backend server running: `cd backend && npm run dev`
2. ✅ Frontend server running: `cd . && npm run dev`
3. ✅ Database migration applied: `cd backend && npm run migrate` (or manually run `010_global_asset_image_generation.sql`)
4. ✅ At least one visual style capsule exists (for image generation)

---

## Test 1: Create Global Asset with Image Upload *

**Objective:** Verify users can upload images when creating new global assets.

**Steps:**
1. Navigate to Asset Library page
2. Click "New Asset" button
3. Fill in required fields:
   - Name: "Test Character"
   - Asset Type: Character
   - Description: "A test character for validation" (min 10 chars)
4. In the Image section:
   - Click the upload area or drag-and-drop an image file
   - Select a PNG, JPEG, or WebP image (under 10MB)
5. Verify image preview appears
6. Click "Create Asset"
7. Wait for upload to complete

**Expected Results:**
- ✅ Asset is created successfully
- ✅ Image is uploaded and preview displays
- ✅ Success toast appears
- ✅ Asset appears in library with image thumbnail
- ✅ Image URL is stored in `global_assets.image_key_url` (check database)

**Database Check:**
```sql
SELECT id, name, image_key_url, version FROM global_assets 
WHERE name = 'Test Character';
```
- `image_key_url` should contain a Supabase Storage URL
- `version` should be 1

---

## Test 2: Upload Image to Existing Global Asset

**Objective:** Verify users can add/update images for existing assets.

**Steps:**
1. Navigate to Asset Library
2. Find an existing asset without an image (or create one)
3. Click "Edit" on the asset
4. In the Image section:
   - Click upload area
   - Select an image file
5. Verify preview appears
6. Click "Update Asset"
7. Wait for upload

**Expected Results:**
- ✅ Asset is updated successfully
- ✅ Image is uploaded
- ✅ Success toast appears
- ✅ Asset version increments (check database)
- ✅ Image appears in asset library

**Database Check:**
```sql
SELECT version, image_key_url FROM global_assets 
WHERE id = '<asset_id>';
```
- `version` should increment
- `image_key_url` should be updated

---

## Test 3: Image Upload Validation

**Objective:** Verify file type and size validation works.

**Test Cases:**

**3a. Invalid File Type:**
1. Try to upload a `.txt` or `.pdf` file
2. Expected: Error toast "Invalid file type. Only PNG, JPEG, and WebP are allowed"

**3b. File Too Large:**
1. Try to upload an image larger than 10MB
2. Expected: Error toast "File too large. Image must be less than 10MB"

**3c. Valid File:**
1. Upload a valid PNG/JPEG/WebP under 10MB
2. Expected: Upload succeeds

---

## Test 4: Generate Image for Global Asset

**Objective:** Verify AI image generation works for global assets.

**Steps:**
1. Navigate to Asset Library
2. Create a new asset OR edit an existing one:
   - Name: "AI Generated Character"
   - Type: Character
   - Description: "A futuristic android with blue glowing eyes and silver metallic skin" (detailed description)
   - Image Prompt: (optional, can leave empty)
3. Click "Create Asset" (or "Update Asset" if editing)
4. After asset is saved, click "Generate Image with AI" button
5. Wait for generation to complete (may take 30-60 seconds)

**Expected Results:**
- ✅ "Image generation started" toast appears
- ✅ Button shows "Generating..." with spinner
- ✅ Job is created in `image_generation_jobs` table
- ✅ After completion, image preview appears
- ✅ Success toast "Image generated successfully"
- ✅ Asset version increments
- ✅ Image URL is stored in database

**Database Checks:**
```sql
-- Check job was created
SELECT id, status, prompt, asset_id, project_id 
FROM image_generation_jobs 
WHERE asset_id = '<asset_id>' 
ORDER BY created_at DESC LIMIT 1;
```
- `status` should be 'completed'
- `project_id` should be NULL (global asset)
- `asset_id` should match your asset

```sql
-- Check asset was updated
SELECT image_key_url, version FROM global_assets WHERE id = '<asset_id>';
```
- `image_key_url` should be populated
- `version` should increment

---

## Test 5: Generate Image with Visual Style

**Objective:** Verify visual style capsules are applied to generated images.

**Steps:**
1. Create/edit a global asset
2. Ensure asset has a `visual_style_capsule_id` set (or select one if editing)
3. Add a detailed description
4. Click "Generate Image with AI"
5. Wait for generation

**Expected Results:**
- ✅ Image is generated with style applied
- ✅ Visual style context is included in generation request
- ✅ Generated image reflects the style capsule characteristics

**Database Check:**
```sql
SELECT visual_style_capsule_id, prompt 
FROM image_generation_jobs 
WHERE asset_id = '<asset_id>' 
ORDER BY created_at DESC LIMIT 1;
```
- `visual_style_capsule_id` should match asset's style

---

## Test 6: Regenerate Image for Existing Asset

**Objective:** Verify users can regenerate images for assets that already have images.

**Steps:**
1. Navigate to Asset Library
2. Find an asset with an existing image
3. Click "Edit"
4. Optionally modify description or image prompt
5. Click "Regenerate Image" button
6. Wait for generation

**Expected Results:**
- ✅ New image is generated
- ✅ Old image is replaced
- ✅ Asset version increments
- ✅ New image URL is stored

---

## Test 7: Remove Image from Asset

**Objective:** Verify users can remove images (but asset must have description).

**Steps:**
1. Edit an asset with an image
2. Click the "X" button on the image preview
3. Verify image is removed from preview
4. Click "Update Asset"

**Expected Results:**
- ✅ Image preview is cleared
- ✅ Asset can be saved (description still exists)
- ✅ If description is also removed, validation should prevent save

---

## Test 8: Image Generation Job Polling

**Objective:** Verify job status polling works correctly.

**Steps:**
1. Start an image generation
2. Open browser DevTools → Network tab
3. Observe polling requests to `/api/images/jobs/{jobId}`
4. Verify requests happen every ~2 seconds
5. Wait for job completion

**Expected Results:**
- ✅ Polling requests are made every 2 seconds
- ✅ Job status updates from 'queued' → 'processing' → 'generating' → 'uploading' → 'completed'
- ✅ UI updates when job completes
- ✅ Polling stops after completion

---

## Test 9: Image Generation Timeout Handling

**Objective:** Verify timeout handling for long-running jobs.

**Steps:**
1. Start an image generation
2. Wait 2+ minutes (or modify timeout in code to test faster)
3. Observe behavior

**Expected Results:**
- ✅ After timeout, polling stops
- ✅ Timeout toast appears
- ✅ User can check job status manually later
- ✅ Job may still complete in background

---

## Test 10: Aspect Ratio Auto-Detection

**Objective:** Verify correct aspect ratios are used based on asset type.

**Test Cases:**

**10a. Character Asset:**
1. Create a character asset
2. Generate image
3. Expected: Image dimensions should be 512x768 (2:3 portrait)

**10b. Prop Asset:**
1. Create a prop asset
2. Generate image
3. Expected: Image dimensions should be 512x512 (1:1 square)

**10c. Location Asset:**
1. Create a location asset
2. Generate image
3. Expected: Image dimensions should be 1024x576 (16:9 landscape)

**Database Check:**
```sql
SELECT width, height, job_type 
FROM image_generation_jobs 
WHERE asset_id = '<asset_id>' 
ORDER BY created_at DESC LIMIT 1;
```

---

## Test 11: Storage Path Verification

**Objective:** Verify images are stored in correct locations.

**Steps:**
1. Upload or generate an image for a global asset
2. Check Supabase Storage bucket `asset-images`

**Expected Results:**
- ✅ Uploaded images: `asset-images/global/{userId}/{assetId}/{timestamp}_{random}.{ext}`
- ✅ Generated images: `asset-images/global/{userId}/{assetId}/{timestamp}_{random}.png`
- ✅ Images are publicly accessible via URL

**Storage Check:**
- Navigate to Supabase Dashboard → Storage → asset-images
- Verify folder structure: `global/{userId}/{assetId}/`
- Verify files exist and are accessible

---

## Test 12: Error Handling

**Objective:** Verify error handling for various failure scenarios.

**Test Cases:**

**12a. Network Error During Upload:**
1. Disconnect internet
2. Try to upload image
3. Expected: Error toast with helpful message

**12b. Invalid Asset ID:**
1. Try to upload to non-existent asset (modify API call)
2. Expected: 404 error with "Asset not found"

**12c. Generation Failure:**
1. Trigger a generation with invalid prompt (if possible)
2. Expected: Error toast, job marked as 'failed' in database

**12d. Storage Upload Failure:**
1. If storage quota exceeded or permissions issue
2. Expected: Error logged, job marked as failed

---

## Test 13: Concurrent Operations

**Objective:** Verify system handles multiple simultaneous operations.

**Steps:**
1. Open Asset Library in multiple tabs
2. Create/edit multiple assets simultaneously
3. Upload/generate images for different assets at the same time

**Expected Results:**
- ✅ No race conditions
- ✅ All operations complete successfully
- ✅ Asset versions increment correctly
- ✅ No duplicate images

---

## Test 14: Image Display in Asset Library

**Objective:** Verify images display correctly in the asset library gallery.

**Steps:**
1. Create several assets with images (mix of uploaded and generated)
2. Navigate to Asset Library
3. View assets in grid/list view

**Expected Results:**
- ✅ All images display as thumbnails
- ✅ Images load correctly
- ✅ No broken image icons
- ✅ Grid/list view toggle works
- ✅ Images maintain aspect ratio

---

## Test 15: Migration Verification

**Objective:** Verify database migration was applied correctly.

**Database Checks:**
```sql
-- Verify project_id and branch_id are nullable
SELECT column_name, is_nullable 
FROM information_schema.columns 
WHERE table_name = 'image_generation_jobs' 
AND column_name IN ('project_id', 'branch_id');
```
- Both should show `is_nullable = 'YES'`

```sql
-- Verify indexes exist
SELECT indexname FROM pg_indexes 
WHERE tablename = 'image_generation_jobs' 
AND indexname LIKE '%idempotency%';
```
- Should see both `idx_image_jobs_idempotency` and `idx_image_jobs_global_idempotency`

```sql
-- Verify RLS policy exists
SELECT policyname FROM pg_policies 
WHERE tablename = 'image_generation_jobs';
```
- Should see "Users can view own image generation jobs" policy

---

## Known Issues / Edge Cases to Watch

1. **Large Images:** Very large images may take longer to upload
2. **Generation Time:** AI generation can take 30-120 seconds depending on provider
3. **Network Issues:** Polling may fail if network is unstable
4. **Storage Quota:** Ensure Supabase storage has sufficient space
5. **Concurrent Jobs:** Multiple simultaneous generations may queue

---

## Success Criteria

All tests should pass with:
- ✅ No console errors
- ✅ No database constraint violations
- ✅ Images stored correctly in Supabase Storage
- ✅ Asset versions increment properly
- ✅ UI provides clear feedback at all stages
- ✅ Error messages are helpful and actionable

---

## Rollback Plan

If issues are found:
1. Revert code changes
2. Rollback migration: `ALTER TABLE image_generation_jobs ALTER COLUMN project_id SET NOT NULL;`
3. Delete test assets and images from storage
4. Review error logs for root cause
