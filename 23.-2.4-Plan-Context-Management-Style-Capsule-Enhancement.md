# Context Management & Style Capsule Enhancement Implementation Plan

## Current State Analysis

### ✅ Already Working

- Style capsule injection in backend (`backend/src/routes/llm.ts` lines 190-241)
- Frontend services pass `writing_style_capsule_id` (treatmentService, beatService, scriptService)
- Database schema includes `style_capsule_applications` table
- Prompt templates support `{writing_style_context}` variable
- `StyleCapsuleService.formatWritingStyleInjection()` method exists

### ❓ Needs Verification

- Stage 4 script generation style injection completeness
- Capsule ID persistence across Stage 1 → Stage 2 → Stage 3 → Stage 4
- Context assembly is scattered across services (not centralized)

---

## Feature 2.3: Context Management System

### Phase 1: Create Context Manager Service (Core Architecture)

**File**: `backend/src/services/contextManager.ts` (NEW)

Create a centralized service that assembles and manages context for LLM calls:

```typescript
export interface GlobalContext {
  projectParams: ProjectParams;
  beatSheet?: Beat[];
  masterScriptSummary?: string;
  writingStyleCapsule?: StyleCapsule;
  visualStyleCapsule?: StyleCapsule;
}

export interface LocalContext {
  sceneScript?: string;
  previousSceneEndState?: string;
  sceneAssets?: SceneAssetInstance[];
}

export class ContextManager {
  // Assembles global context for Phase A stages
  assembleGlobalContext(projectId: string, branchId: string): Promise<GlobalContext>
  
  // Prepares context for specific stage
  prepareStageContext(stageNumber: number, globalContext: GlobalContext): Promise<StageContext>
  
  // Estimates token count for context
  estimateContextSize(context: any): number
  
  // Formats context for LLM injection
  formatForInjection(context: GlobalContext): string
}
```

**Key Responsibilities**:

- Fetch beat sheet from database when needed
- Fetch master script and generate summary
- Load style capsules and format them
- Combine all context layers deterministically
- Monitor token counts

---

### Phase 2: Implement Global Context Assembly

**Files to Modify**:

1. `backend/src/services/contextManager.ts` - Implement `assembleGlobalContext()`
2. `backend/src/routes/llm.ts` - Integrate context manager

**Implementation Steps**:

1. **Beat Sheet Context** - Query `stage_states` table for Stage 3 content:
```typescript
const beatSheetState = await db.query(`
  SELECT content FROM stage_states 
  WHERE branch_id = $1 AND stage_number = 3 AND status = 'locked'
  ORDER BY version DESC LIMIT 1
`);
const beats = beatSheetState.content.beats;
```

2. **Master Script Summary** - Query Stage 4, generate concise summary:
```typescript
const scriptState = await db.query(`
  SELECT content FROM stage_states 
  WHERE branch_id = $1 AND stage_number = 4 AND status = 'locked'
  ORDER BY version DESC LIMIT 1
`);
// Generate summary using LLM or extract key scenes
```

3. **Style Capsule Context** - Fetch and format capsules:
```typescript
const project = await getProject(projectId);
if (project.writing_style_capsule_id) {
  const capsule = await styleCapsuleService.getCapsuleById(
    project.writing_style_capsule_id, 
    userId
  );
  globalContext.writingStyleCapsule = capsule;
}
```


---

### Phase 3: Local Context Windowing (Structure Only)

**File**: `backend/src/services/contextManager.ts`

Implement placeholder structure for Phase B local context:

```typescript
export class ContextManager {
  // Returns empty for Phase A, but structure ready for Phase B
  assembleLocalContext(
    sceneId: string, 
    globalContext: GlobalContext
  ): Promise<LocalContext> {
    // TODO: Phase B implementation
    // - Fetch current scene script
    // - Fetch previous scene end state
    // - Fetch scene asset instances
    return Promise.resolve({});
  }
  
  // Combines global + local for complete context
  assembleFullContext(
    globalContext: GlobalContext,
    localContext: LocalContext
  ): FullContext {
    return {
      global: globalContext,
      local: localContext,
      combinedPromptSection: this.formatForInjection(globalContext)
    };
  }
}
```

---

### Phase 4: Integrate Context Manager into LLM Route

**File**: `backend/src/routes/llm.ts`

Refactor `/generate-from-template` endpoint to use Context Manager:

**Current approach** (lines 190-241):

- Manually checks for `writing_style_capsule_id`
- Fetches capsule inline
- Injects into variables

**New approach**:

```typescript
// After template validation (line 189)
const contextManager = new ContextManager();

// Assemble global context if projectId/branchId in metadata
if (validatedRequest.metadata?.projectId && validatedRequest.metadata?.branchId) {
  const globalContext = await contextManager.assembleGlobalContext(
    validatedRequest.metadata.projectId,
    validatedRequest.metadata.branchId
  );
  
  // Inject writing style context
  if (globalContext.writingStyleCapsule) {
    validatedRequest.variables.writing_style_context = 
      styleCapsuleService.formatWritingStyleInjection(globalContext.writingStyleCapsule);
  }
  
  // Add beat sheet context if available
  if (globalContext.beatSheet) {
    validatedRequest.variables.beat_sheet_context = 
      contextManager.formatBeatSheet(globalContext.beatSheet);
  }
}
```

---

## Feature 2.4: Style Capsule-Enhanced Generation

### Phase 5: Verify Stage 2 Prompt Injection (Already Working)

**Files to Check**:

- `src/lib/services/treatmentService.ts` (lines 50-74)
- `backend/src/routes/llm.ts` (lines 190-241)
- Prompt template: `treatment_expansion` system_prompt

**Verification Tasks**:

1. Confirm `writingStyleCapsuleId` is passed from Stage 1 → treatmentService
2. Test that backend fetches capsule and injects formatted context
3. Review LangSmith traces to confirm style context appears in prompts

---

### Phase 6: Ensure Stage 3 & 4 Style Injection

**Stage 3 (Beat Sheet)**:

- File: `src/lib/services/beatService.ts`
- Line 54: Already passes `writing_style_capsule_id`
- ✅ Verify backend handles it correctly

**Stage 4 (Master Script)**:

- File: `src/lib/services/scriptService.ts`
- Lines 69-70: Already includes `writing_style_capsule_id`
- ✅ Verify prompt template `master_script_generation` uses `{writing_style_context}`

**Action**: Run test generations and check network tab for proper injection.

---

### Phase 7: Deterministic Capsule Persistence

**Goal**: Ensure capsule selected at Stage 1 flows through all stages without re-selection.

**Implementation**:

1. **Stage 1 Storage** - Verify `Stage1InputMode.tsx` saves capsule ID:
```typescript
// File: src/components/pipeline/Stage1InputMode.tsx
// Should save writing_style_capsule_id to stage_states.content or projects table
```

2. **Stage 2 Retrieval** - Verify `Stage2Treatment.tsx` reads from Stage 1:
```typescript
const stage1State = useProjectStore(state => 
  state.stages.find(s => s.stageNumber === 1)
);
const writingStyleCapsuleId = stage1State?.content?.projectParams?.writingStyleCapsuleId;
```

3. **Stage 3 & 4 Propagation** - Ensure `projectParams` object carries capsule ID:
```typescript
// Should be included in all service calls
const projectParams = {
  ...otherParams,
  writingStyleCapsuleId: stage1State.content.projectParams.writingStyleCapsuleId
};
```


**Files to Check/Modify**:

- `src/components/pipeline/Stage1InputMode.tsx`
- `src/components/pipeline/Stage2Treatment.tsx`
- `src/components/pipeline/Stage3BeatSheet.tsx`
- `src/components/pipeline/Stage4MasterScript.tsx`

---

### Phase 8: Style Capsule Application Logging (End Priority)

**Purpose**: Audit trail for debugging and transparency.

**File**: `backend/src/services/styleCapsuleService.ts` (method already exists at line 397)

**Integration Points**:

1. **After successful generation in `/generate-from-template`**:
```typescript
// backend/src/routes/llm.ts (after line 267)
if (validatedRequest.metadata?.stageStateId && 
    globalContext?.writingStyleCapsule) {
  await styleCapsuleService.recordApplication({
    stage_state_id: validatedRequest.metadata.stageStateId,
    style_capsule_id: globalContext.writingStyleCapsule.id,
    injection_context: {
      stage: validatedRequest.metadata.stage,
      templateName: validatedRequest.templateName,
      formattedContextLength: writingStyleContext.length,
      timestamp: new Date().toISOString()
    }
  });
}
```

2. **Frontend must pass `stageStateId` in metadata**:
```typescript
// src/lib/services/treatmentService.ts (line 76)
metadata: {
  projectId: request.projectId,
  stageStateId: currentStageState.id, // ADD THIS
  stage: 2,
  inputMode: request.processedInput.mode
}
```


---

## Testing & Validation

### Manual Test Flow

1. **Create new project** with writing style capsule selected at Stage 1
2. **Generate treatments** (Stage 2) → Verify capsule appears in network request
3. **Generate beat sheet** (Stage 3) → Verify same capsule is used
4. **Generate master script** (Stage 4) → Verify same capsule is used
5. **Check database** → Verify `style_capsule_applications` has 3 entries (one per stage)

### Verification Queries

```sql
-- Check style capsule persistence across stages
SELECT 
  ss.stage_number,
  ss.status,
  sca.style_capsule_id,
  sc.name as capsule_name,
  sca.injection_context
FROM stage_states ss
LEFT JOIN style_capsule_applications sca ON sca.stage_state_id = ss.id
LEFT JOIN style_capsules sc ON sc.id = sca.style_capsule_id
WHERE ss.branch_id = '{branchId}'
ORDER BY ss.stage_number;
```

---

## Summary of Key Files

### New Files

- `backend/src/services/contextManager.ts` - Core context management service

### Modified Files

- `backend/src/routes/llm.ts` - Integrate context manager
- `src/components/pipeline/Stage1InputMode.tsx` - Verify capsule ID persistence
- `src/components/pipeline/Stage2Treatment.tsx` - Pass stageStateId to backend
- `src/components/pipeline/Stage3BeatSheet.tsx` - Pass stageStateId to backend
- `src/components/pipeline/Stage4MasterScript.tsx` - Pass stageStateId to backend
- `src/lib/services/treatmentService.ts` - Add stageStateId to metadata
- `src/lib/services/beatService.ts` - Add stageStateId to metadata
- `src/lib/services/scriptService.ts` - Add stageStateId to metadata

### Files to Verify (No Changes Expected)

- `backend/src/services/styleCapsuleService.ts` - Already has required methods
- `backend/scripts/seed-templates.ts` - Templates already support `{writing_style_context}`