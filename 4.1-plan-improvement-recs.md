
Your implementation plan for **Feature 4.1: Scene Extraction & Parsing** is technically sound in its parsing and data alignment tasks but, as you correctly identified, it contains a significant architectural risk regarding **when** and **how** extraction is triggered.

Here is a detailed analysis based on your provided documents, specifically the `project-overview.md` and `database-schema-state-transition-matrix.md`.

### **1. Analysis of Your Concerns (Timing & Task 7)**

Your intuition is correct: **extracting scenes after every single edit is a high-risk approach.**

* **The Conflict:** The "Immutability by Default" principle states that completed stages are never mutated. If you auto-extract and overwrite the `scenes` table on every edit, you will cause "Deterministic Invalidation" to trigger constantly.
* **The Solution (The "Gate" Approach):** Scene extraction should be treated as a **transactional gate** rather than a continuous background process.
* **Draft Phase:** While the user is in Stage 4, the extraction can happen in-memory or be saved to the `stage_states.content.scenes` JSONB field for preview.
* **Commit Phase:** Only when the user clicks **"Approve Script"** or **"Proceed to Stage 5"** should the data be persisted into the primary `scenes` table.


* **Task 7 Interpretation:** Your plan's Task 7 ("Ensure scenes are extracted even if script is manually edited") should be reframed as: *"Ensure the extraction engine can handle manual formatting quirks, but only commit those results to the production database when Stage 4 is locked."*

### **2. What is Solid and Well-Designed?**

* **Type Alignment:** Task 1's focus on aligning TypeScript enums with the database (e.g., `shot_list_ready`) is critical for preventing runtime crashes during Phase B.
* **Enhanced Parsing:** Adding DAY/NIGHT and descriptive slugs is a high-value improvement. This data is essential for **Stage 7 (Technical Shot List)** and **Stage 10 (Frame Generation)** to ensure the AI understands the lighting and environment context.
* **Sequential Numbering:** Ensuring stable scene numbers (1, 2, 3...) is vital for the "Scene-Local Context" management required in Phase B.

### **3. Key Flaws and Risks (Critical)**

* **Scene ID Stability (The "Identity Crisis"):**
* **Risk:** If a user edits Stage 4, re-runs extraction, and the engine generates new UUIDs for every scene, all downstream progress in Stages 6â€“12 (shot lists, generated frames, videos) will be orphaned because their `scene_id` references will no longer exist.
* **Recommendation:** Implement a "diff and match" logic. If a scene slug matches an existing one, retain the original `scene_id` to preserve downstream work wherever possible.


* **Branching Logic Ambiguity:**
* **Risk:** The plan doesn't explicitly check for the "Active Branch" state.
* **Requirement:** If the user is editing a "Locked" Stage 4 that already has downstream Phase B data, the system **must** force the creation of a new branch before allowing the re-extraction to overwrite any scene data.



### **4. Medium / Low-Level Design Gaps**


* **Slug Uniqueness:** The plan mentions `generateSlug()` but doesn't specify how to handle two different scenes at the same location (e.g., `INT. KITCHEN - DAY` appearing twice). You need a unique identifier (Slug + Scene Number) to prevent collisions in the Script Hub.

### **Alignment with Project Vision**

Your plan aligns well with the **"Global-to-Local"** architecture by ensuring the "Global Narrative" (Stage 4) is correctly atomized for "Local Context" (Stage 6+).

**Suggested Task 7 Revision for your Plan:**

> **Task 7: Stage 4/5 Transition Logic**
> * Add "Preview Scenes" button in Stage 4 UI.
> * Implement "Lock & Extract" trigger that only populates the `scenes` table when the user moves to Stage 5.
> * Add a "Downstream Impact Warning" if the user attempts to re-extract scenes after Phase B has already begun.
>  *
> 

Does this "Gate" approach solve your concerns about the versioning/branching conflicts?

lastly, the plan address the functionality of stage 5 (like does it use extracted assets) Or is that better to wait to worry about use for the future phase-4 tasks