# Feature 4.2 - Option B Implementation Changes Summary

## Executive Summary

The 4.2 plan has been updated to implement **Option B: Extract at Scene Parsing Time** instead of extracting dependencies at Stage 6. This architectural change consolidates extraction work, improves performance, and simplifies the codebase.

## What Changed

### Original Plan (Before)
1. Scene dependencies extracted at Stage 6 when viewing Script Hub
2. Cache-first approach with parallel extraction (5 concurrent)
3. Fuzzy matching against Stage 5 master assets
4. Stage 5 extracts from full master script independently
5. Complex cache invalidation logic

### New Plan (Implementing now)
1. Scene dependencies ex-tracted at Stage 4 during scene parsing
2. Dependencies stored immediately with scenes
3. No fuzzy matching at extraction time (raw names only)
4. Stage 5 aggregates dependencies from scene records
5. No cache invalidation needed (scenes replaced entirely on re-extraction)

## Architectural Flow Comparison

### Before (Original Plan)
```
Stage 4: Extract Scenes → scenes table (no dependencies)
Stage 5: Extract Assets from full script → project_assets
Stage 6: Extract Dependencies per scene (with caching) → display
```

### After (Option B)
```
Stage 4: Extract Scenes + Dependencies → scenes table (with dependencies)
Stage 5: Aggregate Dependencies from scenes → project_assets
Stage 6: Read cached dependencies → display (instant)
```

## Benefits

1. **50% reduction in LLM calls** - Extract once, use twice (Stage 5 + Stage 6)
2. **Stage 6 instant loads** - <500ms (no LLM calls)
3. **Simpler codebase** - No cache invalidation logic
4. **Single source of truth** - Dependencies always in sync
5. **Lower cost** - Fewer API calls

## Trade-offs

1. **Stage 4 takes longer** - ~10-20s for 20 scenes (one-time cost)
2. **Stage 5 refactor required** - Existing implementation needs updates
3. **More implementation work upfront** - 9-12 hours vs 5-8 hours

## Files Modified

### New Architecture Sections
- Architecture Overview - Updated diagram showing Stage 4 extraction
- Implementation Tasks - Reordered and restructured
- Performance section - Updated to reflect Option B benefits

### Task Changes

**Task 1 (Migration):**
- ✅ Already completed (migration 011)
- Removed cache invalidation complexity

**Task 2 (Extraction Service):**
- Simplified - No fuzzy matching
- Integrated into Stage 4, not Stage 6
- New Task 2B: Frontend integration into scriptService.extractScenes()
- New Task 2C: Backend persistence in PUT /scenes endpoint

**Task 3 (Continuity Analyzer):**
- Unchanged (still rule-based, fast)

**New Task 3B (Stage 5 Refactor):**
- Aggregate scene dependencies instead of re-extracting from full script
- Replace Pass 1 with scene aggregation
- Keep Pass 2 (distillation) unchanged

**Task 4 (Backend Endpoint):**
- Simplified - Remove extraction logic
- Keep only continuity analysis
- No more parallel extraction with concurrency limits

**Tasks 5-9:**
- Mostly unchanged (frontend updates, testing)
- Updated testing criteria to reflect new flow

## Implementation Order Changes

### Before
1. Database migration
2. Extraction service + Risk analyzer (parallel)
3. Backend endpoint with caching
4. Frontend updates
5. Testing

### After
1. Database migration (✅ done)
2. Extraction service + Stage 4 integration (parallel)
3. Stage 5 refactor
4. Stage 6 simplification
5. Frontend updates
6. Testing

## Performance Impact

### Before (Original Plan)
- First load: 8-10s (5 concurrent extractions)
- Cached load: <500ms
- Stage 4→5 transition: Instant scene extraction

### After (Option B)
- All loads: <500ms (no LLM calls at Stage 6)
- Stage 4→5 transition: ~10-20s (includes dependency extraction)
- Net benefit: Slower once vs slower repeatedly

## Backwards Compatibility

**Existing projects:**
- Scenes created before this feature will have NULL dependencies
- Stage 6 displays empty dependencies (graceful degradation)
- User can re-extract scenes at Stage 4 to populate dependencies
- Existing assets remain valid (no data loss)

**No breaking changes:**
- All existing functionality continues to work
- New extraction method is opt-in (via scene re-extraction)

## Testing Changes

### New Test Scenarios
1. Stage 4: Extract scenes with dependencies (verify LLM calls)
2. Stage 5: Aggregate dependencies (verify no full-script re-extraction)
3. Stage 6: Instant load (verify no LLM calls)
4. Backwards compatibility: Scenes without dependencies

### Updated Performance Metrics
- Stage 6 load time: <500ms (was 8-10s first load, <500ms cached)
- Stage 4 extraction time: ~10-20s for 20 scenes (was instant)

## Documentation Updates

All plan sections updated to reflect Option B:
- Architecture Overview
- Current State Analysis
- All Task descriptions
- Acceptance Criteria
- Performance Optimization section
- LLM Cost Estimates
- Cache Invalidation Strategy (now Dependency Update Strategy)
- Files to Create/Modify
- Implementation Order
- Quick Start Guide
- Key Differences section

## Next Steps

1. Review this summary
2. Approve Option B approach
3. Begin implementation following updated 4.2-plan-v1.md
4. Start with Phase 2 (extraction service + Stage 4 integration)

## Questions to Consider

1. Is the 10-20s Stage 4 extraction time acceptable for a one-time operation?
2. Should we add a progress indicator during Stage 4 extraction?
3. Do we need a backfill migration for existing projects, or is manual re-extraction acceptable?
4. Should Stage 5 warn if scenes are missing dependencies?

---

**Status:** Plan updated and ready for implementation
**Estimated Time:** 9-12 hours
**Confidence:** High - Architecture is simpler and more maintainable
