# Testing the Shot Extraction & Shot CRUD API (Stage 7)

This guide covers how to test the shot extraction service and shot CRUD endpoints implemented for Task 1 & 2 (4.3 plan).

---

## 1. Unit tests (no API keys, no DB)

Run the shot-related Jest tests. They mock the LLM client so no real API calls are made.

```bash
cd "C:\Users\Daniel Lopez\Desktop\Aiuteur\wizardirector\backend"
npx jest src/tests/shotExtraction.test.ts --testTimeout=10000 --forceExit
```

- **`--forceExit`** avoids Jest hanging if async handles remain (e.g. from mocks).
- Tests cover:
  - **generateShotId**: 1A/1B/1C, 3A/3B, and >26 shots (1AA, 1AB).
  - **ShotExtractionService**: parsing LLM JSON, validation (invalid shots discarded), timeout → empty array.
  - **ShotSplitService**: two shots returned with server-generated IDs `{originalId}-1` and `{originalId}-2`.

To run all backend tests (including shot tests):

```bash
cd "C:\Users\Daniel Lopez\Desktop\Aiuteur\wizardirector\backend"
npm run test
```

---

## 2. Manual API testing (real backend + auth)

You need a **Supabase JWT** for the `Authorization` header. Options:

- **A) From the frontend**: Log in, then in DevTools → Application → Local Storage (or Network tab on any API request) copy the Supabase access token.
- **B) From Supabase Dashboard**: Authentication → Users → create or pick a user; use “Generate JWT” or sign in via the API to get a token.
- **C) From a small script**: Use `@supabase/supabase-js` `signInWithPassword` and use `session.access_token`.

Set:

```bash
set TOKEN=your-supabase-jwt-here
```

Start the backend:

```bash
cd "C:\Users\Daniel Lopez\Desktop\Aiuteur\wizardirector\backend"
npm run dev
```

Use a **real project ID** and **scene ID** from your DB (e.g. from Supabase Table Editor: `projects`, then `scenes` for that project).

### GET shots for a scene

```bash
curl -s -H "Authorization: Bearer %TOKEN%" "http://localhost:3001/api/projects/YOUR_PROJECT_ID/scenes/YOUR_SCENE_ID/shots"
```

### POST extract shots (LLM call)

Requires a scene that has `script_excerpt` and belongs to the project’s active branch. Needs `GOOGLE_AI_API_KEY` and `LANGSMITH_API_KEY` in `backend/.env`.

```bash
curl -s -X POST -H "Authorization: Bearer %TOKEN%" -H "Content-Type: application/json" "http://localhost:3001/api/projects/YOUR_PROJECT_ID/scenes/YOUR_SCENE_ID/shots/extract"
```

### PUT update one shot

`SHOT_ID` is the shot’s **UUID** (column `id`), not the human-readable `shot_id` (e.g. "1A").

```bash
curl -s -X PUT -H "Authorization: Bearer %TOKEN%" -H "Content-Type: application/json" -d "{\"action\":\"Updated action.\"}" "http://localhost:3001/api/projects/YOUR_PROJECT_ID/scenes/YOUR_SCENE_ID/shots/SHOT_UUID"
```

### POST split a shot

`SHOT_ID` = shot UUID. Optional body: `{"userGuidance":"Split when he sits down"}`.

```bash
curl -s -X POST -H "Authorization: Bearer %TOKEN%" -H "Content-Type: application/json" -d "{\"userGuidance\":\"Split at the dialogue.\"}" "http://localhost:3001/api/projects/YOUR_PROJECT_ID/scenes/YOUR_SCENE_ID/shots/SHOT_UUID/split"
```

### PUT reorder shots

Body: `{"orderedShotIds":["uuid1","uuid2","uuid3"]}` (array of shot UUIDs in desired order).

```bash
curl -s -X PUT -H "Authorization: Bearer %TOKEN%" -H "Content-Type: application/json" -d "{\"orderedShotIds\":[\"UUID1\",\"UUID2\"]}" "http://localhost:3001/api/projects/YOUR_PROJECT_ID/scenes/YOUR_SCENE_ID/shots/reorder"
```

### DELETE a shot

```bash
curl -s -X DELETE -H "Authorization: Bearer %TOKEN%" "http://localhost:3001/api/projects/YOUR_PROJECT_ID/scenes/YOUR_SCENE_ID/shots/SHOT_UUID"
```

---

## 3. Frontend (Stage 7 UI)

When the Stage 7 shot list UI is wired to these endpoints:

1. Open a project that has at least one scene with script content.
2. Go to Stage 7 (Shot List) and select a scene.
3. Use “Extract shots” to call `POST .../shots/extract` and display the returned shots.
4. Edit a field and save (PUT shot), split a shot (POST split), delete (DELETE), or reorder (PUT reorder).

---

## 4. Checklist

| What | How |
|------|-----|
| Shot ID generation | `npx jest src/tests/shotExtraction.test.ts` → `generateShotId` tests |
| Extraction parsing & validation | Same file → `ShotExtractionService` tests |
| Split service output | Same file → `ShotSplitService` test |
| GET/POST/PUT/DELETE shots | Manual: backend running, valid JWT, real project/scene/shot IDs |
| Extract with LLM | Manual: same + `GOOGLE_AI_API_KEY`; triggers real LLM call |
