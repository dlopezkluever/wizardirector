# Feature 3.4: Project-Level Assets - Implementation Plan

## Overview

Complete the project-level asset management system by implementing inheritance from global library, creating a reusable asset drawer UI component, integrating promotion workflows, and building a versioning system for tracking asset changes.

## Current State Analysis

**Already Implemented:**

- `project_assets` table with `global_asset_id` and `source_version` fields (migration 008)
- Backend promotion endpoint: `POST /api/projects/:projectId/assets/:assetId/promote`
- Frontend promotion service method: `projectAssetService.promoteToGlobal()`
- Basic CRUD operations for project assets

**Missing Components:**

- Backend endpoint to clone/inherit global assets into projects
- Asset drawer UI component for browsing and cloning global assets
- Version sync detection and update notifications
- Integration with Stage 5 and Stage 8 workflows

## Implementation Tasks

### 1. Backend: Asset Inheritance Endpoint

**File:** `backend/src/routes/projectAssets.ts`

Add new endpoint:

```typescript
POST /api/projects/:projectId/assets/clone-from-global
```

**Functionality:**

- Accept `globalAssetId`, optional `overrideDescription`, and optional `target_branch_id` in request body
- If `target_branch_id` not provided, use project's `active_branch_id`
- **Branch Validation**: Verify `target_branch_id` belongs to `projectId` and user has write access
- Fetch global asset from `global_assets` table
- **Visual Style Inheritance**: Automatically fetch the `visual_style_capsule_id` from the latest Stage 5 `stage_states` for the target branch and assign it to the new project asset
- **Image Localization** (see Task 11): Copy image from global storage to project-specific storage path
- Create new `project_asset` with:
  - `branch_id` set to `target_branch_id` (CRITICAL: ensures branch isolation)
  - `global_asset_id` set to source asset
  - `source_version` set to global asset's current version
  - All fields copied from global asset (name, type, description, image_key_url, etc.)
  - `visual_style_capsule_id` from branch's Stage 5 state (ensures style consistency)
- Return created project asset

**Error Handling:**

- Validate global asset exists and belongs to user
- Validate branch belongs to project and user has access
- Check for duplicate asset names in project (warn but allow)
- Handle missing image_key_url gracefully (allow cloning without image)

### 2. Frontend: Asset Inheritance Service Method

**File:** `src/lib/services/projectAssetService.ts`

Add method:

```typescript
async cloneFromGlobal(
  projectId: string, 
  globalAssetId: string, 
  overrideDescription?: string
): Promise<ProjectAsset>
```

**Implementation:**

- Call new backend endpoint
- Handle authentication
- Return created project asset
- Throw descriptive errors for validation failures

### 3. Frontend: Asset Drawer Component

**File:** `src/components/pipeline/AssetDrawer.tsx`

**Purpose:** Reusable drawer component for browsing global assets and cloning them into projects. Used in Stage 5 and Stage 8.

**Features:**

- Slide-out drawer from right side of screen
- Search and filter by asset type (character, prop, location)
- Grid/list view toggle
- Asset cards showing:
  - Thumbnail (if image_key_url exists)
  - Asset name and type badge
  - Description preview
  - "Clone to Project" button
- Loading states and empty states
- Integration with `assetService.listAssets()` for global assets
- Integration with `projectAssetService.cloneFromGlobal()` for cloning

**Props Interface:**

```typescript
interface AssetDrawerProps {
  projectId: string;
  isOpen: boolean;
  onClose: () => void;
  onAssetCloned?: (asset: ProjectAsset) => void;
  filterType?: AssetType; // Optional type filter
}
```

**UI/UX:**

- Use shadcn/ui Drawer component
- Responsive design (mobile-friendly)
- Smooth animations with framer-motion
- Toast notifications on clone success/failure

### 4. Frontend: Version Sync Detection

**File:** `src/lib/services/projectAssetService.ts`

Add method:

```typescript
async checkVersionSync(projectId: string): Promise<{
  outdated: Array<{
    projectAssetId: string;
    globalAssetId: string;
    projectVersion: number;
    globalVersion: number;
    globalAssetName: string;
  }>;
}>
```

**Implementation:**

- Query all project assets with `global_asset_id` set
- For each, fetch corresponding global asset
- Compare `source_version` (project) vs `version` (global)
- Return list of outdated assets

**Backend Endpoint (Optional):**

```typescript
GET /api/projects/:projectId/assets/version-sync-status
```

### 5. Frontend: Version Sync UI Component

**File:** `src/components/pipeline/AssetVersionSync.tsx`

**Purpose:** Display version sync status and allow users to update project assets from global sources.

**Features:**

- Badge/indicator showing count of outdated assets
- Modal/drawer showing list of outdated assets
- For each outdated asset:
  - Show current vs latest version numbers
  - Show what changed (description, image, etc.)
  - "Update from Global" button
  - Preview of changes
- Bulk update option

**Integration:**

- Call `checkVersionSync()` on component mount
- Poll periodically or refresh on asset drawer open
- Update project asset when user clicks "Update from Global"

### 6. Backend: Update from Global Endpoint

**File:** `backend/src/routes/projectAssets.ts`

Add endpoint:

```typescript
POST /api/projects/:projectId/assets/:assetId/sync-from-global
```

**Functionality:**

- Verify project asset has `global_asset_id`
- Fetch latest global asset version
- Update project asset fields (description, image_key_url, etc.)
- Update `source_version` to match global asset version
- Preserve project-specific overrides (if any)
- Return updated project asset

**Validation:**

- Asset must not be locked
- Global asset must still exist
- User must own both project and global asset

### 7. Frontend: Promotion UI Integration

**File:** `src/components/pipeline/Stage5Assets.tsx`

**Enhancements:**

- Add "Promote to Global" button to asset card actions menu (if not already present)
- Show promotion status indicator (badge if already promoted)
- After successful promotion, update UI to show link to global asset
- Add confirmation dialog before promotion

**Current State Check:**

- Verify `promoteToGlobal()` is already called from asset actions
- If missing, add to dropdown menu in asset card

### 8. Frontend: Asset Drawer Integration

**Integration Points:**

**Stage 5 (`Stage5Assets.tsx`):**

- Add "Browse Global Library" button
- Open AssetDrawer when clicked
- On asset cloned, refresh asset list and show success message
- Allow cloning before or after extraction

**Stage 8 (Future - `Stage8VisualDefinition.tsx`):**

- Asset drawer should be available here per PRD Section 9.3
- Allow dragging assets into scene
- This is a placeholder for future Stage 8 implementation

### 9. Database: Version Tracking Enhancement

**Migration:** `backend/migrations/009_asset_versioning.sql` (if needed)

**Potential Additions:**

- Add `last_synced_at` timestamp to `project_assets` for tracking
- Add `sync_conflicts` JSONB field for tracking manual overrides
- Consider adding `asset_history` table for audit trail (optional, future enhancement)

**Note:** Current schema may be sufficient. Review after implementation.

### 10. Type Definitions Update

**File:** `src/types/asset.ts`

**Additions:**

```typescript
export interface AssetVersionStatus {
  projectAssetId: string;
  globalAssetId: string;
  projectVersion: number;
  globalVersion: number;
  isOutdated: boolean;
  globalAssetName: string;
}

export interface CloneAssetRequest {
  globalAssetId: string;
  overrideDescription?: string;
}
```

### 11. Backend/Storage: Asset Image Localizer
- Purpose: Decouple project assets from the Global Library storage to prevent broken links if global assets are deleted.

- Functionality: Create a utility function localizeAssetImage(sourceUrl, targetProjectId).

- Action: Copies the image file from the global-assets bucket/folder to the project-assets/{projectId}/ folder.

- Update: Returns the new image_key_url to be saved in the project_assets table.

## Implementation Order

Task 11: Asset Image Localizer (Utility) — [NEW #1] Create the backend helper to copy images between buckets/folders. This is the functional prerequisite for cloning and syncing.

Task 10: Type Definitions — [MOVE UP] Define AssetVersionStatus, CloneAssetRequest, etc., so your IDE provides autocomplete and safety while you build the logic.

Task 1: Backend inheritance endpoint — Uses the Task 11 utility and Task 10 types to create the actual cloning route.

Task 2: Frontend service method — Bridges the new backend route to the UI.

Task 3: Asset drawer component — Build the UI that will eventually trigger the service.

Task 4: Version sync detection (Backend/Service logic) — The logic to find "out of sync" assets.

Task 5: Version sync UI — The visual indicator and modal for updates.

Task 6: Update from global endpoint — The backend "Sync" action (also uses Task 11 utility).

Task 7: Promotion UI integration — Polish the existing promotion workflow.

Task 8: Stage 5 integration — Plug the Asset Drawer into the actual production pipeline.

Task 9: Database enhancements — Final cleanup or optional tracking fields (e.g., last_synced_at) based on testing results.

## Testing Considerations

- Test cloning asset with and without image_key_url
- Test version sync detection with multiple outdated assets
- Test promotion workflow end-to-end
- Test asset drawer search and filtering
- Test error handling for deleted global assets
- Test concurrent updates (user updates global while project has cloned version)

## Success Criteria

- Users can browse global assets in a drawer UI
- Users can clone global assets into projects with one click
- System tracks version differences between global and project assets
- Users can sync project assets with updated global versions
- Promotion workflow is visible and functional in Stage 5
- All operations respect locked asset constraints
- UI provides clear feedback for all operations
- Non-Destructive Branching: Verified (Task 1 includes branch_id).
- Global-to-Local Inheritance: Verified (Task 1 handles cloning/localization).
- Deterministic Continuity: Verified (Task 6 handles version syncing without destroying local edits).

## Future Enhancements (Out of Scope)

- Bulk clone operations
- Asset templates/categories
- Asset sharing between users
- Advanced conflict resolution for manual overrides
- Asset history/audit trail
- Scene-level asset inheritance (Stage 8)