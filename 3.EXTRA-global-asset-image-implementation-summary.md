# Global Asset Image Upload & Generation - Implementation Summary

## Overview

Implemented image upload and AI generation capabilities for global assets, enabling users to add visual references to their reusable asset library.

## What Was Implemented

### 1. Global Asset Image Upload
**Why:** Users need to upload existing images (e.g., character designs, prop photos) to their global asset library for reuse across projects.

**Implementation:**
- Backend endpoint: `POST /api/assets/:id/upload-image`
- Multer middleware for file handling (PNG, JPEG, WebP, max 10MB)
- Stores images in `asset-images/global/{userId}/{assetId}/` path
- Updates `global_assets.image_key_url` and increments version
- Frontend: Drag-and-drop upload UI in `AssetDialog.tsx`

### 2. Global Asset Image Generation
**Why:** Users may not have images ready but want AI-generated visual references based on asset descriptions.

**Implementation:**
- Backend endpoint: `POST /api/assets/:id/generate-image`
- New service method: `ImageGenerationService.createGlobalAssetImageJob()`
- Uses Nano Banana API with type-specific aspect ratios (character: 512x768, prop: 512x512, location: 1024x576)
- Stores generated images in `asset-images/global/{userId}/{assetId}/` path
- Frontend: "Generate Image" button with job polling and status updates

### 3. Validation Updates
**Why:** Ensure assets have either a description OR an image (at least one required for usability).

**Implementation:**
- Updated validation: Description required at creation (min 10 chars)
- At update: Allows removing description if image exists
- Frontend validation with helpful error messages

### 4. Database Migration
**Why:** `image_generation_jobs` table required `project_id` (NOT NULL), but global assets aren't tied to projects.

**Implementation:**
- Migration `010_global_asset_image_generation.sql`
- Made `project_id` and `branch_id` nullable
- Updated RLS policies to support global asset jobs
- Added separate idempotency index for global assets

## Files Modified

**Backend:**
- `backend/src/routes/assets.ts` - Upload and generate endpoints
- `backend/src/services/image-generation/ImageGenerationService.ts` - Global asset job support
- `backend/migrations/010_global_asset_image_generation.sql` - New migration

**Frontend:**
- `src/components/assets/AssetDialog.tsx` - Image upload/generation UI
- `src/lib/services/assetService.ts` - Upload and generate service methods

## Key Features

1. **Image Upload:**
   - Drag-and-drop or file picker
   - Image preview with remove option
   - Automatic upload on asset save
   - Supports PNG, JPEG, WebP (max 10MB)

2. **Image Generation:**
   - AI-powered generation using Nano Banana
   - Type-specific aspect ratios
   - Visual style capsule support
   - Real-time job polling with status updates
   - Automatic aspect ratio based on asset type

3. **User Experience:**
   - Image preview in dialog
   - Clear validation messages
   - Loading states during upload/generation
   - Success/error toast notifications

## Next Steps

This implementation enables:
- Users to create global assets with images
- Reuse visual references across projects
- Foundation for asset matching workflow (Tasks 3-8)

