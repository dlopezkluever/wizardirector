# Feature 4.4: Rearview Mirror Component - Implementation Plan (REVISED)

**Last Updated:** January 29, 2026  
**Status:** Ready for Implementation  
**Estimated Effort:** ~2 hours (revised from 2.5 hours)

---

## IMPORTANT: Scope Clarification

**Key Discovery:** Stages 8 and 9 are currently **mock implementations** with placeholder data, pending Phase 5-6 development (Asset Inheritance & Prompt Engineering).


**Revised Scope for Feature 4.4:**
- ‚úÖ **IN SCOPE:** Infrastructure (database, API, types) for visual frame preview
- ‚úÖ **IN SCOPE:** Integration into **functional stages** (Stage 7, Stage 10)
- ‚ùå **OUT OF SCOPE:** Integration into Stage 8 & 9 (deferred to Phase 5-6)

(For context, the original \#\#\# Feature 4.4: Rearview Mirror Component tasks were:  
\*\*Purpose\*\*: Display prior scene end-state for continuity  
\- \[ \] Create collapsible rearview mirror UI component  
\- \[ \] Implement prior scene data fetching  
\- \[ \] Display final action/dialogue from previous scene  
\- \[ \] Add visual frame preview (when available)  
\- \[ \] Integrate into Stage 7-10 interfaces
)

**Rationale:** 
- Stage 8/9 don't currently fetch real scene data (using mock assets/prompts)
- No `projectId` prop in their interfaces (would require refactor)
- Phase 5-6 will rebuild these stages from scratch
- RearviewMirror integration will happen naturally during Phase 5-6 implementation
- Avoids wasted effort on components that will be heavily modified

**Timeline Impact:** Reduced from 2.5 hours to ~2 hours (eliminated Tasks 6-7)

---

## Overview

**Goal**: Complete the Rearview Mirror component by adding visual frame preview functionality and integrating it into functional Stage 7-10 interfaces.

**Current Status**:
- ‚úÖ UI component fully implemented (`RearviewMirror.tsx`)
- ‚úÖ Text-mode integration in Stage 7 (showing prior scene end state)
- ‚úÖ Visual-mode placeholder in Stage 10
- ‚è≥ **Missing**: Real visual frame preview data flow (backend ‚Üí database ‚Üí frontend)
- ‚è≥ **Missing**: Real data in Stage 10 (currently using placeholder)
- üö´ **Deferred**: Integration into Stage 8 & 9 (pending Phase 5-6)

---

## Architecture Analysis

### Current Data Flow (Text Mode - Working)
```
Stage 7 mounts
    ‚Üì
Frontend: sceneService.fetchScenes(projectId)
    ‚Üì
Backend: GET /api/projects/:id/scenes
    ‚Üì
Database: SELECT end_state_summary FROM scenes WHERE scene_number = N-1
    ‚Üì
Frontend: RearviewMirror displays priorSceneEndState (text)
```

### Target Data Flow (Visual Mode - To Implement)
```
Stage 10 completes frame generation (FUTURE - Task 9)
    ‚Üì
Backend: Store end frame thumbnail in Supabase Storage
    ‚Üì
Database: UPDATE scenes SET end_frame_thumbnail_url = '...' WHERE id = sceneId
    ‚Üì
Stage 7/10 mounts for next scene
    ‚Üì
Frontend: sceneService.fetchScenes(projectId)
    ‚Üì
Backend: GET /api/projects/:id/scenes includes end_frame_thumbnail_url
    ‚Üì
Frontend: RearviewMirror displays priorEndFrame (image)
```

---

## Database Schema Strategy

### Approach: Use Supabase Storage URLs (Simple & Effective)

**Rationale**: 
- No new table needed (single column addition)
- Thumbnails are lightweight, don't need versioning
- Direct URL storage is efficient
- Follows existing pattern (`end_state_summary`)

**Migration Required**:
```sql
-- Migration 013: Add end frame thumbnail URL to scenes
ALTER TABLE scenes 
    ADD COLUMN end_frame_thumbnail_url TEXT;

COMMENT ON COLUMN scenes.end_frame_thumbnail_url IS 
    'URL to the final frame thumbnail from Supabase Storage. 
     Populated at Stage 10 (Frame Generation) or Stage 12 (Video Complete).
     Used by Rearview Mirror for visual continuity reference.';

-- Rollback (if needed)
-- ALTER TABLE scenes DROP COLUMN end_frame_thumbnail_url;
```

**Alternative (Deferred):** Full `frames` table mentioned in database schema doc is deferred until we need frame versioning or multiple frames per shot.

---

## Implementation Tasks

### Task 0: *DONE* Prerequisite Verification (15 min) ‚ö†Ô∏è CRITICAL *DONE*
**Priority**: **HIGH** - Must complete before other tasks  
**Files**: `src/pages/ProjectView.tsx`, Stage 8/9 component files

**Discovery Summary:**
- ‚úÖ Stage 7: Has `projectId` and `sceneId` props - fully functional
- ‚úÖ Stage 10: Has `sceneId` prop - functional (needs real data)
- ‚ùå Stage 8: Missing `projectId` prop, using mock data (deferred to Phase 5)
- ‚ùå Stage 9: Missing `projectId` prop, using mock data (deferred to Phase 6)

**Current State:**
```typescript
// ProjectView.tsx lines 428-433
{sceneStage === 8 && (
  <Stage8VisualDefinition 
    sceneId={activeSceneId}  // ‚úÖ HAS sceneId
    // ‚ùå MISSING projectId
    onComplete={handleSceneStageComplete}
    onBack={handleSceneStageBack}
  />
)}

// Stage8VisualDefinition.tsx lines 72-76
interface Stage8VisualDefinitionProps {
  sceneId: string;
  // ‚ùå projectId not in interface
  onComplete: () => void;
  onBack: () => void;
}
```

**Decision:** ‚úÖ **Defer Stage 8/9 integration to Phase 5-6**  
No changes needed for Task 0. Stage 7 and 10 already have required props.

**Deliverable**: Verification complete, scope adjusted

---

### Task 1: *DONE* Database Migration (5 min)*DONE*
**Priority**: High  
**Files**: New migration file

**Steps**:
1. Create `backend/migrations/013_add_end_frame_thumbnail.sql`
2. Add `end_frame_thumbnail_url TEXT` column to scenes table
3. Add comment explaining usage
4. Add rollback script as comment
5. Test migration locally

**SQL:**
```sql
-- backend/migrations/013_add_end_frame_thumbnail.sql

-- Forward migration
ALTER TABLE scenes 
    ADD COLUMN end_frame_thumbnail_url TEXT;

COMMENT ON COLUMN scenes.end_frame_thumbnail_url IS 
    'URL to the final frame thumbnail from Supabase Storage. 
     Populated at Stage 10 (Frame Generation) or Stage 12 (Video Complete).
     Used by Rearview Mirror for visual continuity reference.';

-- Rollback (if needed)
-- Run this manually if migration needs to be undone:
-- ALTER TABLE scenes DROP COLUMN end_frame_thumbnail_url;
```

**Testing:**
```bash
cd "C:\Users\Daniel Lopez\Desktop\Aiuteur\wizardirector\backend"
# Apply migration
npm run migrate

# Verify column exists
# Check in Supabase dashboard or via psql
```

**Deliverable**: Scenes table can store thumbnail URLs

---

### Task 2: Backend API Enhancement (20 min)
**Priority**: High  
**Files**: `backend/src/routes/projects.ts`

**Changes to GET `/api/projects/:id/scenes`**:

**Step 1: Update Query** (line ~460):
```typescript
// BEFORE
.select('id, scene_number, slug, status, script_excerpt, end_state_summary, updated_at, expected_characters, expected_location, expected_props, dependencies_extracted_at')

// AFTER
.select('id, scene_number, slug, status, script_excerpt, end_state_summary, end_frame_thumbnail_url, updated_at, expected_characters, expected_location, expected_props, dependencies_extracted_at')
```

**Step 2: Transform Response** (line ~478-506):
```typescript
// Add endFrameThumbnail field to transformed scenes
const transformedScenes = (scenes || []).map((scene) => {
  const scriptExcerpt = scene.script_excerpt || '';
  const lines = scriptExcerpt.split('\n').filter(line => line.trim().length > 0);
  const header = lines.length > 0 ? lines[0].trim() : '';
  const openingActionLines = lines.slice(1, Math.min(6, lines.length));
  const openingAction = openingActionLines.join('\n').trim();

  return {
    id: scene.id,
    sceneNumber: scene.scene_number,
    slug: scene.slug,
    status: scene.status,
    scriptExcerpt: scriptExcerpt,
    header: header,
    openingAction: openingAction,
    expectedCharacters: scene.expected_characters || [],
    expectedLocation: scene.expected_location || '',
    expectedProps: scene.expected_props || [],
    endFrameThumbnail: scene.end_frame_thumbnail_url || undefined, // ADD THIS LINE
    shots: [],
    updated_at: scene.updated_at,
    end_state_summary: scene.end_state_summary
  };
});
```

**Step 3: Pass Through Enriched Response** (line ~513-536):
```typescript
const enrichedScenes = transformedScenes.map((scene, index) => {
  const dbScene = scenes![index];
  const priorScene = index > 0 ? scenes![index - 1] : null;
  const continuityRisk = continuityAnalyzer.analyzeContinuityRisk({
    scene: dbScene,
    priorScene,
    upstreamStageStates: stageStates as any || []
  });
  
  const { updated_at, end_state_summary, ...sceneWithoutTempFields } = scene;
  
  return {
    ...sceneWithoutTempFields,
    expectedCharacters: dbScene.expected_characters || [],
    expectedLocation: dbScene.expected_location || '',
    expectedProps: dbScene.expected_props || [],
    priorSceneEndState: priorScene?.end_state_summary ?? null,
    endFrameThumbnail: scene.endFrameThumbnail ?? null, // ADD THIS LINE (or keep from sceneWithoutTempFields)
    continuityRisk
  };
});
```

**Testing:**
1. Run backend: `npm run dev`
2. Hit endpoint: `GET /api/projects/{projectId}/scenes`
3. Verify response includes `endFrameThumbnail: null` for all scenes
4. Manually set `end_frame_thumbnail_url` in database for one scene
5. Verify API returns the URL

**Deliverable**: Backend API passes `endFrameThumbnail` when available

---

### Task 3: Frontend Type Verification (5 min)
**Priority**: High  
**Files**: `src/types/scene.ts`

**Current Scene Interface** (line 29-44):
```typescript
export interface Scene {
  id: string;
  sceneNumber: number;
  slug: string;
  status: SceneStatus;
  scriptExcerpt: string;
  header: string;
  openingAction: string;
  expectedCharacters: string[];
  expectedLocation: string;
  expectedProps: string[];
  priorSceneEndState?: string;
  endFrameThumbnail?: string; // ‚úÖ Already exists!
  shots: Shot[];
  continuityRisk?: ContinuityRisk;
}
```

**Analysis**: Type already includes `endFrameThumbnail?: string` field - **no changes needed!**

**Action**: Verify field is present, mark task as complete.

**Deliverable**: Type system supports end frame thumbnails ‚úÖ

---

### Task 4: Update Scene Service (15 min)
**Priority**: High  
**Files**: `src/lib/services/sceneService.ts`

**Enhancement**: Ensure `endFrameThumbnail` is properly transformed from backend response.

**Check Current Implementation:**
Look for the scene transformation logic in `fetchScenes()` method:

```typescript
// Should look something like this:
const transformedScenes = scenes.map(scene => ({
  id: scene.id,
  sceneNumber: scene.scene_number || scene.sceneNumber,
  slug: scene.slug,
  status: scene.status,
  scriptExcerpt: scene.scriptExcerpt || scene.script_excerpt,
  header: scene.header,
  openingAction: scene.openingAction || scene.opening_action,
  expectedCharacters: scene.expectedCharacters || scene.expected_characters || [],
  expectedLocation: scene.expectedLocation || scene.expected_location || '',
  expectedProps: scene.expectedProps || scene.expected_props || [],
  priorSceneEndState: scene.priorSceneEndState,
  endFrameThumbnail: scene.endFrameThumbnail, // ADD IF MISSING
  shots: scene.shots || [],
  continuityRisk: scene.continuityRisk || 'safe',
}));
```

**If missing, add**: `endFrameThumbnail: scene.endFrameThumbnail`

**Testing:**
1. Call `sceneService.fetchScenes(projectId)` from dev console
2. Inspect returned scene objects
3. Verify `endFrameThumbnail` field is present (undefined or URL)

**Deliverable**: Scene service correctly passes `endFrameThumbnail` to components

---

### Task 5: Stage 7 - Use Real End Frame (25 min)
**Priority**: High  
**Files**: `src/components/pipeline/Stage7ShotList.tsx`

**Current Implementation** (lines 69-73, 142-163):
```typescript
// State (lines 69-73)
const [priorSceneData, setPriorSceneData] = useState<{
  endState?: string;
  scriptExcerpt?: string;
  sceneNumber?: number;
} | null>(null);

// Fetch logic (lines 142-163)
useEffect(() => {
  const fetchPriorScene = async () => {
    try {
      const scenes = await sceneService.fetchScenes(projectId);
      const currentSceneIndex = scenes.findIndex(s => s.id === sceneId);
      
      if (currentSceneIndex > 0) {
        const priorScene = scenes[currentSceneIndex - 1];
        setPriorSceneData({
          endState: priorScene.priorSceneEndState,
          scriptExcerpt: priorScene.scriptExcerpt,
          sceneNumber: priorScene.sceneNumber
        });
      }
    } catch (error) {
      console.error('Failed to fetch prior scene:', error);
    }
  };
  
  fetchPriorScene();
}, [projectId, sceneId]);
```

**Enhancement:**

**Step 1: Update State Interface**
```typescript
const [priorSceneData, setPriorSceneData] = useState<{
  endState?: string;
  endFrame?: string; // ADD THIS
  scriptExcerpt?: string;
  sceneNumber?: number;
} | null>(null);
```

**Step 2: Add Image Error State**
```typescript
const [imageError, setImageError] = useState(false);
```

**Step 3: Update Fetch Logic**
```typescript
if (currentSceneIndex > 0) {
  const priorScene = scenes[currentSceneIndex - 1];
  setPriorSceneData({
    endState: priorScene.priorSceneEndState,
    endFrame: priorScene.endFrameThumbnail, // ADD THIS
    scriptExcerpt: priorScene.scriptExcerpt,
    sceneNumber: priorScene.sceneNumber
  });
  setImageError(false); // Reset error state
}
```

**Step 4: Update RearviewMirror Usage** (lines 386-397)
```typescript
<RearviewMirror
  mode={priorSceneData?.endFrame && !imageError ? "visual" : "text"} // Dynamic mode with error check
  priorSceneEndState={
    priorSceneData?.endState || 
    (priorSceneData?.scriptExcerpt ? 
      priorSceneData.scriptExcerpt.split('\n').slice(-3).join('\n') : 
      undefined
    )
  }
  priorEndFrame={priorSceneData?.endFrame} // ADD THIS
  priorSceneName={priorSceneData?.sceneNumber ? `Scene ${priorSceneData.sceneNumber}` : undefined}
  onImageError={() => setImageError(true)} // ADD THIS
/>
```

**Step 5: Update RearviewMirror.tsx** (if not already done)
```typescript
interface RearviewMirrorProps {
  mode: 'text' | 'visual';
  priorSceneEndState?: string;
  priorEndFrame?: string;
  priorSceneName?: string;
  onImageError?: () => void; // ADD THIS
}

export function RearviewMirror({ 
  mode, 
  priorSceneEndState, 
  priorEndFrame,
  priorSceneName,
  onImageError // ADD THIS
}: RearviewMirrorProps) {
  const [isExpanded, setIsExpanded] = useState(true);
  const [imageLoading, setImageLoading] = useState(true); // ADD THIS

  if (!priorSceneEndState && !priorEndFrame) {
    return null;
  }

  return (
    <motion.div /* ... */>
      {/* ... existing header ... */}

      {isExpanded && (
        <motion.div /* ... */>
          {mode === 'text' && priorSceneEndState && (
            <div className="bg-background/50 rounded-lg p-4 border border-border/30">
              <p className="text-sm text-muted-foreground leading-relaxed">
                {priorSceneEndState}
              </p>
            </div>
          )}

          {mode === 'visual' && priorEndFrame && (
            <div className="flex gap-4 items-start">
              <div className="relative group">
                {imageLoading && (
                  <div className="absolute inset-0 flex items-center justify-center bg-background/50 rounded-lg">
                    <div className="w-4 h-4 border-2 border-primary border-t-transparent rounded-full animate-spin" />
                  </div>
                )}
                <img
                  src={priorEndFrame}
                  alt={`Final frame from ${priorSceneName || 'previous scene'}`}
                  className="w-48 h-28 object-cover rounded-lg border border-border/50"
                  onLoad={() => setImageLoading(false)}
                  onError={() => {
                    console.error('Failed to load end frame thumbnail:', priorEndFrame);
                    setImageLoading(false);
                    onImageError?.();
                  }}
                />
                {/* ... existing hover overlay ... */}
              </div>
              {/* ... existing text content ... */}
            </div>
          )}
        </motion.div>
      )}
    </motion.div>
  );
}
```

**Behavior**:
- If prior scene has `endFrameThumbnail` ‚Üí show visual mode
- If thumbnail fails to load ‚Üí fallback to text mode
- Show loading spinner while thumbnail loads
- If no thumbnail ‚Üí text mode (current behavior)

**Testing:**
1. Navigate to Stage 7 for Scene 2+ (with prior scene)
2. Verify RearviewMirror shows in text mode (no thumbnails yet)
3. Manually populate `end_frame_thumbnail_url` for Scene 1 in database
4. Refresh Stage 7 for Scene 2
5. Verify RearviewMirror switches to visual mode
6. Verify loading spinner appears briefly
7. Verify thumbnail displays correctly
8. Test with invalid URL ‚Üí should fallback to text mode

**Deliverable**: Stage 7 displays visual frame when available, gracefully falls back to text, handles loading and errors

---

### Task 6: Stage 10 - Replace Mock Data with Real Data (25 min)
**Priority**: High  
**Files**: `src/components/pipeline/Stage10FrameGeneration.tsx`

**Current Implementation** (lines 103-108):
```typescript
<RearviewMirror
  mode="visual"
  priorEndFrame="/placeholder.svg" // ‚ùå Mock data
  priorSceneName="Scene 0: Prologue" // ‚ùå Hardcoded
/>
```

**Enhancement:**

**Step 1: Verify Props**
```typescript
interface Stage10FrameGenerationProps {
  sceneId: string; // ‚úÖ Already exists
  // projectId not currently passed, but not needed if we can get it from context or URL
  onComplete: () => void;
  onBack: () => void;
}
```

**Note:** Stage 10 currently only receives `sceneId`. We need `projectId` to fetch scenes.

**Check ProjectView.tsx** (lines 442-448):
```typescript
{sceneStage === 10 && (
  <Stage10FrameGeneration 
    sceneId={activeSceneId} 
    onComplete={handleSceneStageComplete}
    onBack={handleSceneStageBack}
  />
)}
```

**If `projectId` is missing**, add it to interface and ProjectView:
```typescript
// Stage10FrameGeneration.tsx
interface Stage10FrameGenerationProps {
  projectId: string; // ADD THIS
  sceneId: string;
  onComplete: () => void;
  onBack: () => void;
}

// ProjectView.tsx
{sceneStage === 10 && projectId && (
  <Stage10FrameGeneration 
    projectId={projectId} // ADD THIS
    sceneId={activeSceneId} 
    onComplete={handleSceneStageComplete}
    onBack={handleSceneStageBack}
  />
)}
```

**Step 2: Add Prior Scene State**
```typescript
const [priorSceneData, setPriorSceneData] = useState<{
  endState?: string;
  endFrame?: string;
  sceneNumber?: number;
} | null>(null);

const [imageError, setImageError] = useState(false);
```

**Step 3: Fetch Prior Scene on Mount**
```typescript
useEffect(() => {
  const fetchPriorScene = async () => {
    try {
      const scenes = await sceneService.fetchScenes(projectId);
      const currentSceneIndex = scenes.findIndex(s => s.id === sceneId);
      
      if (currentSceneIndex > 0) {
        const priorScene = scenes[currentSceneIndex - 1];
        setPriorSceneData({
          endState: priorScene.priorSceneEndState,
          endFrame: priorScene.endFrameThumbnail,
          sceneNumber: priorScene.sceneNumber
        });
        setImageError(false);
      }
    } catch (error) {
      console.error('Failed to fetch prior scene:', error);
    }
  };
  
  fetchPriorScene();
}, [projectId, sceneId]);
```

**Step 4: Update RearviewMirror** (lines 103-108)
```typescript
<RearviewMirror
  mode={priorSceneData?.endFrame && !imageError ? "visual" : "text"}
  priorSceneEndState={priorSceneData?.endState}
  priorEndFrame={priorSceneData?.endFrame}
  priorSceneName={priorSceneData?.sceneNumber ? `Scene ${priorSceneData.sceneNumber}` : undefined}
  onImageError={() => setImageError(true)}
/>
```

**Testing:**
1. Navigate to Stage 10 for Scene 2+
2. Verify RearviewMirror no longer shows placeholder
3. Verify real prior scene data displays (text or visual)
4. Test error handling with invalid thumbnail URL

**Deliverable**: Stage 10 uses real prior scene data from database

---

### Task 7: ~~Stage 8 & 9 Integration~~ (DEFERRED TO PHASE 5-6)
**Priority**: ~~Medium~~ **DEFERRED**  
**Reason**: Stage 8 & 9 are mock implementations pending Phase 5-6 development

**What was planned:**
- Add RearviewMirror to Stage 8 (Visual Definition)
- Add RearviewMirror to Stage 9 (Prompt Segmentation)

**Why deferred:**
1. Stage 8/9 currently use mock data (no real scene fetching)
2. Don't have `projectId` prop in their interfaces
3. Phase 5 (Asset Inheritance) will rebuild Stage 8 from scratch
4. Phase 6 (Prompt Engineering) will rebuild Stage 9 from scratch
5. RearviewMirror integration will happen naturally during Phase 5-6 implementation
6. Avoids wasted effort on components that will be heavily modified

**Future Implementation (Phase 5-6):**
When Stage 8/9 are rebuilt with real functionality:
1. Add `projectId` to component interfaces
2. Pass `projectId` from ProjectView
3. Fetch real scene data using `sceneService.fetchScenes(projectId)`
4. Add RearviewMirror component at top of stage (copy pattern from Stage 7)
5. Test visual/text mode switching

**Deliverable**: Task intentionally deferred to avoid premature work

---

### Task 8: Populate End Frame Thumbnails (FUTURE - NOT IN SCOPE)
**Priority**: Low (Future Work)  
**Files**: To be determined (Stage 10 completion handler or Stage 12)

**Trigger Point**: When a scene completes frame generation (Stage 10) or video rendering (Stage 12)

**When to Implement:** During Phase 7 (Frame Generation & Stage 10) implementation

**Process Specification:**

**Trigger:** On "Approve All Frames" button click in Stage 10

**Steps:**
1. Verify all shots have approved frames (validation check)
2. Get the last shot in the scene
3. Extract its `endFrame` URL (already in Supabase Storage)
4. Update scene record:
   ```typescript
   await supabase
     .from('scenes')
     .update({ 
       end_frame_thumbnail_url: lastShot.endFrame,
       updated_at: new Date().toISOString()
     })
     .eq('id', sceneId);
   ```
5. Proceed to next stage

**Storage Convention:**
- **Bucket:** Same as frames bucket (likely `scene-frames` or `frames`)
- **Path:** `{projectId}/{branchId}/scenes/{sceneId}/shots/{shotId}/end-frame.png`
- **Format:** PNG or JPEG (same as generated frames from Stage 10)
- **Size:** Full resolution (browser scales down for RearviewMirror display)
- **Access:** Public URL via Supabase CDN

**No Upload Needed:** Frame already exists in storage from Stage 10 generation. We're just storing the URL reference in the scenes table.

**Implementation Sketch:**
```typescript
// In Stage 10 completion handler (future implementation)
const handleApproveAllFrames = async () => {
  // 1. Validation
  if (!allFramesApproved) {
    toast.error('Please approve all frames before proceeding');
    return;
  }
  
  // 2. Get last shot's end frame
  const lastShot = framePairs[framePairs.length - 1];
  const endFrameUrl = lastShot.endFrame || lastShot.startFrame;
  
  if (!endFrameUrl) {
    console.warn('No end frame available for scene');
  } else {
    // 3. Update scene record
    try {
      const { error } = await supabase
        .from('scenes')
        .update({ end_frame_thumbnail_url: endFrameUrl })
        .eq('id', sceneId);
        
      if (error) {
        console.error('Failed to save end frame thumbnail:', error);
        // Don't block progression
      } else {
        console.log('‚úÖ End frame thumbnail saved for scene');
      }
    } catch (err) {
      console.error('Error saving thumbnail:', err);
      // Don't block progression
    }
  }
  
  // 4. Proceed to next stage
  onComplete();
};
```

**Error Handling:**
- If update fails, log error but don't block stage progression
- Next scene will fallback to text mode (graceful degradation)
- User can manually re-generate frames if needed

**Edge Cases:**
- **No end frame:** Some shots may not have end frames (short duration). Use start frame instead.
- **Re-generation:** If frames are regenerated, `handleApproveAllFrames` will overwrite the URL with new frame.
- **Stale thumbnails:** Consider adding `thumbnail_generated_at` timestamp for freshness tracking (future enhancement).

**Testing Plan (when implemented):**
1. Complete Stage 10 for Scene 1
2. Check database: `SELECT end_frame_thumbnail_url FROM scenes WHERE id = '{sceneId}'`
3. Verify URL is populated
4. Navigate to Stage 7 for Scene 2
5. Verify RearviewMirror shows Scene 1's end frame

**Note**: This task is **deferred** to Phase 7 implementation. For Feature 4.4, we're building the infrastructure (database column, API, UI) but not the population logic.

**Deliverable**: (Future) End frame thumbnails automatically populated when scenes complete Stage 10

---

## Testing Plan

### Manual Testing Checklist

#### Test 1: Database Migration ‚úÖ
- [ ] Run migration 013 successfully
- [ ] Verify `end_frame_thumbnail_url` column exists in scenes table
- [ ] Check column is nullable (allows existing scenes)
- [ ] Verify rollback script in migration file

#### Test 2: Backend API ‚úÖ
- [ ] Start backend: `npm run dev`
- [ ] Hit endpoint: `GET /api/projects/{projectId}/scenes`
- [ ] Verify response includes `endFrameThumbnail: null` for all scenes
- [ ] Manually set `end_frame_thumbnail_url` in Supabase for one scene
- [ ] Hit endpoint again, verify API returns the URL

#### Test 3: Stage 7 with No End Frame (Current State) ‚úÖ
- [ ] Navigate to Stage 7 for Scene 2+
- [ ] Verify RearviewMirror shows in text mode
- [ ] Verify prior scene end state or script excerpt displays
- [ ] Verify "No prior scene" handling for Scene 1 (component hidden)

#### Test 4: Stage 7 with End Frame (After Manual Population) ‚úÖ
- [ ] Manually set `end_frame_thumbnail_url` for Scene 1 in Supabase
- [ ] Use a valid image URL (e.g., `/placeholder.svg` or actual storage URL)
- [ ] Navigate to Stage 7 for Scene 2
- [ ] Verify RearviewMirror switches to visual mode
- [ ] Verify loading spinner appears briefly
- [ ] Verify thumbnail image displays correctly
- [ ] Verify "Compare" button appears on hover

#### Test 5: Error Handling ‚úÖ
- [ ] Set invalid thumbnail URL in database (e.g., `https://invalid.url/missing.png`)
- [ ] Navigate to Stage 7 for Scene 2
- [ ] Verify RearviewMirror starts in visual mode
- [ ] Verify image fails to load (check console error)
- [ ] Verify RearviewMirror automatically falls back to text mode
- [ ] Verify no broken image icon visible

#### Test 6: Stage 10 Integration ‚úÖ
- [ ] Verify `projectId` prop is passed to Stage 10 (check code or add if missing)
- [ ] Navigate to Stage 10 for Scene 2+
- [ ] Verify RearviewMirror no longer shows placeholder `/placeholder.svg`
- [ ] Verify real prior scene data displays (text or visual based on data availability)
- [ ] Verify loading states work correctly

#### Test 7: Edge Cases ‚úÖ
- [ ] First scene (Scene 1) ‚Üí RearviewMirror completely hidden
- [ ] Prior scene with neither `priorSceneEndState` nor `endFrameThumbnail` ‚Üí RearviewMirror hidden
- [ ] Prior scene with only text ‚Üí RearviewMirror shows text mode
- [ ] Prior scene with only thumbnail ‚Üí RearviewMirror shows visual mode
- [ ] Page refresh preserves scene context (URL navigation already implemented)
- [ ] Network error during scene fetch ‚Üí graceful error handling

#### Test 8: Performance ‚úÖ
- [ ] Test with 20+ scenes
- [ ] Verify scene list loads in <500ms
- [ ] Monitor thumbnail load time (<500ms per image)
- [ ] Check network tab for redundant API calls
- [ ] Verify no memory leaks (React DevTools Profiler)

### Automated Testing (Optional)

**Unit Tests:**
```typescript
// sceneService.test.ts
describe('sceneService.fetchScenes', () => {
  it('includes endFrameThumbnail field in returned scenes', async () => {
    const scenes = await sceneService.fetchScenes('test-project-id');
    expect(scenes[0]).toHaveProperty('endFrameThumbnail');
  });
});

// RearviewMirror.test.tsx
describe('RearviewMirror', () => {
  it('switches to visual mode when endFrame is provided', () => {
    render(<RearviewMirror mode="visual" priorEndFrame="/test.png" />);
    expect(screen.getByRole('img')).toBeInTheDocument();
  });
  
  it('falls back to text mode on image error', async () => {
    const onError = jest.fn();
    render(<RearviewMirror mode="visual" priorEndFrame="/invalid.png" onImageError={onError} />);
    fireEvent.error(screen.getByRole('img'));
    expect(onError).toHaveBeenCalled();
  });
});
```

**Integration Tests:**
```typescript
// scenes.test.ts (backend)
describe('GET /api/projects/:id/scenes', () => {
  it('returns endFrameThumbnail when populated', async () => {
    // Setup: Create scene with thumbnail URL
    await supabase.from('scenes').update({ 
      end_frame_thumbnail_url: 'https://example.com/test.png' 
    }).eq('id', testSceneId);
    
    // Test: Fetch scenes
    const response = await request(app).get(`/api/projects/${testProjectId}/scenes`);
    
    // Assert
    expect(response.body.scenes[0].endFrameThumbnail).toBe('https://example.com/test.png');
  });
});
```

---

## Rollout Strategy

### Phase 1: Foundation (Tasks 1-4) - 45 min
**Goal**: Backend and types support end frame thumbnails

**Tasks:**
1. Task 1: Run database migration (5 min)
2. Task 2: Update backend API to fetch and pass thumbnails (20 min)
3. Task 3: Verify types are correct (5 min)
4. Task 4: Update scene service (15 min)

**Testing:**
- Manual thumbnail population in database
- API returns thumbnail URL correctly
- Scene service includes field

**Deliverable**: Infrastructure ready, no visible UI changes yet

**Exit Criteria:**
- ‚úÖ Migration applied successfully
- ‚úÖ Backend returns `endFrameThumbnail` field
- ‚úÖ Scene service transforms field correctly
- ‚úÖ Manual test: Set thumbnail URL in DB, verify API returns it

---

### Phase 2: Visual Preview (Tasks 5-6) - 50 min
**Goal**: Stages 7 and 10 use real data

**Tasks:**
1. Task 5: Update Stage 7 to fetch and display end frames (25 min)
2. Task 6: Update Stage 10 to use real prior scene data (25 min)

**Testing:**
- Stage 7 shows visual mode with thumbnail
- Stage 7 falls back to text mode without thumbnail
- Stage 10 shows real data (not placeholder)
- Error handling works (invalid URLs)
- Loading states display correctly

**Deliverable**: Stage 7 and 10 show visual continuity when available

**Exit Criteria:**
- ‚úÖ Stage 7 RearviewMirror dynamic mode (visual/text)
- ‚úÖ Stage 7 error handling and loading states
- ‚úÖ Stage 10 uses real prior scene data
- ‚úÖ All manual tests pass

---

### Phase 3: ~~Full Integration~~ (DEFERRED)
**Original Goal**: All stages have RearviewMirror

**Status**: **DEFERRED TO PHASE 5-6**

**Reason**: Stage 8 & 9 are mock implementations pending Phase 5-6 rebuild

**Future Work**: When Phase 5-6 implement Stage 8 & 9 with real functionality, add RearviewMirror integration following Stage 7 pattern

---

### Phase 4: Thumbnail Population (Task 8) - Future
**Goal**: Automate end frame thumbnail creation

**Trigger**: When implementing Stage 10 completion logic (Phase 7)

**Deliverable**: Thumbnails automatically populate when scenes complete Stage 10

---

## File Modification Summary

### New Files
1. `backend/migrations/013_add_end_frame_thumbnail.sql` - Database schema + rollback

### Modified Files (Backend)
1. `backend/src/routes/projects.ts` - Add `end_frame_thumbnail_url` to query and response (GET `/api/projects/:id/scenes`)

### Modified Files (Frontend)
1. `src/lib/services/sceneService.ts` - Ensure `endFrameThumbnail` transform (if missing)
2. `src/components/pipeline/Stage7ShotList.tsx` - Dynamic mode, real end frame, error handling, loading states
3. `src/components/pipeline/Stage10FrameGeneration.tsx` - Replace mock data with real data, add `projectId` prop
4. `src/components/pipeline/RearviewMirror.tsx` - Add `onImageError` prop, loading states, error handling
5. `src/pages/ProjectView.tsx` - Pass `projectId` to Stage 10 (if missing)

### No Changes Needed
1. `src/types/scene.ts` - Already has `endFrameThumbnail` field ‚úÖ

### Deferred (Phase 5-6)
1. ~~`src/components/pipeline/Stage8VisualDefinition.tsx`~~ - Mock component, defer integration
2. ~~`src/components/pipeline/Stage9PromptSegmentation.tsx`~~ - Mock component, defer integration

---

## Dependencies & Risks

### Dependencies
- ‚úÖ Supabase Storage already configured (from Phase 3)
- ‚úÖ `sceneService.fetchScenes()` already working (from Phase 4.1-4.2)
- ‚úÖ RearviewMirror UI component complete (from Phase 4.4 partial)
- ‚úÖ Stage 7 already fetches scene data with `projectId`
- ‚ö†Ô∏è Stage 10 may need `projectId` prop added (verify in Task 6)

### Risks & Mitigations

**Risk 1**: Thumbnails not yet generated (no Stage 10 completion logic)  
**Impact**: Medium (expected)  
**Mitigation**: ‚úÖ Build infrastructure now, gracefully degrade to text mode. Thumbnail population deferred to Phase 7 (Stage 10 implementation).

**Risk 2**: Large thumbnail files slow down scene fetching  
**Impact**: Low  
**Mitigation**: ‚úÖ Use Supabase CDN URLs (already optimized). Consider lazy loading thumbnails in future if needed (>20 scenes).

**Risk 3**: Stage 10 missing `projectId` prop  
**Impact**: Medium (blocks Task 6)  
**Mitigation**: ‚úÖ Task 6 includes verification step. If missing, add to interface and ProjectView (5 min).

**Risk 4**: End frame thumbnail URL format mismatch with Supabase Storage  
**Impact**: Low  
**Mitigation**: ‚úÖ Use Supabase public URL format: `{supabaseUrl}/storage/v1/object/public/{bucket}/{path}`. Test with manual upload first in Phase 2.

**Risk 5**: Image load failures break UI  
**Impact**: Medium  
**Mitigation**: ‚úÖ Added comprehensive error handling in Task 5 & 6. Falls back to text mode. No broken images visible.

---

## Success Criteria

### Feature Complete When:
- ‚úÖ Database stores `end_frame_thumbnail_url` (nullable column)
- ‚úÖ Backend API passes thumbnails when available
- ‚úÖ Stage 7 displays visual preview when thumbnail exists
- ‚úÖ Stage 7 falls back to text when thumbnail unavailable
- ‚úÖ Stage 7 handles image load errors gracefully
- ‚úÖ Stage 7 shows loading states while thumbnails load
- ‚úÖ Stage 10 uses real prior scene data (not placeholder)
- ‚úÖ First scene (no prior) handled gracefully (component hidden)
- ‚úÖ All manual tests pass
- ‚úÖ No console errors or warnings

### Out of Scope (Future Work):
- ‚è≥ Automatic thumbnail generation (Task 8 - Phase 7)
- ‚è≥ Stage 8/9 integration (Phase 5-6)
- ‚è≥ Thumbnail versioning
- ‚è≥ Full frames table implementation
- ‚è≥ Compare view modal (enhance RearviewMirror)
- ‚è≥ Thumbnail optimization/resizing
- ‚è≥ Lazy loading for >20 scenes

---

## Timeline Estimate

| Phase | Tasks | Original Estimate | Revised Estimate |
|-------|-------|-------------------|------------------|
| Phase 0: Verification | 0 | 15 min | 0 min (discovery complete) |
| Phase 1: Foundation | 1-4 | 50 min | 45 min |
| Phase 2: Visual Preview | 5-6 | 35 min | 50 min (added error handling) |
| ~~Phase 3: Full Integration~~ | ~~6-7~~ | ~~60 min~~ | **DEFERRED** |
| **Total (Feature 4.4 Complete)** | | ~~2.5 hours~~ | **~2 hours** |
| Phase 4: Auto-Population (Future) | 8 | TBD | TBD (Phase 7) |

**Timeline Reduction:** Reduced from 2.5 hours to 2 hours by deferring Stage 8/9 integration to Phase 5-6

---

## Questions & Answers

### Q1: Do Stages 8 and 9 already receive `projectId` and `sceneId` props?
**Answer**: ‚ùå **NO** - Stage 8/9 only have `sceneId`, missing `projectId`

**Discovery:**
```typescript
// ProjectView.tsx lines 428-433
{sceneStage === 8 && (
  <Stage8VisualDefinition 
    sceneId={activeSceneId}  // ‚úÖ HAS sceneId
    // ‚ùå MISSING projectId
    onComplete={handleSceneStageComplete}
    onBack={handleSceneStageBack}
  />
)}
```

**Decision**: ‚úÖ **Defer Stage 8/9 integration to Phase 5-6** (when they're rebuilt with real functionality)

---

### Q2: Should RearviewMirror be above or below stage-specific headers?
**Answer**: ‚úÖ **Above** (before stage content, after main header)

**Rationale:**
- Matches Stage 7 and 10 current placement
- Continuity context should be first thing users see
- Mental model: "What came before?" ‚Üí "What am I working on?"

**Confirmed in plan** ‚úÖ

---

### Q3: What thumbnail resolution/format should we use?
**Answer**: ‚úÖ **Use same format as Stage 10 generated frames**

**Details:**
- **Format**: PNG or JPEG (whatever Stage 10 outputs)
- **Resolution**: Full resolution (browser scales down for display)
- **Size**: ~200-500KB per image (acceptable for <20 scenes)
- **Processing**: None needed (browser handles downscaling)

**No additional thumbnail generation required** ‚úÖ

---

### Q4: Should we implement "Compare" button functionality now?
**Answer**: ‚ùå **No - defer to future enhancement**

**Rationale:**
- Button already in UI (non-functional placeholder)
- Requires modal/overlay implementation (~2-3 hours)
- Not critical for MVP continuity reference
- Users can open prior scene in new tab if needed

**Deferred to future backlog** ‚úÖ

---

### Q5: Should end frame thumbnail generation be part of Feature 4.4?
**Answer**: ‚ùå **No - defer to Task 8 (Phase 7 implementation)**

**Rationale:**
- Stage 10 completion logic not yet implemented
- Infrastructure first, population later approach
- Graceful degradation already built-in (fallback to text)
- Thumbnail population happens naturally when Phase 7 implements Stage 10

**Feature 4.4 = Infrastructure Only** ‚úÖ

**What 4.4 INCLUDES:**
- ‚úÖ Database column
- ‚úÖ Backend API
- ‚úÖ Frontend display
- ‚úÖ Fallback logic

**What 4.4 EXCLUDES:**
- ‚ùå Uploading thumbnails
- ‚ùå Updating scene records
- ‚ùå Stage 10 completion handler

---

## Next Steps

### 1. Review & Approval
- [ ] Review revised plan
- [ ] Confirm scope reduction (defer Stage 8/9)
- [ ] Confirm 2-hour timeline is acceptable
- [ ] Approve to proceed

### 2. Implementation Order
Once approved:
1. **Phase 1** (Foundation) - 45 min
   - Safe, no visible changes
   - Test with manual thumbnail population
2. **Phase 2** (Visual Preview) - 50 min
   - High impact, immediate value
   - Stage 7 & 10 fully functional
3. Mark Feature 4.4 as **COMPLETE** ‚úÖ

### 3. Future Work Tracking
Add to backlog:
- [ ] Task 8: Thumbnail population (Phase 7)
- [ ] Stage 8 RearviewMirror integration (Phase 5)
- [ ] Stage 9 RearviewMirror integration (Phase 6)
- [ ] Compare button functionality (future enhancement)

---

## Revision History

**v1.0** - Initial plan (2.5 hours, all stages)  
**v2.0** - Revised plan (2 hours, defer Stage 8/9) - January 29, 2026

**Key Changes in v2.0:**
- ‚úÖ Verified Stage 8/9 are mock implementations
- ‚úÖ Deferred Stage 8/9 integration to Phase 5-6
- ‚úÖ Added comprehensive error handling
- ‚úÖ Added loading states
- ‚úÖ Added rollback script to migration
- ‚úÖ Clarified Task 8 (thumbnail population)
- ‚úÖ Reduced timeline from 2.5 to 2 hours
- ‚úÖ Updated success criteria
- ‚úÖ Added Q&A section

---

**Plan Status**: ‚úÖ **READY FOR IMPLEMENTATION**  
**Estimated Effort**: ~2 hours (down from 2.5 hours)  
**Risk Level**: üü¢ **LOW** (all major risks mitigated)  
**Confidence**: **HIGH** (95%) - Scope is well-defined, risks are known and mitigated

______________________________________

#**Implementation Summary**

##: Task 1 done:
**Created: `backend/migrations/013_add_end_frame_thumbnail.sql`**

- **Forward migration:** `ALTER TABLE scenes ADD COLUMN end_frame_thumbnail_url TEXT;`
- **Comment:** Documents that the column holds the final frame thumbnail URL from Supabase Storage, is set at Stage 10 (Frame Generation) or Stage 12 (Video Complete), and is used by Rearview Mirror for visual continuity.
- **Rollback:** Commented SQL to drop the column if you need to undo the migration.

## Task 2 & 3:

Implementing Task 2 (backend API) and Task 3 (frontend type verification). Reading the relevant files.

---

### Task 2: Backend API Enhancement ‚Äî done

**File:** `backend/src/routes/projects.ts`

1. **Query update**  
   The scenes select now includes `end_frame_thumbnail_url`:
   - `select('..., end_state_summary, end_frame_thumbnail_url, updated_at, ...')`

2. **Transform**  
   In the scene transform, the returned object now has:
   - `endFrameThumbnail: scene.end_frame_thumbnail_url || undefined`

3. **Enriched response**  
   In the enriched scenes mapping, the returned object now explicitly includes:
   - `endFrameThumbnail: scene.endFrameThumbnail ?? null`

`GET /api/projects/:id/scenes` will now return `endFrameThumbnail: null` when no URL is set, or the URL string when `end_frame_thumbnail_url` is set in the database.

---

### Task 3: Frontend type verification ‚Äî done

**File:** `src/types/scene.ts`

The `Scene` interface already defines:

```40:40:src/types/scene.ts
  endFrameThumbnail?: string;
```

No change was required; the type already supports end frame thumbnails.
