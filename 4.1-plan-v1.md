# Feature 4.1: Scene Extraction & Parsing Implementation Plan

## Overview

Enhance the existing scene extraction system to properly parse scene headings with DAY/NIGHT detection, generate descriptive slugs, ensure correct scene ordering, and align TypeScript types with the database schema. The scenes table already exists, and basic extraction logic is in place, but needs enhancement for production use.

## Current State Analysis

**Already Implemented:**

- `scenes` table schema (migration 003) with all required fields
- Basic `extractScenes()` method in `scriptService.ts` (lines 266-317)
- Scene persistence endpoint `PUT /api/projects/:id/scenes` (lines 426-498)
- Integration in Stage 4 that calls extraction and persistence on script approval
- Stage 6 Script Hub UI (currently using mock data)

**Gaps Identified:**

1. Scene heading parser only detects INT./EXT., missing DAY/NIGHT parsing
2. Slug generation is too basic (doesn't include location/time context)
3. TypeScript `Scene` type status values don't match database schema
4. Scene boundary detection could be more robust
5. No GET endpoint to fetch scenes for Stage 6

## Implementation Tasks

### Task 1: Align TypeScript Types with Database Schema

**File**: `src/types/scene.ts`

**Issue**: Database uses `'shot_list_ready'`, `'frames_locked'`, `'video_complete'`, `'continuity_broken'` but TypeScript uses `'shot-list-locked'`, `'frames-locked'`, `'video-complete'`.

**Changes**:

- Update `SceneStatus` type to match database enum values exactly
- Update `Scene` interface to match database fields:
                - `header` → should be derived from `script_excerpt` (first line)
                - `openingAction` → should be derived from `script_excerpt`
                - `expectedCharacters` → needs extraction from script (future enhancement)
                - `expectedLocation` → needs extraction from script (future enhancement)
                - Add `scriptExcerpt` field to match database
                - Ensure `status` uses database values

### Task 2: Enhance Scene Heading Parser

**File**: `src/lib/services/scriptService.ts`

**Current regex**: `/^(INT\.|EXT\.)\s+(.+)$/i` (line 275)

**Enhancements needed**:

1. Parse DAY/NIGHT/CONTINUOUS from scene headings

                        - Pattern: `INT. LOCATION - DAY` or `EXT. LOCATION - NIGHT`
                        - Handle variations: `- DAY`, `- NIGHT`, `- CONTINUOUS`, `- LATER`, `- MOMENTS LATER`

2. Extract location name from heading
3. More robust boundary detection:

                        - Handle scene headings that may have extra whitespace
                        - Handle scene headings with numbers (e.g., `INT. KITCHEN - DAY 1`)
                        - Ensure scene content includes everything until next scene heading

**Implementation**:

```typescript
// Enhanced regex pattern
const sceneHeadingRegex = /^(INT\.|EXT\.)\s+(.+?)(?:\s*-\s*(DAY|NIGHT|CONTINUOUS|LATER|MOMENTS LATER|DAWN|DUSK))?$/i;

// Parse heading components
interface ParsedHeading {
  type: 'INT' | 'EXT';
  location: string;
  timeOfDay?: string;
  fullHeading: string;
}
```

### Task 3: Improve Slug Generation

**File**: `src/lib/services/scriptService.ts` (lines 415-422)

**Current**: Basic slug from heading (lowercase, replace spaces with hyphens)

**Enhancement**: Generate descriptive slugs that include:

- Scene type (int/ext)
- Location (sanitized)
- Time of day (if present)
- Example: `int-kitchen-day`, `ext-city-street-night`

**Implementation**:

- Use parsed heading components to build structured slug
- Sanitize location name (remove special chars, handle multi-word locations)
- Include time of day in slug for better identification

### Task 4: Enhance Scene Extraction Logic

**File**: `src/lib/services/scriptService.ts` (lines 266-317)

**Improvements**:

1. Better content aggregation:

                        - Include scene heading in content
                        - Capture all lines until next scene heading
                        - Handle edge cases (empty scenes, scenes at end of script)

2. Validate extracted scenes:

                        - Ensure each scene has non-empty content
                        - Log warnings for malformed scenes

3. Scene numbering:

                        - Ensure sequential numbering (1, 2, 3...)
                        - Handle re-extraction (should maintain or reset numbering)

**Edge Cases to Handle**:

- Scripts with no scene headings
- Scene headings without content
- Multiple consecutive scene headings
- Scene headings in dialogue or action blocks (false positives)

### Task 5: Create Scene Fetching API Endpoint

**File**: `backend/src/routes/projects.ts`

**New Endpoint**: `GET /api/projects/:id/scenes`

**Purpose**: Fetch all scenes for a project's active branch for Stage 6 Script Hub

**Implementation**:

- Get project and validate ownership
- Get active branch ID
- Query scenes table ordered by `scene_number`
- Return scenes with all fields needed by Stage 6:
                - `id`, `scene_number`, `slug`, `status`, `script_excerpt`
                - Transform `script_excerpt` to extract `header` and `openingAction` for UI

**Response Format**:

```typescript
{
  scenes: Array<{
    id: string;
    sceneNumber: number;
    slug: string;
    status: SceneStatus;
    scriptExcerpt: string;
    header: string; // First line of script_excerpt
    openingAction: string; // First few lines after header
    // ... other fields
  }>
}
```

### Task 6: Create Scene Service in Frontend

**File**: `src/lib/services/sceneService.ts` (new file)

**Purpose**: Centralized service for scene operations

**Methods**:

- `fetchScenes(projectId: string): Promise<Scene[]>`
- `getScene(sceneId: string): Promise<Scene>`
- `updateSceneStatus(sceneId: string, status: SceneStatus): Promise<void>`

**Implementation**:

- Use Supabase client or API endpoints
- Handle authentication
- Transform database format to TypeScript types
- Extract `header` and `openingAction` from `script_excerpt`

### Task 7: Enhance Stage 4 Approval Workflow

**File**: `src/components/pipeline/Stage4MasterScript.tsx` (lines 425-432)

**Current**: Already correctly calls `extractScenes()` and `persistScenes()` in `handleApproveScript()` when user clicks "Approve Master Script"

**Important**: Scene extraction happens ONLY on approval (when proceeding to Stage 5), NOT on every edit. This aligns with the project's branching strategy - if users return to edit Stage 4 after entering Phase B, they'll be forced to create a new branch (per project-overview.md Section 7.2).

**Enhancements**:

- Validate extracted scenes before persisting (ensure at least one scene, validate scene content is non-empty)
- Show scene count in success toast (already done, but can enhance message)
- Handle extraction errors gracefully with user-friendly error messages
- Ensure extraction uses the latest script content from editor (already handled correctly)

### Task 8: Replace Mock Data in Stage 6

**File**: `src/components/pipeline/Stage6ScriptHub.tsx`

**Current**: Uses `mockScenes` array (lines 22-86)

**Changes**:

- Remove `mockScenes` constant
- Add `useEffect` to fetch scenes on mount using `sceneService.fetchScenes()`
- Add loading state while fetching
- Add error handling
- Transform fetched scenes to match UI expectations:
                - Extract `header` from `script_excerpt` (first line)
                - Extract `openingAction` from `script_excerpt` (lines after header)
                - Map database status to TypeScript status
                - Set default values for `expectedCharacters`, `expectedLocation` (will be enhanced in future)

### Task 9: Add Scene Extraction Tests

**File**: `src/lib/services/__tests__/scriptService.test.ts` (new file)

**Test Cases**:

1. Extract scenes from standard formatted script
2. Handle DAY/NIGHT in scene headings
3. Handle CONTINUOUS/LATER variations
4. Extract scenes with proper numbering
5. Handle edge cases (no scenes, malformed headings)
6. Slug generation with various heading formats

## Data Flow

```
Stage 4 Master Script (formattedScript)
    ↓
scriptService.extractScenes(formattedScript)
    ↓
Enhanced Parser:
 - Detects INT./EXT. headings
 - Parses DAY/NIGHT/CONTINUOUS
 - Extracts location
 - Generates descriptive slugs
 - Aggregates scene content
    ↓
Scene[] array with:
 - sceneNumber (sequential)
 - slug (descriptive)
 - content (full script excerpt)
    ↓
scriptService.persistScenes(projectId, scenes)
    ↓
PUT /api/projects/:id/scenes
    ↓
Database: scenes table
    ↓
GET /api/projects/:id/scenes (for Stage 6)
    ↓
Stage 6 Script Hub (real data)
```

## Type Alignment Matrix

| Database Field | TypeScript Field | Transformation Needed |

|---------------|-----------------|----------------------|

| `scene_number` | `sceneNumber` | Direct mapping |

| `slug` | `slug` | Direct mapping |

| `script_excerpt` | `scriptExcerpt` | Direct mapping |

| `status` | `status` | Direct mapping (after type update) |

| `script_excerpt` (first line) | `header` | Extract from `script_excerpt` |

| `script_excerpt` (after header) | `openingAction` | Extract from `script_excerpt` |

| N/A | `expectedCharacters` | Set empty array (future: extract from script) |

| N/A | `expectedLocation` | Extract from scene heading (future: full extraction) |

## Success Criteria

1. ✅ Scene extraction correctly parses INT/EXT with DAY/NIGHT
2. ✅ Slugs are descriptive and include location/time context
3. ✅ Scenes are numbered sequentially (1, 2, 3...)
4. ✅ Scene content includes full script excerpt
5. ✅ TypeScript types match database schema exactly
6. ✅ Stage 6 displays real scenes from database (no mock data)
7. ✅ Scene fetching API endpoint works correctly
8. ✅ Edge cases are handled gracefully (empty scripts, malformed headings)

## Files to Modify

1. `src/types/scene.ts` - Update SceneStatus and Scene interface
2. `src/lib/services/scriptService.ts` - Enhance extractScenes() and generateSlug()
3. `backend/src/routes/projects.ts` - Add GET /api/projects/:id/scenes endpoint
4. `src/lib/services/sceneService.ts` - New file for scene operations
5. `src/components/pipeline/Stage6ScriptHub.tsx` - Replace mock data with real fetching
6. `src/components/pipeline/Stage4MasterScript.tsx` - Minor validation enhancements

## Dependencies

- Existing `scenes` table (migration 003) ✅
- Existing scene persistence endpoint ✅
- Stage 4 script generation ✅
- Supabase client configuration ✅

## Future Enhancements (Out of Scope for 4.1)

- Extract `expectedCharacters` from script content (LLM-based)
- Extract `expectedLocation` from script content (LLM-based)
- Continuity risk analysis (Feature 4.2)
- Scene end-state summary generation (Feature 4.4)