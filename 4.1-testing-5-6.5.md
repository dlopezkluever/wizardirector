# Testing Guide: Tasks 5, 6.5, and 6 (Scene API & Service)

This guide provides comprehensive testing methods for the newly implemented scene fetching, persistence with ID stability, and frontend service layer.

## Prerequisites

1. **Start both servers:**
```bash
# Terminal 1 - Frontend
cd "C:\Users\Daniel Lopez\Desktop\Aiuteur\wizardirector"
npm run dev

# Terminal 2 - Backend
cd "C:\Users\Daniel Lopez\Desktop\Aiuteur\wizardirector\backend"
npm run dev
```

2. **Have a test project ready:**
   - Create a project in the app (or use existing)
   - Note the project ID (from URL or database)
   - Ensure you have an active branch (should be created automatically)

3. **Get your auth token:**
   - Open browser DevTools (F12) → Application/Storage → Local Storage
   - Find `sb-<project-id>-auth-token` and copy the `access_token` value
   - Or use browser console: `(await supabase.auth.getSession()).data.session.access_token`

---

## Phase 3: Backend API Testing (Tasks 5 & 6.5)

### Test 1: GET /api/projects/:id/scenes (Task 5) - Empty State

**Purpose**: Test fetching scenes when none exist yet.

**Steps:**
1. Use a project that has no scenes yet (or delete existing scenes for testing)
2. Make GET request:

```bash
# Using curl (PowerShell)
$projectId = "your-project-id-here"
$token = "your-access-token-here"

curl -X GET "http://localhost:3001/api/projects/$projectId/scenes" `
  -H "Authorization: Bearer $token" `
  -H "Content-Type: application/json"
```

**Expected Result:**
```json
{
  "scenes": []
}
```

**Verify:**
- ✅ Status code: 200
- ✅ Empty scenes array returned
- ✅ No errors in backend console

---

### Test 2: PUT /api/projects/:id/scenes (Task 6.5) - Initial Insert

**Purpose**: Test creating scenes for the first time (no ID preservation needed).

**Steps:**
1. Prepare test scenes data:

```json
{
  "scenes": [
    {
      "sceneNumber": 1,
      "slug": "int-kitchen-day-1",
      "scriptExcerpt": "INT. KITCHEN - DAY\n\nJohn enters the kitchen and makes coffee.\n\nHe looks out the window."
    },
    {
      "sceneNumber": 2,
      "slug": "ext-city-street-night-2",
      "scriptExcerpt": "EXT. CITY STREET - NIGHT\n\nThe street is dark and empty.\n\nA car passes by."
    },
    {
      "sceneNumber": 3,
      "slug": "int-bedroom-morning-3",
      "scriptExcerpt": "INT. BEDROOM - MORNING\n\nSarah wakes up.\n\nShe stretches and yawns."
    }
  ]
}
```

2. Make PUT request:

```bash
# Using curl (PowerShell)
$projectId = "your-project-id-here"
$token = "your-access-token-here"

$body = @{
  scenes = @(
    @{
      sceneNumber = 1
      slug = "int-kitchen-day-1"
      scriptExcerpt = "INT. KITCHEN - DAY`n`nJohn enters the kitchen and makes coffee.`n`nHe looks out the window."
    },
    @{
      sceneNumber = 2
      slug = "ext-city-street-night-2"
      scriptExcerpt = "EXT. CITY STREET - NIGHT`n`nThe street is dark and empty.`n`nA car passes by."
    },
    @{
      sceneNumber = 3
      slug = "int-bedroom-morning-3"
      scriptExcerpt = "INT. BEDROOM - MORNING`n`nSarah wakes up.`n`nShe stretches and yawns."
    }
  )
} | ConvertTo-Json -Depth 10

Invoke-RestMethod -Uri "http://localhost:3001/api/projects/$projectId/scenes" `
  -Method PUT `
  -Headers @{
    "Authorization" = "Bearer $token"
    "Content-Type" = "application/json"
  } `
  -Body $body
```

**Expected Result:**
```json
{
  "success": true,
  "sceneCount": 3,
  "scenes": [
    {
      "id": "uuid-1",
      "scene_number": 1,
      "slug": "int-kitchen-day-1"
    },
    {
      "id": "uuid-2",
      "scene_number": 2,
      "slug": "ext-city-street-night-2"
    },
    {
      "id": "uuid-3",
      "scene_number": 3,
      "slug": "int-bedroom-morning-3"
    }
  ],
  "idMapping": [
    {
      "newId": "uuid-1",
      "slug": "int-kitchen-day-1",
      "sceneNumber": 1
    },
    {
      "newId": "uuid-2",
      "slug": "ext-city-street-night-2",
      "sceneNumber": 2
    },
    {
      "newId": "uuid-3",
      "slug": "int-bedroom-morning-3",
      "sceneNumber": 3
    }
  ],
  "deletedScenesCount": 0
}
```

**Verify:**
- ✅ Status code: 200
- ✅ All 3 scenes created with new UUIDs
- ✅ `idMapping` shows all new IDs
- ✅ `deletedScenesCount` is 0
- ✅ Backend console shows: "Successfully persisted 3 scenes (0 updated, 3 created)"

**Save the scene IDs** for the next test!

---

### Test 3: GET /api/projects/:id/scenes (Task 5) - With Data

**Purpose**: Test fetching scenes after they've been created.

**Steps:**
1. Use the same project ID from Test 2
2. Make GET request (same as Test 1)

**Expected Result:**
```json
{
  "scenes": [
    {
      "id": "uuid-1",
      "sceneNumber": 1,
      "slug": "int-kitchen-day-1",
      "status": "draft",
      "scriptExcerpt": "INT. KITCHEN - DAY\n\nJohn enters the kitchen and makes coffee.\n\nHe looks out the window.",
      "header": "INT. KITCHEN - DAY",
      "openingAction": "John enters the kitchen and makes coffee.\n\nHe looks out the window.",
      "expectedCharacters": [],
      "expectedLocation": "",
      "shots": [],
      "priorSceneEndState": null,
      "endFrameThumbnail": null,
      "continuityRisk": null
    },
    {
      "id": "uuid-2",
      "sceneNumber": 2,
      "slug": "ext-city-street-night-2",
      "status": "draft",
      "scriptExcerpt": "EXT. CITY STREET - NIGHT\n\nThe street is dark and empty.\n\nA car passes by.",
      "header": "EXT. CITY STREET - NIGHT",
      "openingAction": "The street is dark and empty.\n\nA car passes by.",
      "expectedCharacters": [],
      "expectedLocation": "",
      "shots": [],
      "priorSceneEndState": null,
      "endFrameThumbnail": null,
      "continuityRisk": null
    },
    {
      "id": "uuid-3",
      "sceneNumber": 3,
      "slug": "int-bedroom-morning-3",
      "status": "draft",
      "scriptExcerpt": "INT. BEDROOM - MORNING\n\nSarah wakes up.\n\nShe stretches and yawns.",
      "header": "INT. BEDROOM - MORNING",
      "openingAction": "Sarah wakes up.\n\nShe stretches and yawns.",
      "expectedCharacters": [],
      "expectedLocation": "",
      "shots": [],
      "priorSceneEndState": null,
      "endFrameThumbnail": null,
      "continuityRisk": null
    }
  ]
}
```

**Verify:**
- ✅ Status code: 200
- ✅ All 3 scenes returned
- ✅ Scenes ordered by `sceneNumber` (1, 2, 3)
- ✅ `header` extracted correctly (first line of script_excerpt)
- ✅ `openingAction` extracted correctly (remaining lines)
- ✅ All required fields present

---

### Test 4: PUT /api/projects/:id/scenes (Task 6.5) - ID Preservation

**Purpose**: Test Scene ID Stability - preserving IDs when slugs match.

**Steps:**
1. Use the same project ID and scene IDs from Test 2
2. Re-extract with **same slugs** but **updated script_excerpt**:

```json
{
  "scenes": [
    {
      "sceneNumber": 1,
      "slug": "int-kitchen-day-1",
      "scriptExcerpt": "INT. KITCHEN - DAY\n\nJohn enters the kitchen and makes coffee.\n\nHe looks out the window.\n\n[UPDATED] He notices something strange."
    },
    {
      "sceneNumber": 2,
      "slug": "ext-city-street-night-2",
      "scriptExcerpt": "EXT. CITY STREET - NIGHT\n\nThe street is dark and empty.\n\nA car passes by.\n\n[UPDATED] The car stops."
    },
    {
      "sceneNumber": 3,
      "slug": "int-bedroom-morning-3",
      "scriptExcerpt": "INT. BEDROOM - MORNING\n\nSarah wakes up.\n\nShe stretches and yawns.\n\n[UPDATED] She checks her phone."
    }
  ]
}
```

3. Make PUT request (same as Test 2)

**Expected Result:**
```json
{
  "success": true,
  "sceneCount": 3,
  "scenes": [
    {
      "id": "uuid-1",  // SAME ID as before!
      "scene_number": 1,
      "slug": "int-kitchen-day-1"
    },
    {
      "id": "uuid-2",  // SAME ID as before!
      "scene_number": 2,
      "slug": "ext-city-street-night-2"
    },
    {
      "id": "uuid-3",  // SAME ID as before!
      "scene_number": 3,
      "slug": "int-bedroom-morning-3"
    }
  ],
  "idMapping": [
    {
      "oldId": "uuid-1",
      "newId": "uuid-1",  // Preserved!
      "slug": "int-kitchen-day-1",
      "sceneNumber": 1
    },
    {
      "oldId": "uuid-2",
      "newId": "uuid-2",  // Preserved!
      "slug": "ext-city-street-night-2",
      "sceneNumber": 2
    },
    {
      "oldId": "uuid-3",
      "newId": "uuid-3",  // Preserved!
      "slug": "int-bedroom-morning-3",
      "sceneNumber": 3
    }
  ],
  "deletedScenesCount": 0
}
```

**Verify:**
- ✅ Status code: 200
- ✅ **All scene IDs are the SAME as before** (preserved!)
- ✅ Backend console shows: "Preserving ID for scene 1 (int-kitchen-day-1): uuid-1"
- ✅ Backend console shows: "Successfully persisted 3 scenes (3 updated, 0 created)"
- ✅ `idMapping` shows `oldId` and `newId` are the same
- ✅ Fetch scenes again (Test 3) - verify `scriptExcerpt` was updated

---

### Test 5: PUT /api/projects/:id/scenes (Task 6.5) - Mixed: Preserve + Create

**Purpose**: Test ID preservation when some scenes match and some are new.

**Steps:**
1. Use the same project ID from previous tests
2. Re-extract with **2 matching scenes** and **1 new scene**:

```json
{
  "scenes": [
    {
      "sceneNumber": 1,
      "slug": "int-kitchen-day-1",
      "scriptExcerpt": "INT. KITCHEN - DAY\n\nJohn enters the kitchen.\n\n[FURTHER UPDATED]"
    },
    {
      "sceneNumber": 2,
      "slug": "ext-city-street-night-2",
      "scriptExcerpt": "EXT. CITY STREET - NIGHT\n\nThe street is dark.\n\n[FURTHER UPDATED]"
    },
    {
      "sceneNumber": 4,  // NEW scene (skipped 3)
      "slug": "int-office-afternoon-4",
      "scriptExcerpt": "INT. OFFICE - AFTERNOON\n\nJohn sits at his desk.\n\nHe types on his computer."
    }
  ]
}
```

3. Make PUT request

**Expected Result:**
```json
{
  "success": true,
  "sceneCount": 3,
  "scenes": [
    {
      "id": "uuid-1",  // PRESERVED
      "scene_number": 1,
      "slug": "int-kitchen-day-1"
    },
    {
      "id": "uuid-2",  // PRESERVED
      "scene_number": 2,
      "slug": "ext-city-street-night-2"
    },
    {
      "id": "uuid-4",  // NEW ID
      "scene_number": 4,
      "slug": "int-office-afternoon-4"
    }
  ],
  "idMapping": [
    {
      "oldId": "uuid-1",
      "newId": "uuid-1",
      "slug": "int-kitchen-day-1",
      "sceneNumber": 1
    },
    {
      "oldId": "uuid-2",
      "newId": "uuid-2",
      "slug": "ext-city-street-night-2",
      "sceneNumber": 2
    },
    {
      "newId": "uuid-4",
      "slug": "int-office-afternoon-4",
      "sceneNumber": 4
    }
  ],
  "deletedScenesCount": 1  // Scene 3 was deleted!
}
```

**Verify:**
- ✅ Status code: 200
- ✅ Scene 1 and 2 IDs preserved
- ✅ Scene 4 has new ID
- ✅ `deletedScenesCount` is 1 (scene 3 was removed)
- ✅ Backend console shows warning: "⚠️ [SCENES] 1 scenes were removed from script: Scene 3 (int-bedroom-morning-3)"
- ✅ Backend console shows: "⚠️ [SCENES] Marked 1 deleted scenes as continuity_broken"
- ✅ Check database: Scene 3 should have `status = 'continuity_broken'`

---

### Test 6: PUT /api/projects/:id/scenes (Task 6.5) - Deleted Scenes Handling

**Purpose**: Test that deleted scenes are marked as `continuity_broken`.

**Steps:**
1. After Test 5, query the database to check scene 3:

```sql
-- In Supabase SQL Editor
SELECT id, scene_number, slug, status, script_excerpt
FROM scenes
WHERE slug = 'int-bedroom-morning-3';
```

**Expected Result:**
- Scene 3 should still exist in database
- `status` should be `'continuity_broken'`
- `script_excerpt` should be the old content

**Verify:**
- ✅ Deleted scene still exists (not physically deleted)
- ✅ Status is `'continuity_broken'`
- ✅ This prevents orphaning downstream work (shot lists, frames, videos)

---

## Phase 4: Frontend Service Testing (Task 6)

### Test 7: sceneService.fetchScenes()

**Purpose**: Test fetching scenes through the frontend service.

**Steps:**
1. Open browser console (F12) on `http://localhost:8080`
2. Import and test:

```javascript
// In browser console
import { sceneService } from '/src/lib/services/sceneService.ts';

// Replace with your project ID
const projectId = 'your-project-id-here';

try {
  const scenes = await sceneService.fetchScenes(projectId);
  console.log('✅ Fetched scenes:', scenes);
  console.log('Scene count:', scenes.length);
  
  // Verify structure
  scenes.forEach((scene, index) => {
    console.log(`Scene ${index + 1}:`, {
      id: scene.id,
      sceneNumber: scene.sceneNumber,
      slug: scene.slug,
      status: scene.status,
      header: scene.header,
      openingAction: scene.openingAction.substring(0, 50) + '...',
      hasScriptExcerpt: !!scene.scriptExcerpt
    });
  });
} catch (error) {
  console.error('❌ Error:', error);
}
```

**Expected Result:**
- ✅ No errors
- ✅ Array of Scene objects
- ✅ Each scene has all required fields
- ✅ `header` and `openingAction` are extracted correctly

---

### Test 8: sceneService.previewScenes()

**Purpose**: Test in-memory scene extraction (no persistence).

**Steps:**
1. Open browser console
2. Test with sample script:

```javascript
// In browser console
import { sceneService } from '/src/lib/services/sceneService.ts';

const testScript = `INT. KITCHEN - DAY

John enters the kitchen and makes coffee.

He looks out the window.

EXT. CITY STREET - NIGHT

The street is dark and empty.

A car passes by.

INT. BEDROOM - MORNING

Sarah wakes up.

She stretches and yawns.`;

try {
  const scenes = await sceneService.previewScenes(testScript);
  console.log('✅ Preview scenes:', scenes);
  console.log('Scene count:', scenes.length);
  
  // Verify structure
  scenes.forEach((scene, index) => {
    console.log(`Scene ${index + 1}:`, {
      id: scene.id,
      sceneNumber: scene.sceneNumber,
      slug: scene.slug,
      status: scene.status,
      header: scene.header,
      openingAction: scene.openingAction.substring(0, 50) + '...',
      scriptExcerptLength: scene.scriptExcerpt.length
    });
  });
  
  // Verify slugs
  console.log('Slugs:', scenes.map(s => s.slug));
  // Expected: ['int-kitchen-day-1', 'ext-city-street-night-2', 'int-bedroom-morning-3']
} catch (error) {
  console.error('❌ Error:', error);
}
```

**Expected Result:**
- ✅ No errors
- ✅ 3 scenes extracted
- ✅ Slugs are descriptive and include scene numbers
- ✅ `header` is first line of each scene
- ✅ `openingAction` is remaining lines
- ✅ All scenes have `status: 'draft'`
- ✅ **No database writes** (check backend console - no PUT requests)

---

### Test 9: sceneService.updateSceneStatus() - Placeholder

**Purpose**: Verify the placeholder method exists (endpoint not implemented yet).

**Steps:**
1. Open browser console
2. Test (will fail, but should show proper error):

```javascript
// In browser console
import { sceneService } from '/src/lib/services/sceneService.ts';

try {
  await sceneService.updateSceneStatus('test-scene-id', 'shot_list_ready');
} catch (error) {
  console.log('Expected error (endpoint not implemented):', error.message);
  // Should show: "Failed to update scene status" or 404
}
```

**Expected Result:**
- ✅ Method exists
- ✅ Returns proper error (404 or "Failed to update scene status")
- ✅ This is expected - endpoint will be implemented in future task

---

## Integration Testing: Full Flow

### Test 10: Complete Workflow

**Purpose**: Test the full flow from extraction → persistence → fetching.

**Steps:**
1. **Extract scenes** using `scriptService.extractScenes()`:

```javascript
// In browser console
import { scriptService } from '/src/lib/services/scriptService.ts';

const script = `INT. KITCHEN - DAY

John enters the kitchen.

EXT. STREET - NIGHT

The street is dark.

INT. BEDROOM - MORNING

Sarah wakes up.`;

const extractedScenes = scriptService.extractScenes(script);
console.log('Extracted:', extractedScenes);
```

2. **Persist scenes** using `scriptService.persistScenes()`:

```javascript
const projectId = 'your-project-id-here';

// Transform to persistence format
const scenesToPersist = extractedScenes.map(scene => ({
  sceneNumber: scene.sceneNumber,
  slug: scene.slug,
  scriptExcerpt: scene.content
}));

await scriptService.persistScenes(projectId, extractedScenes);
console.log('✅ Scenes persisted');
```

3. **Fetch scenes** using `sceneService.fetchScenes()`:

```javascript
const fetchedScenes = await sceneService.fetchScenes(projectId);
console.log('✅ Fetched scenes:', fetchedScenes);

// Verify they match
console.log('Match check:', {
  extracted: extractedScenes.length,
  fetched: fetchedScenes.length,
  slugsMatch: extractedScenes.every((extracted, i) => 
    extracted.slug === fetchedScenes[i]?.slug
  )
});
```

**Expected Result:**
- ✅ Scenes extracted correctly
- ✅ Scenes persisted successfully
- ✅ Scenes fetched successfully
- ✅ All slugs match
- ✅ Scene numbers match
- ✅ Script excerpts match

---

## Browser-Based Testing (Alternative)

If you prefer testing through the UI:

### Test 11: Using Browser DevTools Network Tab

1. **Open DevTools** (F12) → Network tab
2. **Navigate to Stage 4** (Master Script) in your app
3. **Generate or paste a script** with scene headings
4. **Watch for API calls:**
   - `PUT /api/projects/:id/scenes` - When scenes are persisted
   - `GET /api/projects/:id/scenes` - When scenes are fetched (Stage 6)

5. **Inspect responses:**
   - Click on the request → Response tab
   - Verify the response structure matches expected format

---

## Troubleshooting

### Issue: "Project not found" (404)
- ✅ Verify project ID is correct
- ✅ Verify you're authenticated (check token)
- ✅ Verify project belongs to your user

### Issue: "Project has no active branch" (400)
- ✅ Check database: `SELECT active_branch_id FROM projects WHERE id = 'your-project-id'`
- ✅ Create a branch if missing: `INSERT INTO branches (project_id, name, is_main) VALUES (...)`

### Issue: Scene IDs not preserved
- ✅ Check backend console logs for "Preserving ID" messages
- ✅ Verify slugs match exactly (case-sensitive)
- ✅ Verify scene numbers match
- ✅ Check `idMapping` in response

### Issue: Deleted scenes not marked as continuity_broken
- ✅ Check backend console for warnings
- ✅ Verify database: `SELECT status FROM scenes WHERE slug = 'deleted-scene-slug'`
- ✅ Should be `'continuity_broken'`

---

## Success Criteria Checklist

### Task 5 (GET Endpoint)
- ✅ Returns empty array when no scenes exist
- ✅ Returns all scenes for active branch
- ✅ Scenes ordered by scene_number
- ✅ Transforms database format to frontend format
- ✅ Extracts header and openingAction correctly

### Task 6.5 (Scene ID Stability)
- ✅ Creates new scenes on first insert
- ✅ Preserves scene IDs when slugs match
- ✅ Updates script_excerpt for matched scenes
- ✅ Creates new scenes for unmatched slugs
- ✅ Marks deleted scenes as continuity_broken
- ✅ Returns idMapping for debugging

### Task 6 (Frontend Service)
- ✅ fetchScenes() works correctly
- ✅ previewScenes() extracts scenes in-memory
- ✅ previewScenes() doesn't persist to database
- ✅ All methods handle errors gracefully
- ✅ Type transformations work correctly

---

## Next Steps

After verifying all tests pass:
1. **Task 7**: Implement Stage 4/5 Transition Logic (Gate Approach)
2. **Task 8**: Replace mock data in Stage 6 with real fetching
3. **Task 9**: Add comprehensive test suite

---

## Quick Reference: API Endpoints

### GET /api/projects/:id/scenes
- **Method**: GET
- **Auth**: Required (Bearer token)
- **Response**: `{ scenes: Scene[] }`

### PUT /api/projects/:id/scenes
- **Method**: PUT
- **Auth**: Required (Bearer token)
- **Body**: `{ scenes: Array<{ sceneNumber, slug, scriptExcerpt }> }`
- **Response**: `{ success, sceneCount, scenes, idMapping, deletedScenesCount }`

