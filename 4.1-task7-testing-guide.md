# Task 7 Testing Guide: Stage 4/5 Transition Logic

## Prerequisites
- Project with Stage 4 Master Script component accessible
- Script with scene headings (INT./EXT.) in the editor

## Test 1: Preview Scenes (Phase A - Draft)

**Steps:**
1. Navigate to Stage 4 Master Script
2. Ensure script has scene headings (e.g., `INT. KITCHEN - DAY`)
3. Click **"Preview Scenes"** button in header
4. Verify:
   - Loading state shows "Previewing..."
   - Dialog opens showing scene count
   - Each scene displays: number, header, slug, preview text
   - No scenes saved to database (check Network tab - no PUT to `/api/projects/:id/scenes`)

**Expected:** Preview works without committing to database

---

## Test 2: Approve Script - Normal Flow (Phase B - Commit)

**Steps:**
1. In Stage 4, ensure script has valid scenes
2. Click **"Approve Script"** button
3. Verify:
   - Scenes extracted and validated
   - PUT request to `/api/projects/:id/scenes` (check Network tab)
   - POST request to `/api/projects/:id/stages/4/lock`
   - Success toast: "Master Script approved! X scenes extracted..."
   - Navigation to Stage 5

**Expected:** Clean approval flow, scenes persisted, stage locked

---

## Test 3: Validation - Empty Script

**Steps:**
1. Clear script editor (or start with empty script)
2. Click **"Approve Script"**
3. Verify: Error toast "Cannot approve an empty script"

**Expected:** Validation prevents empty script approval

---

## Test 4: Validation - No Scenes

**Steps:**
1. Enter script text WITHOUT scene headings (just dialogue/action)
2. Click **"Approve Script"**
3. Verify: Error toast "No scenes found in script. Please add scene headings..."

**Expected:** Validation prevents approval without scenes

---

## Test 5: Downstream Warning (If Applicable)

**Prerequisites:** Stage 4 already locked + scenes with Phase B status

**Steps:**
1. Lock Stage 4 (approve script once)
2. Manually set a scene status to `shot_list_ready` in database (or use Stage 6+ to create Phase B data)
3. Edit Stage 4 script (unlock if needed - may require manual DB edit)
4. Click **"Approve Script"** again
5. Verify:
   - Warning modal appears
   - Explains downstream impact
   - "Proceed Anyway" button works
   - Scenes still persist correctly

**Expected:** Warning shown, user can proceed with awareness

---

## Quick Test Checklist

- [ ] Preview button shows loading state
- [ ] Preview dialog displays scenes correctly
- [ ] Preview doesn't save to database
- [ ] Approve validates empty script
- [ ] Approve validates no scenes
- [ ] Approve validates empty scene content
- [ ] Approve persists scenes and locks stage
- [ ] Success toast shows correct scene count
- [ ] Navigation to Stage 5 works
- [ ] Downstream warning appears when applicable

---

## Manual Database Checks (Optional)

```sql
-- Check scenes were created
SELECT scene_number, slug, status FROM scenes WHERE branch_id = '<branch_id>' ORDER BY scene_number;

-- Check Stage 4 is locked
SELECT status FROM stage_states WHERE stage_number = 4 AND branch_id = '<branch_id>' ORDER BY version DESC LIMIT 1;
```

---

## Notes

- Preview scenes are saved to `stage_states.content.scenes` JSONB (optional persistence)
- Scene ID Stability (Task 6.5) handles ID preservation automatically
- Branching logic deferred to Phase 10 (no forced branch creation)

Please methodically implement Task 8 of  @4.1-plan-v1.md  ((( 

### Task 8: Replace Mock Data in Stage 6

**File**: `src/components/pipeline/Stage6ScriptHub.tsx`

**Current**: Uses `mockScenes` array (lines 22-86)

**Changes**:

- Remove `mockScenes` constant
- Add `useEffect` to fetch scenes on mount using `sceneService.fetchScenes()`
- Add loading state while fetching
- Add error handling
- Transform fetched scenes to match UI expectations:
                - Extract `header` from `script_excerpt` (first line)
                - Extract `openingAction` from `script_excerpt` (lines after header)
                - Map database status to TypeScript status
                - Set default values for `expectedCharacters`, `expectedLocation` (will be enhanced in future)


)))  ...  Note, here is what we have implemented so far of the 4.1-plan-v1 doc (tasks 1-7): @4.1-IMPLEMENTATION-SUMMARY.md 
